{% extends 'admin/page/base.html' %}
{% block title %}
    Detalles de {{ categoria.nombre }} - Panel de Administraci√≥n
{% endblock %}
{% block content %}
    <style>
        /* Estilos existentes */
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .category-card {
            transition: all 0.3s ease;
        }
        .category-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .product-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15);
        }
        .product-card:hover .product-overlay {
            opacity: 1;
        }
        .product-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            stroke-dasharray: 150.8 150.8; /* Circunferencia para r=24 (2 * PI * 24) */
        }
        .trend-up {
            color: #10b981;
        }
        .trend-down {
            color: #ef4444;
        }
        .market-indicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pagination-btn {
            transition: all 0.2s ease;
        }
        .pagination-btn:hover {
            background-color: #f3f4f6;
        }
        .pagination-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .no-data-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 2px dashed #d1d5db;
        }
        .no-data-icon {
            font-size: 3rem;
            color: #9ca3af;
            margin-bottom: 1rem;
        }
        .no-data-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .no-data-message {
            color: #6b7280;
            max-width: 500px;
        }
        .empty-state-card {
            background: linear-gradient(to right, #f3f4f6, #e5e7eb);
            border: 1px dashed #9ca3af;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            color: #4b5563;
        }
        .empty-state-icon {
            font-size: 2.5rem;
            color: #9ca3af;
            margin-bottom: 1rem;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 0.5rem;
        }
        .refresh-animation {
            animation: spin 1s linear infinite;
        }
        /* Estilos para etiquetas de estado */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-badge i {
            margin-right: 0.25rem;
            font-size: 0.625rem;
        }
        /* Estilos para tarjetas de productos inactivos */
        .product-card.inactive {
            opacity: 0.7;
            border: 1px dashed #d1d5db;
        }
        .product-card.inactive .product-overlay {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* Nuevos estilos para filtros avanzados */
        .filter-section {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-item label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        
        .filter-item select,
        .filter-item input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .filter-item select:focus,
        .filter-item input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .price-range {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .price-range input {
            flex: 1;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-filter {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .view-toggle {
            display: flex;
            margin-left: auto;
        }
        
        .view-toggle button {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        
        .view-toggle button:first-child {
            border-radius: 0.375rem 0 0 0.375rem;
        }
        
        .view-toggle button:last-child {
            border-radius: 0 0.375rem 0.375rem 0;
        }
        
        .view-toggle button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .products-table-container {
            overflow-x: auto;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-table th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .products-table td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .products-table tr:hover {
            background-color: #f9fafb;
        }
        
        .product-img {
            width: 3rem;
            height: 3rem;
            border-radius: 0.375rem;
            object-fit: cover;
        }
        
        .product-info {
            display: flex;
            align-items: center;
        }
        
        .product-info img {
            margin-right: 0.75rem;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .trend-up {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .trend-down {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .product-grid-card {
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }
        
        .product-grid-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .product-grid-img {
            width: 100%;
            height: 12rem;
            object-fit: cover;
        }
        
        .product-grid-content {
            padding: 1rem;
        }
        
        .product-grid-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }
        
        .product-grid-title {
            font-weight: 600;
            color: #1f2937;
        }
        
        .product-grid-brand {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .product-grid-price {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .product-grid-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .product-grid-stat {
            text-align: center;
        }
        
        .product-grid-stat-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .product-grid-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .product-grid-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* NUEVOS ESTILOS PARA MEJORAR LA SECCI√ìN DE PRODUCTOS RELACIONADOS */
        .related-products-section {
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 2rem;
            overflow: hidden; /* A√±adido para evitar desbordamiento */
        }
        
        .related-products-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }
        
        .related-products-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .related-products-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .related-products-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .related-products-view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .related-products-filters {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .related-products-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .related-products-filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .related-products-filter-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        
        .related-products-filter-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .related-products-filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .related-products-filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .related-products-container {
            position: relative;
            margin-top: 1.5rem;
            overflow-x: hidden; /* Evitar desbordamiento horizontal */
        }
        
        .related-products-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .related-products-table th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .related-products-table td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        .related-products-table tr:hover {
            background-color: #f9fafb;
        }
        
        .related-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .related-product-card {
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .related-product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .related-product-image-container {
            position: relative;
            height: 180px;
            overflow: hidden;
        }
        
        .related-product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .related-product-card:hover .related-product-image {
            transform: scale(1.05);
        }
        
        .related-product-badges {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .related-product-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }
        
        .related-product-badge-new {
            background-color: rgba(59, 130, 246, 0.9);
            color: white;
        }
        
        .related-product-badge-inactive {
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
        }
        
        .related-product-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .related-product-header {
            margin-bottom: 0.75rem;
        }
        
        .related-product-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
            line-height: 1.25;
            margin-bottom: 0.25rem;
        }
        
        .related-product-brand {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .related-product-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .related-product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .related-product-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .related-product-stars {
            color: #fbbf24;
        }
        
        .related-product-rating-value {
            color: #4b5563;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .related-product-stats {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .related-product-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .related-product-stat-value {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        .related-product-stat-label {
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .related-product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .related-product-category {
            color: #6b7280;
            font-size: 0.75rem;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .related-product-action {
            color: #3b82f6;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            transition: color 0.15s ease-in-out;
        }
        
        .related-product-action:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }
        
        .related-products-pagination {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .related-products-pagination-info {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .related-products-pagination-controls {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            flex-wrap: wrap; /* Permitir que los botones se envuelvan en pantallas peque√±as */
        }
        
        .related-products-pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            color: #4b5563;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }
        
        .related-products-pagination-btn:hover:not(:disabled) {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        .related-products-pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .related-products-pagination-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .related-products-pagination-ellipsis {
            padding: 0.5rem 0.25rem;
            color: #6b7280;
        }
        
        /* Mejoras de responsividad */
        @media (max-width: 1024px) {
            .related-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-item {
                min-width: 100%;
            }
            
            .price-range {
                flex-direction: column;
            }
            
            .view-toggle {
                margin-left: 0;
                margin-top: 0.5rem;
            }
            
            .products-table-container {
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            
            .products-table {
                font-size: 0.75rem;
            }
            
            .products-table th,
            .products-table td {
                padding: 0.5rem;
            }
            
            .related-products-view-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .related-products-filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .related-products-filter-group {
                min-width: 100%;
            }
            
            .related-products-table {
                font-size: 0.75rem;
            }
            
            .related-products-table th,
            .related-products-table td {
                padding: 0.5rem;
            }
            
            .related-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .related-product-footer {
                flex-direction: row; /* Cambiado a fila */
                align-items: center; /* Centrado verticalmente */
            }
        }
        
        @media (max-width: 480px) {
            .related-products-grid {
                grid-template-columns: 1fr;
            }
            
            .related-product-card {
                max-width: 100%;
            }
            
            .related-products-pagination-controls {
                gap: 0.1rem;
            }
            
            .related-products-pagination-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
        }
    </style>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Category Header -->
        <div class="market-indicator rounded-xl shadow-lg p-6 mb-8 text-white">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center mb-2">
                        <h2 id="category-name" class="text-3xl font-bold mr-3">Cargando...</h2>
                        <span id="category-status" class="bg-green-500 text-white text-xs font-medium px-2.5 py-0.5 rounded-full">Activo</span>
                    </div>
                    <p id="category-description" class="text-blue-100 max-w-3xl">Cargando descripci√≥n...</p>
                </div>
                <div class="flex space-x-2">
                    <a href="{{ url_for('admin_categorias.get_all_categories') }}" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-300 transform hover:scale-105 spa-link">
                        <i class="fas fa-arrow-left mr-2"></i> Volver a la lista
                    </a>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Ventas Totales (Hist√≥ricas)</p>
                        <p id="total-sales" class="text-2xl font-bold text-gray-800">$0</p>
                        <p id="sales-trend" class="text-green-600 text-sm flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i> 0%
                        </p>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-shopping-cart text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Unidades Vendidas</p>
                        <p id="units-sold" class="text-2xl font-bold text-gray-800">0</p>
                        <p id="units-trend" class="text-green-600 text-sm flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i> 0%
                        </p>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-box text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Productos</p>
                        <p id="total-products" class="text-2xl font-bold text-gray-800">0</p>
                        <p class="text-gray-600 text-sm flex items-center mt-1">
                            <i class="fas fa-minus mr-1"></i> Total
                        </p>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-amber-100 text-amber-600 mr-4">
                        <i class="fas fa-percentage text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Margen Promedio</p>
                        <p id="avg-margin" class="text-2xl font-bold text-gray-800">0%</p>
                        <p id="margin-trend" class="text-green-600 text-sm flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i> 0%
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Market Analysis -->
        <div class="bg-white rounded-xl shadow-md mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button class="tab-btn py-4 px-6 text-center border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="market-trends">
                        Tendencias del Mercado
                    </button>
                    <button class="tab-btn py-4 px-6 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="subcategory-performance">
                        Rendimiento de Subcategor√≠as
                    </button>
                    <button class="tab-btn py-4 px-6 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="top-products">
                        Productos M√°s Vendidos
                    </button>
                </nav>
            </div>

            <!-- Market Trends Tab -->
            <div id="market-trends" class="tab-content active p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 mb-4">Evoluci√≥n de Ventas</h3>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                            <div id="salesChartLoading" class="loading-overlay" style="display: none;">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 mb-4">Comparaci√≥n de Ventas con Otras Categor√≠as</h3>
                        <div class="chart-container">
                            <canvas id="categoryComparisonChart"></canvas>
                            <div id="categoryComparisonChartLoading" class="loading-overlay" style="display: none;">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Indicadores Clave de Rendimiento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-5 border border-blue-100">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-700">Participaci√≥n de Mercado</h4>
                                <div class="relative w-16 h-16">
                                    <svg class="progress-ring w-16 h-16">
                                        <circle class="text-gray-200" stroke="currentColor" stroke-width="4" fill="transparent" r="24" cx="32" cy="32"></circle>
                                        <circle id="market-share-circle" class="progress-ring-circle text-blue-600" stroke="currentColor" stroke-width="4" fill="transparent" r="24" cx="32" cy="32" style="stroke-dashoffset: 75.36;"></circle>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="market-share" class="text-sm font-bold text-gray-700">0%</span>
                                    </div>
                                </div>
                            </div>
                            <p id="market-share-desc" class="text-gray-600 text-sm">Cargando informaci√≥n...</p>
                        </div>

                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-5 border border-green-100">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-700">Tasa de Crecimiento</h4>
                                <div class="relative w-16 h-16">
                                    <svg class="progress-ring w-16 h-16">
                                        <circle class="text-gray-200" stroke="currentColor" stroke-width="4" fill="transparent" r="24" cx="32" cy="32"></circle>
                                        <circle id="growth-rate-circle" class="progress-ring-circle text-green-600" stroke="currentColor" stroke-width="4" fill="transparent" r="24" cx="32" cy="32" style="stroke-dashoffset: 125.6;"></circle>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="growth-rate" class="text-sm font-bold text-gray-700">0%</span>
                                    </div>
                                </div>
                            </div>
                            <p id="growth-rate-desc" class="text-gray-600 text-sm">Cargando informaci√≥n...</p>
                        </div>

                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-lg p-5 border border-purple-100">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-700">Satisfacci√≥n del Cliente</h4>
                                <div class="relative w-16 h-16">
                                    <svg class="progress-ring w-16 h-16">
                                        <circle class="text-gray-200" stroke="currentColor" stroke-width="4" fill="transparent" r="24" cx="32" cy="32"></circle>
                                        <circle id="satisfaction-circle" class="progress-ring-circle text-purple-600" stroke="currentColor" stroke-width="4" fill="transparent" r="24" cx="32" cy="32" style="stroke-dashoffset: 37.68;"></circle>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="satisfaction" class="text-sm font-bold text-gray-700">0%</span>
                                    </div>
                                </div>
                            </div>
                            <p id="satisfaction-desc" class="text-gray-600 text-sm">Cargando informaci√≥n...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subcategory Performance Tab -->
            <div id="subcategory-performance" class="tab-content p-6">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Rendimiento de Subcategor√≠as</h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2">
                        <div class="chart-container">
                            <canvas id="subcategoryChart"></canvas>
                            <div id="subcategoryChartLoading" class="loading-overlay" style="display: none;">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700 mb-3">Top Subcategor√≠as por Ventas</h4>
                        <div id="top-subcategories" class="space-y-3">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="subcategory-cards">
                    <!-- Se llenar√° din√°micamente -->
                </div>

                <!-- Subcategor√≠as con Menos Ventas -->
                <div class="mt-10">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Subcategor√≠as con Menor Rendimiento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="low-performing-subcategories">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Top Products Tab -->
            <div id="top-products" class="tab-content p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4 md:mb-0">Productos M√°s Vendidos</h3>
                    <div class="view-toggle">
                        <button id="view-table" class="active" title="Vista de tabla">
                            <i class="fas fa-table"></i>
                        </button>
                        <button id="view-grid" title="Vista de cuadr√≠cula">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtros avanzados -->
                <div class="filter-section">
                    <div class="filter-group">
                        <div class="filter-item">
                            <label for="period-filter">Per√≠odo</label>
                            <select id="period-filter">
                                <option value="30">√öltimos 30 d√≠as</option>
                                <option value="90">√öltimos 90 d√≠as</option>
                                <option value="365">√öltimo a√±o</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label for="sort-filter">Ordenar por</label>
                            <select id="sort-filter">
                                <option value="ventas">Unidades vendidas</option>
                                <option value="ingresos">Ingresos</option>
                                <option value="nombre">Nombre (A-Z)</option>
                                <option value="nombre-desc">Nombre (Z-A)</option>
                                <option value="precio-asc">Precio (menor a mayor)</option>
                                <option value="precio-desc">Precio (mayor a menor)</option>
                                <option value="tendencia">Tendencia</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label>Rango de precios</label>
                            <div class="price-range">
                                <input type="number" id="min-price" placeholder="M√≠nimo" min="0">
                                <span>-</span>
                                <input type="number" id="max-price" placeholder="M√°ximo" min="0">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label for="category-filter">Categor√≠a</label>
                            <select id="category-filter">
                                <option value="">Todas las categor√≠as</option>
                                <!-- Se llenar√° din√°micamente -->
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label for="status-filter">Estado</label>
                            <select id="status-filter">
                                <option value="">Todos</option>
                                <option value="activo">Activos</option>
                                <option value="inactivo">Inactivos</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label for="product-search">Buscar producto</label>
                            <div class="relative">
                                <input type="text" id="product-search" placeholder="Buscar por nombre o marca...">
                                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button id="reset-filters" class="btn-filter btn-secondary">
                            <i class="fas fa-redo mr-2"></i> Restablecer
                        </button>
                    </div>
                </div>

                <!-- Contenedor para vistas con overlay de carga -->
                <div class="relative mt-6">
                    <!-- Overlay de Carga -->
                    <div id="top-products-loader" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                    </div>

                    <!-- Vista de tabla -->
                    <div id="table-view" class="products-table-container">
                        <table class="products-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categor√≠a</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidades Vendidas</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingresos</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tendencia</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-2 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-table">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Vista de cuadr√≠cula -->
                    <div id="grid-view" class="products-grid" style="display: none;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Paginaci√≥n para productos m√°s vendidos -->
                <div id="top-products-pagination" class="mt-6 flex justify-center">
                    <!-- Los controles de paginaci√≥n se insertar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- SECCI√ìN MEJORADA DE PRODUCTOS RELACIONADOS -->
        <div class="related-products-section">
            <div class="related-products-header">
                <h2 class="related-products-title">Productos Relacionados</h2>
                <p class="related-products-subtitle">Explora nuestra selecci√≥n de productos de la categor√≠a <span id="related-category-name">Cargando...</span></p>
            </div>
            
            <div class="related-products-controls">
                <div class="related-products-view-controls">
                    <div class="view-toggle">
                        <button id="related-view-table" class="active" title="Vista de tabla">
                            <i class="fas fa-table"></i>
                        </button>
                        <button id="related-view-grid" title="Vista de cuadr√≠cula">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span class="text-gray-600 text-sm mr-2">Mostrar:</span>
                            <select id="related-products-per-page" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="10">10 productos</option>
                                <option value="20">20 productos</option>
                                <option value="30">30 productos</option>
                                <option value="40">40 productos</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="related-products-filters">
                    <div class="related-products-filter-row">
                        <div class="related-products-filter-group">
                            <label for="related-sort-by" class="related-products-filter-label">Ordenar por</label>
                            <select id="related-sort-by" class="related-products-filter-input">
                                <option value="nombre">Nombre</option>
                                <option value="precio">Precio</option>
                                <option value="fecha">Fecha</option>
                                <option value="ventas">Ventas</option>
                            </select>
                        </div>
                        
                        <div class="related-products-filter-group">
                            <label for="related-order" class="related-products-filter-label">Direcci√≥n</label>
                            <select id="related-order" class="related-products-filter-input">
                                <option value="asc">Ascendente</option>
                                <option value="desc">Descendente</option>
                            </select>
                        </div>
                        
                        <div class="related-products-filter-group">
                            <label for="related-status" class="related-products-filter-label">Estado</label>
                            <select id="related-status" class="related-products-filter-input">
                                <option value="">Todos</option>
                                <option value="activo">Activos</option>
                                <option value="inactivo">Inactivos</option>
                            </select>
                        </div>
                        
                        <!-- NUEVOS FILTROS DE CATEGOR√çA -->
                        <div class="related-products-filter-group">
                            <label for="related-subcategory-filter" class="related-products-filter-label">Subcategor√≠a</label>
                            <select id="related-subcategory-filter" class="related-products-filter-input">
                                <option value="">Todas</option>
                                <!-- Opciones cargadas por JS -->
                            </select>
                        </div>
                        
                        <div class="related-products-filter-group">
                            <label for="related-pseudocategory-filter" class="related-products-filter-label">Seudocategor√≠a</label>
                            <select id="related-pseudocategory-filter" class="related-products-filter-input" disabled>
                                <option value="">Todas</option>
                                <!-- Opciones cargadas por JS -->
                            </select>
                        </div>
                        
                        <div class="related-products-filter-group">
                            <label for="related-product-search" class="related-products-filter-label">Buscar</label>
                            <div class="relative">
                                <input type="text" id="related-product-search" class="related-products-filter-input pl-10" placeholder="Buscar productos...">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div class="related-products-filter-group">
                            <button id="reset-related-filters" class="btn-filter btn-secondary w-full">
                                <i class="fas fa-redo mr-2"></i> Restablecer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="related-products-container">
                <!-- Overlay de Carga -->
                <div id="related-products-loader" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                </div>
                
                <!-- Vista de tabla -->
                <div id="related-table-view" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Producto</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Categor√≠as</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Precio</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Existencia</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Calificaci√≥n</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Estado</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="related-products-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Vista de cuadr√≠cula -->
                <div id="related-grid-view" class="related-products-grid" style="display: none;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
            
            <!-- Paginaci√≥n -->
            <div class="related-products-pagination">
                <div id="related-products-pagination-info" class="related-products-pagination-info">
                    Mostrando <span class="font-medium">0</span> de <span class="font-medium">0</span> productos
                </div>
                <div id="related-products-pagination-controls" class="related-products-pagination-controls">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
       // Variables globales
let categoriaId = "{{ categoria.id }}";
let salesChart, categoryComparisonChart, subcategoryChart;
let currentPage = 1;
let productsPerPage = 10;
let isLoading = false;
let allTopProducts = []; // Almacenar√° todos los productos m√°s vendidos
let filteredTopProducts = []; // Productos filtrados
let topProductsFilterTimeout = null; // Para el debounce de los filtros
let topProductsCurrentPage = 1; // para la paginaci√≥n
const topProductsPerPage = 10; // productos por p√°gina

// Variables para productos relacionados
let relatedProductsCurrentPage = 1;
let relatedProductsPerPage = 10;
let relatedProductsFilterTimeout = null;
let currentRelatedProducts = []; // Almacena los productos relacionados actuales

// Variables para filtros de categor√≠a de productos relacionados
let relatedSubcategories = [];
let relatedPseudocategories = [];

// Funci√≥n para mostrar indicador de carga
function showLoading(element) {
    element.innerHTML = '<div class="loading-spinner"></div>';
}

// Funci√≥n para formatear moneda
function formatCurrency(value) {
    if (value === null || value === undefined) return '$0';
    return '$' + parseFloat(value).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

// Funci√≥n para formatear porcentaje
function formatPercentage(value) {
    if (value === null || value === undefined) return '0%';
    return parseFloat(value).toFixed(1) + '%';
}

// Funci√≥n para mostrar un contenedor vac√≠o con mensaje profesional
function showEmptyState(container, title, message, icon = 'fa-inbox') {
    container.innerHTML = `
        <div class="no-data-container">
            <div class="no-data-icon">
                <i class="fas ${icon}"></i>
            </div>
            <h3 class="no-data-title">${title}</h3>
            <p class="no-data-message">${message}</p>
        </div>
    `;
}

// Funci√≥n para mostrar un estado vac√≠o en tarjetas
function showEmptyCard(container, title, message, icon = 'fa-box-open') {
    container.innerHTML = `
        <div class="empty-state-card">
            <div class="empty-state-icon">
                <i class="fas ${icon}"></i>
            </div>
            <h3 class="font-medium text-gray-700">${title}</h3>
            <p class="text-gray-600 mt-2">${message}</p>
        </div>
    `;
}

// Funci√≥n para mostrar un estado vac√≠o en tablas
function showEmptyTable(tableContainer, title, message, icon = 'fa-search', colspan = 9) {
    tableContainer.innerHTML = `
        <tr>
            <td colspan="${colspan}" class="px-6 py-8 text-center">
                <div class="flex flex-col items-center justify-center">
                    <div class="text-gray-400 mb-4">
                        <i class="fas ${icon} text-5xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">${title}</h3>
                    <p class="text-gray-500">${message}</p>
                </div>
            </td>
        </tr>
    `;
}

// Funci√≥n para obtener datos de la categor√≠a
async function fetchCategoryData() {
    if (isLoading) return;
    isLoading = true;

    try {
        // Mostrar indicadores de carga en los gr√°ficos
        const salesLoader = document.getElementById('salesChartLoading');
        if (salesLoader) salesLoader.style.display = 'flex';

        const categoryComparisonLoader = document.getElementById('categoryComparisonChartLoading');
        if (categoryComparisonLoader) categoryComparisonLoader.style.display = 'flex';

        const subcategoryLoader = document.getElementById('subcategoryChartLoading');
        if (subcategoryLoader) subcategoryLoader.style.display = 'flex';

        
        const response = await fetch(`/admin/categorias-principales/${categoriaId}/detalle`);
        const data = await response.json();
        
        if (data.success) {
            updateCategoryHeader(data.category);
            updateMetrics(data.metrics);
            updateMarketTrends(data.trends);
            updateSubcategoryPerformance(data.subcategories);
            
            // Almacenar todos los productos m√°s vendidos
            allTopProducts = data.topProducts || [];
            filteredTopProducts = [...allTopProducts];
            
            // Actualizar vista de productos m√°s vendidos
            updateTopProductsView();
            populateCategoryFilter(data.subcategories);
            
            // Cargar productos relacionados
            fetchRelatedProductsAdvanced();
        } else {
            console.error('Error al cargar datos:', data.message);
            showErrorMessage('Error al cargar los datos de la categor√≠a: ' + data.message);
        }
    } catch (error) {
        console.error('Error en la solicitud:', error);
        showErrorMessage('Error de conexi√≥n al servidor. Por favor, intente nuevamente m√°s tarde.');
    } finally {
        // Ocultar indicadores de carga
        const salesLoader = document.getElementById('salesChartLoading');
        if (salesLoader) salesLoader.style.display = 'none';

        const categoryComparisonLoader = document.getElementById('categoryComparisonChartLoading');
        if (categoryComparisonLoader) categoryComparisonLoader.style.display = 'none';

        const subcategoryLoader = document.getElementById('subcategoryChartLoading');
        if (subcategoryLoader) subcategoryLoader.style.display = 'none';

        isLoading = false;
    }
}

// Funci√≥n para poblar el filtro de categor√≠as
function populateCategoryFilter(subcategories) {
    const categoryFilter = document.getElementById('category-filter');
    categoryFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
    
    if (subcategories && subcategories.length > 0) {
        subcategories.forEach(subcategory => {
            const option = document.createElement('option');
            option.value = subcategory.id;
            option.textContent = subcategory.nombre;
            categoryFilter.appendChild(option);
            
            if (subcategory.seudocategorias && subcategory.seudocategorias.length > 0) {
                subcategory.seudocategorias.forEach(pseudo => {
                    const pseudoOption = document.createElement('option');
                    pseudoOption.value = `pseudo-${pseudo.id}`;
                    pseudoOption.textContent = `  - ${pseudo.nombre}`;
                    categoryFilter.appendChild(pseudoOption);
                });
            }
        });
    }
}

// Funci√≥n para mostrar mensaje de error
function showErrorMessage(message) {
    // Crear una notificaci√≥n de error
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center';
    notification.innerHTML = `
        <div class="mr-3">
            <i class="fas fa-exclamation-circle text-xl"></i>
        </div>
        <div>
            <h4 class="font-bold">Error</h4>
            <p>${message}</p>
        </div>
        <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    document.body.appendChild(notification);
    
    // Auto-eliminar despu√©s de 5 segundos
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Funci√≥n para mostrar mensaje de √©xito
function showSuccessMessage(message) {
    // Crear una notificaci√≥n de √©xito
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center';
    notification.innerHTML = `
        <div class="mr-3">
            <i class="fas fa-check-circle text-xl"></i>
        </div>
        <div>
            <h4 class="font-bold">√âxito</h4>
            <p>${message}</p>
        </div>
        <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    document.body.appendChild(notification);
    
    // Auto-eliminar despu√©s de 3 segundos
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 3000);
}

// Funci√≥n para actualizar encabezado de categor√≠a
function updateCategoryHeader(category) {
    document.getElementById('category-name').textContent = category.nombre;
    document.getElementById('category-description').textContent = category.descripcion;
    document.getElementById('category-status').textContent = category.estado === 'activo' ? 'Activo' : 'Inactivo';
    document.getElementById('category-status').className = category.estado === 'activo' 
        ? 'bg-green-500 text-white text-xs font-medium px-2.5 py-0.5 rounded-full' 
        : 'bg-red-500 text-white text-xs font-medium px-2.5 py-0.5 rounded-full';
    document.getElementById('related-category-name').textContent = category.nombre;
}

// Funci√≥n para actualizar m√©tricas
function updateMetrics(metrics) {
    // Verificar si hay datos de productos
    const hasProducts = metrics.total_productos > 0;
    const hasSales = metrics.total_ventas > 0 || metrics.unidades_vendidas > 0;
    
    // Actualizar valores
    document.getElementById('total-sales').textContent = hasSales ? formatCurrency(metrics.total_ventas) : 'Sin ventas';
    document.getElementById('units-sold').textContent = hasSales ? metrics.unidades_vendidas.toLocaleString() : 'Sin ventas';
    document.getElementById('total-products').textContent = metrics.total_productos;
    document.getElementById('avg-margin').textContent = hasProducts && metrics.margen_promedio > 0 ? formatPercentage(metrics.margen_promedio) : 'Sin datos';
    
    // Actualizar tendencias
    const salesTrend = document.getElementById('sales-trend');
    const unitsTrend = document.getElementById('units-trend');
    const marginTrend = document.getElementById('margin-trend');
    
    if (hasSales) {
        salesTrend.innerHTML = metrics.ventas_tendencia > 0 
            ? `<i class="fas fa-arrow-up mr-1"></i> ${formatPercentage(metrics.ventas_tendencia)}` 
            : `<i class="fas fa-arrow-down mr-1"></i> ${formatPercentage(Math.abs(metrics.ventas_tendencia))}`;
        salesTrend.className = metrics.ventas_tendencia > 0 
            ? 'text-green-600 text-sm flex items-center mt-1' 
            : 'text-red-600 text-sm flex items-center mt-1';
    } else {
        salesTrend.innerHTML = '<i class="fas fa-minus mr-1"></i> Sin datos';
        salesTrend.className = 'text-gray-600 text-sm flex items-center mt-1';
    }
        
    if (hasSales) {
        unitsTrend.innerHTML = metrics.unidades_tendencia > 0 
            ? `<i class="fas fa-arrow-up mr-1"></i> ${formatPercentage(metrics.unidades_tendencia)}` 
            : `<i class="fas fa-arrow-down mr-1"></i> ${formatPercentage(Math.abs(metrics.unidades_tendencia))}`;
        unitsTrend.className = metrics.unidades_tendencia > 0 
            ? 'text-green-600 text-sm flex items-center mt-1' 
            : 'text-red-600 text-sm flex items-center mt-1';
    } else {
        unitsTrend.innerHTML = '<i class="fas fa-minus mr-1"></i> Sin datos';
        unitsTrend.className = 'text-gray-600 text-sm flex items-center mt-1';
    }
        
    if (hasProducts && metrics.margen_promedio > 0) {
        marginTrend.innerHTML = metrics.margen_tendencia > 0 
            ? `<i class="fas fa-arrow-up mr-1"></i> ${formatPercentage(metrics.margen_tendencia)}` 
            : `<i class="fas fa-arrow-down mr-1"></i> ${formatPercentage(Math.abs(metrics.margen_tendencia))}`;
        marginTrend.className = metrics.margen_tendencia > 0 
            ? 'text-green-600 text-sm flex items-center mt-1' 
            : 'text-red-600 text-sm flex items-center mt-1';
    } else {
        marginTrend.innerHTML = '<i class="fas fa-minus mr-1"></i> Sin datos';
        marginTrend.className = 'text-gray-600 text-sm flex items-center mt-1';
    }
}

// Funci√≥n para actualizar tendencias del mercado
function updateMarketTrends(trends) {
    // Verificar si hay datos de evoluci√≥n de ventas
    const hasSalesData = trends.evolucion_ventas.data.some(value => value > 0);
    const salesChartContainer = document.getElementById('salesChart').parentElement;
    
    if (!hasSalesData) {
        showEmptyChart(salesChartContainer, 'Sin datos de ventas', 'No hay informaci√≥n de ventas disponible para esta categor√≠a en los √∫ltimos meses.');
    } else {
        // Restaurar el canvas si fue reemplazado
        if (!document.getElementById('salesChart')) {
            salesChartContainer.innerHTML = '<canvas id="salesChart"></canvas><div id="salesChartLoading" class="loading-overlay" style="display: none;"><div class="loading-spinner"></div></div>';
            // Reinicializar el gr√°fico
            initializeSalesChart(trends.evolucion_ventas);
        } else if (salesChart) {
            salesChart.data.labels = trends.evolucion_ventas.labels;
            salesChart.data.datasets[0].data = trends.evolucion_ventas.data;
            salesChart.update();
        }
    }
    
    // MODIFICACI√ìN: Siempre mostrar el gr√°fico de comparaci√≥n, incluso si no hay datos
    const categoryComparisonContainer = document.getElementById('categoryComparisonChart').parentElement;
    
    // Restaurar el canvas si fue reemplazado
    if (!document.getElementById('categoryComparisonChart')) {
        categoryComparisonContainer.innerHTML = '<canvas id="categoryComparisonChart"></canvas><div id="categoryComparisonChartLoading" class="loading-overlay" style="display: none;"><div class="loading-spinner"></div></div>';
        // Reinicializar el gr√°fico
        initializeCategoryComparisonChart(trends.comparacion_categorias);
    } else if (categoryComparisonChart) {
        categoryComparisonChart.data.labels = trends.comparacion_categorias.labels;
        categoryComparisonChart.data.datasets[0].data = trends.comparacion_categorias.current_data;
        categoryComparisonChart.data.datasets[1].data = trends.comparacion_categorias.previous_data;
        categoryComparisonChart.update();
    }
    
    // Actualizar indicadores clave
    document.getElementById('market-share').textContent = formatPercentage(trends.indicadores.participacion_mercado);
    document.getElementById('market-share-desc').textContent = trends.indicadores.participacion_mercado_desc;
    
    document.getElementById('growth-rate').textContent = formatPercentage(trends.indicadores.tasa_crecimiento);
    document.getElementById('growth-rate-desc').textContent = trends.indicadores.tasa_crecimiento_desc;
    
    document.getElementById('satisfaction').textContent = formatPercentage(trends.indicadores.satisfaccion_cliente);
    document.getElementById('satisfaction-desc').textContent = trends.indicadores.satisfaccion_cliente_desc;
    
    // Actualizar c√≠rculos de progreso
    updateProgressCircle('market-share-circle', trends.indicadores.participacion_mercado);
    updateProgressCircle('growth-rate-circle', trends.indicadores.tasa_crecimiento_clamped);
    updateProgressCircle('satisfaction-circle', trends.indicadores.satisfaccion_cliente);
}

// Funci√≥n para mostrar un estado vac√≠o en gr√°ficos
function showEmptyChart(chartContainer, title, message, icon = 'fa-chart-line') {
    const chartId = chartContainer.querySelector('canvas').id;
    chartContainer.innerHTML = `
        <div class="no-data-container h-64">
            <div class="no-data-icon">
                <i class="fas ${icon}"></i>
            </div>
            <h3 class="no-data-title">${title}</h3>
            <p class="no-data-message">${message}</p>
        </div>
    `;
}

// Funci√≥n para inicializar el gr√°fico de evoluci√≥n de ventas
function initializeSalesChart(data) {
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Ventas ($)',
                data: data.data,
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n para inicializar el gr√°fico de comparaci√≥n de categor√≠as
function initializeCategoryComparisonChart(data) {
    const categoryComparisonCtx = document.getElementById('categoryComparisonChart').getContext('2d');
    categoryComparisonChart = new Chart(categoryComparisonCtx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Ventas Actuales ($)',
                data: data.current_data,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(236, 72, 153, 0.8)'
                ],
                borderWidth: 0
            }, {
                label: 'Ventas Anteriores ($)',
                data: data.previous_data,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.4)',
                    'rgba(16, 185, 129, 0.4)',
                    'rgba(245, 158, 11, 0.4)',
                    'rgba(139, 92, 246, 0.4)',
                    'rgba(236, 72, 153, 0.4)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.raw.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n para actualizar c√≠rculo de progreso
function updateProgressCircle(circleId, percentage) {
    const circle = document.getElementById(circleId);
    if (!circle) return;
    
    const circumference = 150.8; // 2 * PI * 24 (radio del c√≠rculo SVG)
    const offset = circumference - (Math.min(100, Math.max(0, parseFloat(percentage) || 0)) / 100) * circumference;
    circle.style.strokeDashoffset = offset;
}

// Funci√≥n para actualizar rendimiento de subcategor√≠as
function updateSubcategoryPerformance(subcategories) {
    // Verificar si hay datos de subcategor√≠as
    if (!subcategories || subcategories.length === 0) {
        const subcategoryChartContainer = document.getElementById('subcategoryChart').parentElement;
        showEmptyChart(subcategoryChartContainer, 'Sin subcategor√≠as', 'No hay subcategor√≠as disponibles para esta categor√≠a.');
        
        document.getElementById('top-subcategories').innerHTML = '';
        showEmptyCard(document.getElementById('subcategory-cards'), 'Sin subcategor√≠as', 'No hay subcategor√≠as disponibles para mostrar.');
        showEmptyCard(document.getElementById('low-performing-subcategories'), 'Sin subcategor√≠as', 'No hay subcategor√≠as con bajo rendimiento para mostrar.');
        
        return;
    }
    
    // Actualizar gr√°fico
    const subcategoryChartContainer = document.getElementById('subcategoryChart').parentElement;
    if (!document.getElementById('subcategoryChart')) {
        subcategoryChartContainer.innerHTML = '<canvas id="subcategoryChart"></canvas><div id="subcategoryChartLoading" class="loading-overlay" style="display: none;"><div class="loading-spinner"></div></div>';
        // Reinicializar el gr√°fico
        initializeSubcategoryChart(subcategories);
    } else if (subcategoryChart) {
        subcategoryChart.data.labels = subcategories.map(s => s.nombre);
        subcategoryChart.data.datasets[0].data = subcategories.map(s => s.ventas);
        subcategoryChart.update();
    }
    
    // Actualizar top subcategor√≠as
    const topSubcategoriesContainer = document.getElementById('top-subcategories');
    topSubcategoriesContainer.innerHTML = '';
    
    const topSubcategories = subcategories.slice(0, 3);
    if (topSubcategories.length === 0) {
        showEmptyCard(topSubcategoriesContainer, 'Sin subcategor√≠as destacadas', 'No hay subcategor√≠as con ventas para mostrar.');
    } else {
        topSubcategories.forEach((subcategory, index) => {
            const colors = ['blue', 'green', 'purple'];
            const item = document.createElement('div');
            item.className = `flex items-center justify-between p-3 bg-${colors[index]}-50 rounded-lg`;
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-${colors[index]}-100 flex items-center justify-center mr-3">
                        <span class="text-${colors[index]}-800 font-bold text-sm">${index + 1}</span>
                    </div>
                    <span class="font-medium text-gray-800">${subcategory.nombre}</span>
                    ${subcategory.estado === 'inactivo' ? '<span class="status-badge status-inactive ml-2"><i class="fas fa-circle"></i>Inactivo</span>' : ''}
                </div>
                <span class="font-bold text-gray-800">${formatCurrency(subcategory.ventas)}</span>
            `;
            topSubcategoriesContainer.appendChild(item);
        });
    }
    
    // Actualizar tarjetas de subcategor√≠as
    const subcategoryCardsContainer = document.getElementById('subcategory-cards');
    subcategoryCardsContainer.innerHTML = '';
    
    const topSubcategoryCards = subcategories.slice(0, 3);
    if (topSubcategoryCards.length === 0) {
        showEmptyCard(subcategoryCardsContainer, 'Sin subcategor√≠as destacadas', 'No hay subcategor√≠as con ventas para mostrar.');
    } else {
        topSubcategoryCards.forEach((subcategory, index) => {
            const colors = ['blue', 'green', 'purple'];
            const card = document.createElement('div');
            card.className = 'category-card bg-white border border-gray-200 rounded-xl overflow-hidden';
            card.innerHTML = `
                <div class="bg-gradient-to-r from-${colors[index]}-600 to-${colors[index]}-800 text-white p-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-lg">${subcategory.nombre}</h4>
                        <span class="bg-${colors[index]}-900 text-xs font-medium px-2 py-1 rounded-full">Top ${index + 1}</span>
                    </div>
                    <p class="text-${colors[index]}-100 text-sm mt-1">Ventas: ${formatCurrency(subcategory.ventas)}</p>
                </div>
                <div class="p-4">
                    <h5 class="font-medium text-gray-700 mb-3">Seudocategor√≠as Destacadas</h5>
                    <div class="space-y-3">
                        ${subcategory.seudocategorias && subcategory.seudocategorias.length > 0 ? 
                            subcategory.seudocategorias.map(pseudo => `
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex items-center">
                                        <span class="text-gray-600">${pseudo.nombre}</span>
                                        ${pseudo.estado === 'inactivo' ? '<span class="status-badge status-inactive ml-2"><i class="fas fa-circle"></i>Inactivo</span>' : ''}
                                    </div>
                                    <span class="text-sm font-medium">${formatCurrency(pseudo.ventas)}</span>
                                </div>
                            `).join('') : 
                            '<p class="text-gray-500 text-sm">No hay seudocategor√≠as disponibles</p>'
                        }
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Crecimiento mensual:</span>
                            <span class="${subcategory.crecimiento > 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                                ${subcategory.crecimiento > 0 ? '+' : ''}${formatPercentage(subcategory.crecimiento)}
                            </span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span class="text-gray-500">Estado:</span>
                            <span class="status-badge ${subcategory.estado === 'activo' ? 'status-active' : 'status-inactive'}">
                                <i class="fas fa-circle"></i>${subcategory.estado === 'activo' ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            subcategoryCardsContainer.appendChild(card);
        });
    }
    
    // Actualizar subcategor√≠as con bajo rendimiento
    const lowPerformingContainer = document.getElementById('low-performing-subcategories');
    lowPerformingContainer.innerHTML = '';
    
    const lowPerformingSubcategories = subcategories.slice(3);
    if (lowPerformingSubcategories.length === 0) {
        showEmptyCard(lowPerformingContainer, 'Sin subcategor√≠as con bajo rendimiento', 'Todas las subcategor√≠as tienen un rendimiento similar.');
    } else {
        lowPerformingSubcategories.forEach((subcategory, index) => {
            const colors = ['amber', 'rose', 'gray'];
            const card = document.createElement('div');
            card.className = 'category-card bg-white border border-gray-200 rounded-xl overflow-hidden';
            card.innerHTML = `
                <div class="bg-gradient-to-r from-${colors[index]}-600 to-${colors[index]}-800 text-white p-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-lg">${subcategory.nombre}</h4>
                        <span class="bg-${colors[index]}-900 text-xs font-medium px-2 py-1 rounded-full">Top ${index + 4}</span>
                    </div>
                    <p class="text-${colors[index]}-100 text-sm mt-1">Ventas: ${formatCurrency(subcategory.ventas)}</p>
                </div>
                <div class="p-4">
                    <h5 class="font-medium text-gray-700 mb-3">Seudocategor√≠as</h5>
                    <div class="space-y-3">
                        ${subcategory.seudocategorias && subcategory.seudocategorias.length > 0 ? 
                            subcategory.seudocategorias.map(pseudo => `
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex items-center">
                                        <span class="text-gray-600">${pseudo.nombre}</span>
                                        ${pseudo.estado === 'inactivo' ? '<span class="status-badge status-inactive ml-2"><i class="fas fa-circle"></i>Inactivo</span>' : ''}
                                    </div>
                                    <span class="text-sm font-medium">${formatCurrency(pseudo.ventas)}</span>
                                </div>
                            `).join('') : 
                            '<p class="text-gray-500 text-sm">No hay seudocategor√≠as disponibles</p>'
                        }
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Crecimiento mensual:</span>
                            <span class="${subcategory.crecimiento > 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                                ${subcategory.crecimiento > 0 ? '+' : ''}${formatPercentage(subcategory.crecimiento)}
                            </span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span class="text-gray-500">Estado:</span>
                            <span class="status-badge ${subcategory.estado === 'activo' ? 'status-active' : 'status-inactive'}">
                                <i class="fas fa-circle"></i>${subcategory.estado === 'activo' ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            lowPerformingContainer.appendChild(card);
        });
    }
}

// Funci√≥n para inicializar el gr√°fico de subcategor√≠as
function initializeSubcategoryChart(subcategories) {
    const subcategoryCtx = document.getElementById('subcategoryChart').getContext('2d');
    subcategoryChart = new Chart(subcategoryCtx, {
        type: 'doughnut',
        data: {
            labels: subcategories.map(s => s.nombre),
            datasets: [{
                data: subcategories.map(s => s.ventas),
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(244, 63, 94, 0.8)',
                    'rgba(107, 114, 128, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.raw.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n para actualizar vista de productos m√°s vendidos
function updateTopProductsView() {
    const tableView = document.getElementById('table-view');
    const gridView = document.getElementById('grid-view');
    const tableBtn = document.getElementById('view-table');
    const gridBtn = document.getElementById('view-grid');
    
    if (tableBtn.classList.contains('active')) {
        // Vista de tabla
        tableView.style.display = 'block';
        gridView.style.display = 'none';
        renderTopProductsTable(filteredTopProducts);
    } else {
        // Vista de cuadr√≠cula
        tableView.style.display = 'none';
        gridView.style.display = 'grid';
        renderTopProductsGrid(filteredTopProducts);
    }
}

// Funci√≥n para renderizar la tabla de productos m√°s vendidos
function renderTopProductsTable(products) {
    const tableBody = document.getElementById('top-products-table');
    
    if (!products || products.length === 0) {
        showEmptyTable(tableBody, 'No hay productos vendidos', 'No se encontraron productos con los filtros aplicados.');
        return;
    }
    
    tableBody.innerHTML = '';
    
    products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-12 w-12 rounded-lg overflow-hidden shadow-sm border border-gray-200">
                        <img class="h-12 w-12 object-cover" src="${product.imagen_url || 'https://via.placeholder.com/40'}" alt="${product.nombre}">
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-semibold text-gray-900">${product.nombre}</div>
                        <div class="text-sm text-gray-500">${product.marca || 'Sin marca'}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${product.categoria_principal_nombre || ''}</div>
                <div class="text-sm text-gray-500">${product.subcategoria_nombre || ''} / ${product.seudocategoria_nombre || ''}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(product.precio)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.unidades_vendidas}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(product.ingresos)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="trend-indicator ${product.tendencia > 0 ? 'trend-up' : 'trend-down'}">
                    <i class="fas fa-arrow-${product.tendencia > 0 ? 'up' : 'down'} mr-1"></i> ${formatPercentage(Math.abs(product.tendencia))}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge ${product.estado === 'activo' ? 'status-active' : 'status-inactive'}">
                    <i class="fas fa-circle"></i>${product.estado === 'activo' ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <a href="/admin/producto/${product.slug}" class="text-blue-600 hover:text-blue-900">Ver</a>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Funci√≥n para renderizar la cuadr√≠cula de productos m√°s vendidos
function renderTopProductsGrid(products) {
    const gridContainer = document.getElementById('grid-view');
    
    if (!products || products.length === 0) {
        showEmptyCard(gridContainer, 'No hay productos vendidos', 'No se encontraron productos con los filtros aplicados.');
        return;
    }
    
    gridContainer.innerHTML = '';
    
    products.forEach(product => {
        const card = document.createElement('div');
        card.className = `product-grid-card ${product.estado === 'inactivo' ? 'opacity-70' : ''}`;
        card.innerHTML = `
            <img src="${product.imagen_url || 'https://via.placeholder.com/300x200'}" alt="${product.nombre}" class="product-grid-img">
            <div class="product-grid-content">
                <div class="product-grid-header">
                    <h4 class="product-grid-title">${product.nombre}</h4>
                    ${product.estado === 'inactivo' ? '<span class="status-badge status-inactive"><i class="fas fa-circle"></i>Inactivo</span>' : ''}
                </div>
                <p class="product-grid-brand">${product.marca || 'N/A'}</p>
                <div class="product-grid-price">${formatCurrency(product.precio)}</div>
                <div class="product-grid-stats">
                    <div class="product-grid-stat">
                        <div class="product-grid-stat-value">${product.unidades_vendidas}</div>
                        <div class="product-grid-stat-label">Unidades</div>
                    </div>
                    <div class="product-grid-stat">
                        <div class="product-grid-stat-value">${formatCurrency(product.ingresos)}</div>
                        <div class="product-grid-stat-label">Ingresos</div>
                    </div>
                    <div class="product-grid-stat">
                        <div class="product-grid-stat-value ${product.tendencia > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${product.tendencia > 0 ? '+' : ''}${formatPercentage(product.tendencia)}
                        </div>
                        <div class="product-grid-stat-label">Tendencia</div>
                    </div>
                </div>
                <div class="product-grid-footer">
                    <div>
                        <div class="text-xs font-medium text-gray-800">${product.categoria_principal_nombre || ''}</div>
                        <div class="text-xs text-gray-500">${product.subcategoria_nombre || ''} / ${product.seudocategoria_nombre || ''}</div>
                    </div>
                    <a href="/admin/producto/${product.slug}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Ver detalles</a>
                </div>
            </div>
        `;
        gridContainer.appendChild(card);
    });
}

// Funci√≥n para aplicar filtros a productos m√°s vendidos
async function applyTopProductsFilters(page = 1) {
    topProductsCurrentPage = page;
    const loader = document.getElementById('top-products-loader');
    if (loader) loader.classList.remove('hidden');

    const period = document.getElementById('period-filter').value;
    const sortBy = document.getElementById('sort-filter').value;
    const minPrice = document.getElementById('min-price').value;
    const maxPrice = document.getElementById('max-price').value;
    const categoryFilter = document.getElementById('category-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    const search = document.getElementById('product-search').value;
    
    try {
        // Construir URL con par√°metros de consulta
        const params = new URLSearchParams();
        params.append('period', period);
        params.append('sort_by', sortBy);
        if (minPrice) params.append('min_price', minPrice);
        if (maxPrice) params.append('max_price', maxPrice);
        if (categoryFilter) params.append('category_filter', categoryFilter);
        if (statusFilter) params.append('status_filter', statusFilter);
        if (search) params.append('search', search);
        // Usar paginaci√≥n en lugar de l√≠mite fijo
        params.append('page', topProductsCurrentPage);
        params.append('per_page', topProductsPerPage);
        
        const response = await fetch(`/admin/categorias-principales/${categoriaId}/top-products-filtered?${params.toString()}`);
        const data = await response.json();
        
        if (data.success) {
            // Actualizar productos filtrados
            filteredTopProducts = data.products;
            updateTopProductsView();
            // Renderizar la paginaci√≥n
            renderTopProductsPagination(data.pagination);
        } else {
            console.error('Error al cargar productos filtrados:', data.message);
            showErrorMessage('Error al cargar los productos filtrados: ' + data.message);
        }
    } catch (error) {
        console.error('Error en la solicitud:', error);
        showErrorMessage('Error de conexi√≥n al cargar productos filtrados. Por favor, intente nuevamente m√°s tarde.');
    } finally {
        if (loader) loader.classList.add('hidden');
    }
}

// Funci√≥n para aplicar filtros con debounce
function applyTopProductsFiltersWithDebounce() {
    // Limpiar el timeout anterior si existe
    clearTimeout(topProductsFilterTimeout);

    // Establecer un nuevo timeout
    topProductsFilterTimeout = setTimeout(() => {
        applyTopProductsFilters(1); // Resetear a la p√°gina 1
    }, 500); // 500ms de retraso
}

// Funci√≥n para restablecer filtros
function resetTopProductsFilters() {
    document.getElementById('product-search').value = '';
    document.getElementById('min-price').value = '';
    document.getElementById('max-price').value = '';
    document.getElementById('sort-filter').value = 'ventas';
    document.getElementById('period-filter').value = '30';
    document.getElementById('category-filter').value = '';
    document.getElementById('status-filter').value = '';
    
    // Llamar a la funci√≥n de filtrado para recargar desde el servidor
    applyTopProductsFilters(1);
}

// NUEVA FUNCI√ìN: Renderizar la paginaci√≥n
function renderTopProductsPagination(pagination) {
    const paginationContainer = document.getElementById('top-products-pagination');
    if (!paginationContainer || !pagination || pagination.pages <= 1) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    let paginationHTML = '<nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">';

    // Bot√≥n Anterior
    paginationHTML += `
        <button onclick="applyTopProductsFilters(${pagination.prev_num})" 
                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${!pagination.has_prev ? 'cursor-not-allowed opacity-50' : ''}" 
                ${!pagination.has_prev ? 'disabled' : ''}>
            <span class="sr-only">Anterior</span>
            <i class="fas fa-chevron-left h-5 w-5"></i>
        </button>
    `;

    // N√∫meros de p√°gina
    const maxVisiblePages = 5;
    let startPage = Math.max(1, pagination.page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(pagination.pages, startPage + maxVisiblePages - 1);
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
        paginationHTML += `<button onclick="applyTopProductsFilters(1)" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === pagination.page;
        paginationHTML += `
            <button onclick="applyTopProductsFilters(${i})" 
                    class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${isActive ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'}"
                    ${isActive ? 'disabled' : ''}>
                ${i}
            </button>
        `;
    }

    if (endPage < pagination.pages) {
        if (endPage < pagination.pages - 1) {
            paginationHTML += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
        }
        paginationHTML += `<button onclick="applyTopProductsFilters(${pagination.pages})" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">${pagination.pages}</button>`;
    }

    // Bot√≥n Siguiente
    paginationHTML += `
        <button onclick="applyTopProductsFilters(${pagination.next_num})" 
                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${!pagination.has_next ? 'cursor-not-allowed opacity-50' : ''}" 
                ${!pagination.has_next ? 'disabled' : ''}>
            <span class="sr-only">Siguiente</span>
            <i class="fas fa-chevron-right h-5 w-5"></i>
        </button>
    `;

    paginationHTML += '</nav>';
    paginationContainer.innerHTML = paginationHTML;
}

// =============== NUEVAS FUNCIONES PARA PRODUCTOS RELACIONADOS ===============

// Funci√≥n para obtener productos relacionados con filtros avanzados
async function fetchRelatedProductsAdvanced() {
    const loader = document.getElementById('related-products-loader');
    if (loader) loader.classList.remove('hidden');

    try {
        // Obtener par√°metros de filtrado
        const search = document.getElementById('related-product-search').value;
        const sortBy = document.getElementById('related-sort-by').value;
        const order = document.getElementById('related-order').value;
        const estado = document.getElementById('related-status').value;
        // Nuevos filtros de categor√≠a
        const subcategoriaId = document.getElementById('related-subcategory-filter').value;
        const seudocategoriaId = document.getElementById('related-pseudocategory-filter').value;
        
        // Construir URL con par√°metros de consulta
        const params = new URLSearchParams();
        params.append('page', relatedProductsCurrentPage);
        params.append('per_page', relatedProductsPerPage);
        if (search) params.append('search', search);
        if (sortBy) params.append('sort_by', sortBy);
        if (order) params.append('order', order);
        if (estado) params.append('estado', estado);
        if (subcategoriaId) params.append('subcategoria_id', subcategoriaId);
        if (seudocategoriaId) params.append('seudocategoria_id', seudocategoriaId);
        
        const response = await fetch(`/admin/categorias-principales/${categoriaId}/productos-relacionados-advanced?${params.toString()}`);
        const data = await response.json();
        
        if (data.success) {
            // Almacenar los productos obtenidos para reutilizarlos al cambiar de vista
            currentRelatedProducts = data.products;
            // Actualizar vista de productos relacionados
            updateRelatedProductsView(data.products);
            updateRelatedPaginationInfo(data);
            renderRelatedPagination(data);
        } else {
            console.error('Error al cargar productos relacionados:', data.message);
            showErrorMessage('Error al cargar los productos relacionados: ' + data.message);
        }
    } catch (error) {
        console.error('Error en la solicitud:', error);
        showErrorMessage('Error de conexi√≥n al cargar productos relacionados. Por favor, intente nuevamente m√°s tarde.');
    } finally {
        if (loader) loader.classList.add('hidden');
    }
}

// Funci√≥n para actualizar vista de productos relacionados
function updateRelatedProductsView(products) {
    const tableView = document.getElementById('related-table-view');
    const gridView = document.getElementById('related-grid-view');
    const tableBtn = document.getElementById('related-view-table');
    const gridBtn = document.getElementById('related-view-grid');
    
    if (tableBtn.classList.contains('active')) {
        // Vista de tabla
        tableView.style.display = 'block';
        gridView.style.display = 'none';
        renderRelatedProductsTable(products);
    } else {
        // Vista de cuadr√≠cula
        tableView.style.display = 'none';
        gridView.style.display = 'grid';
        renderRelatedProductsGrid(products);
    }
}

// Funci√≥n para renderizar la tabla de productos relacionados
function renderRelatedProductsTable(products) {
    const tableBody = document.getElementById('related-products-table-body');
    
    if (!products || products.length === 0) {
        showEmptyTable(tableBody, 'No hay productos disponibles', 'No se encontraron productos con los filtros aplicados.', 7);
        return;
    }
    
    tableBody.innerHTML = '';
    
    products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-12 w-12 rounded-lg overflow-hidden shadow-sm border border-gray-200">
                        <img class="h-12 w-12 object-cover" src="${product.imagen_url || 'https://via.placeholder.com/40'}" alt="${product.nombre}">
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-semibold text-gray-900">${product.nombre}</div>
                        <div class="text-sm text-gray-500">${product.marca || 'Sin marca'}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${product.categoria_principal_nombre || ''}</div>
                <div class="text-sm text-gray-500">${product.subcategoria_nombre || ''} / ${product.seudocategoria_nombre || ''}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(product.precio)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <span class="text-xs ${product.agotado ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} px-2 py-1 rounded">
                    ${product.existencia}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                    ${renderStars(product.calificacion_promedio)}
                    <span class="ml-1 text-sm text-gray-600">${product.calificacion_promedio ? product.calificacion_promedio.toFixed(1) : 'N/A'}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge ${product.estado === 'activo' ? 'status-active' : 'status-inactive'}">
                    <i class="fas fa-circle"></i>${product.estado === 'activo' ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <a href="/admin/producto/${product.slug}" class="text-blue-600 hover:text-blue-900">Ver</a>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Funci√≥n para renderizar la cuadr√≠cula de productos relacionados
function renderRelatedProductsGrid(products) {
    const gridContainer = document.getElementById('related-grid-view');
    
    if (!products || products.length === 0) {
        showEmptyCard(gridContainer, 'No hay productos disponibles', 'No se encontraron productos con los filtros aplicados.');
        return;
    }
    
    gridContainer.innerHTML = '';
    
    products.forEach(product => {
        const card = document.createElement('div');
        card.className = `related-product-card ${product.estado === 'inactivo' ? 'opacity-70' : ''}`;
        card.innerHTML = `
            <div class="related-product-image-container">
                <img src="${product.imagen_url || 'https://via.placeholder.com/300x200'}" alt="${product.nombre}" class="related-product-image">
                <div class="related-product-badges">
                    ${product.es_nuevo ? '<span class="related-product-badge related-product-badge-new">Nuevo</span>' : ''}
                    ${product.estado === 'inactivo' ? '<span class="related-product-badge related-product-badge-inactive">Inactivo</span>' : ''}
                </div>
            </div>
            <div class="related-product-content">
                <div class="related-product-header">
                    <h4 class="related-product-title">${product.nombre}</h4>
                    ${product.estado === 'inactivo' ? '<span class="status-badge status-inactive"><i class="fas fa-circle"></i>Inactivo</span>' : ''}
                </div>
                <p class="related-product-brand">${product.marca || 'N/A'}</p>
                <div class="related-product-details">
                    <div class="related-product-price">${formatCurrency(product.precio)}</div>
                    <div class="related-product-rating">
                        <div class="related-product-stars">
                            ${renderStars(product.calificacion_promedio)}
                        </div>
                        <span class="related-product-rating-value">${product.calificacion_promedio ? product.calificacion_promedio.toFixed(1) : 'N/A'}</span>
                    </div>
                </div>
                <div class="related-product-stats">
                    <div class="related-product-stat">
                        <div class="related-product-stat-value">${product.existencia}</div>
                        <div class="related-product-stat-label">Existencia</div>
                    </div>
                    <div class="related-product-stat">
                        <div class="related-product-stat-value ${product.agotado ? 'text-red-600' : 'text-green-600'}">
                            ${product.agotado ? 'Agotado' : 'Disponible'}
                        </div>
                        <div class="related-product-stat-label">Estado</div>
                    </div>
                    <div class="related-product-stat">
                        <div class="related-product-stat-value">
                            ${product.calificacion_promedio ? product.calificacion_promedio.toFixed(1) : 'N/A'}
                        </div>
                        <div class="related-product-stat-label">Calificaci√≥n</div>
                    </div>
                </div>
                <div class="related-product-footer">
                    <div>
                        <div class="text-xs font-medium text-gray-800">${product.categoria_principal_nombre || ''}</div>
                        <div class="text-xs text-gray-500">${product.subcategoria_nombre || ''} / ${product.seudocategoria_nombre || ''}</div>
                    </div>
                    <a href="/admin/producto/${product.slug}" class="related-product-action">Ver detalles</a>
                </div>
            </div>
        `;
        gridContainer.appendChild(card);
    });
}

// Funci√≥n para actualizar informaci√≥n de paginaci√≥n de productos relacionados
function updateRelatedPaginationInfo(data) {
    const start = (data.page - 1) * data.per_page + 1;
    const end = Math.min(data.page * data.per_page, data.total);
    
    document.getElementById('related-products-pagination-info').innerHTML = 
        `Mostrando <span class="font-medium">${start}-${end}</span> de <span class="font-medium">${data.total}</span> productos`;
}

// Funci√≥n para renderizar la paginaci√≥n de productos relacionados
function renderRelatedPagination(data) {
    const paginationContainer = document.getElementById('related-products-pagination-controls');
    if (!paginationContainer || !data || data.pages <= 1) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    let paginationHTML = '';

    // Bot√≥n Anterior
    paginationHTML += `
        <button onclick="changeRelatedProductsPage(${data.page - 1})" 
                class="related-products-pagination-btn ${data.page <= 1 ? 'disabled' : ''}" 
                ${data.page <= 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left mr-1"></i> Anterior
        </button>
    `;

    // N√∫meros de p√°gina
    const maxVisiblePages = 5;
    let startPage = Math.max(1, data.page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(data.pages, startPage + maxVisiblePages - 1);
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
        paginationHTML += `<button onclick="changeRelatedProductsPage(1)" class="related-products-pagination-btn">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="related-products-pagination-ellipsis">...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === data.page;
        paginationHTML += `
            <button onclick="changeRelatedProductsPage(${i})" 
                    class="related-products-pagination-btn ${isActive ? 'active' : ''}"
                    ${isActive ? 'disabled' : ''}>
                ${i}
            </button>
        `;
    }

    if (endPage < data.pages) {
        if (endPage < data.pages - 1) {
            paginationHTML += `<span class="related-products-pagination-ellipsis">...</span>`;
        }
        paginationHTML += `<button onclick="changeRelatedProductsPage(${data.pages})" class="related-products-pagination-btn">${data.pages}</button>`;
    }

    // Bot√≥n Siguiente
    paginationHTML += `
        <button onclick="changeRelatedProductsPage(${data.page + 1})" 
                class="related-products-pagination-btn ${data.page >= data.pages ? 'disabled' : ''}" 
                ${data.page >= data.pages ? 'disabled' : ''}>
            Siguiente <i class="fas fa-chevron-right ml-1"></i>
        </button>
    `;

    paginationContainer.innerHTML = paginationHTML;
}

// Funci√≥n para cambiar la p√°gina de productos relacionados
function changeRelatedProductsPage(page) {
    relatedProductsCurrentPage = page;
    fetchRelatedProductsAdvanced();
}

// Funci√≥n para aplicar filtros con debounce
function applyRelatedProductsFiltersWithDebounce() {
    // Limpiar el timeout anterior si existe
    clearTimeout(relatedProductsFilterTimeout);

    // Establecer un nuevo timeout
    relatedProductsFilterTimeout = setTimeout(() => {
        relatedProductsCurrentPage = 1; // Resetear a la p√°gina 1
        fetchRelatedProductsAdvanced();
    }, 500); // 500ms de retraso
}

// Funci√≥n para restablecer filtros de productos relacionados
function resetRelatedProductsFilters() {
    document.getElementById('related-product-search').value = '';
    document.getElementById('related-sort-by').value = 'nombre';
    document.getElementById('related-order').value = 'asc';
    document.getElementById('related-status').value = '';
    
    relatedProductsCurrentPage = 1;
    fetchRelatedProductsAdvanced();
}

// Funci√≥n para renderizar estrellas de calificaci√≥n
function renderStars(rating) {
    if (!rating) return '<i class="far fa-star"></i>'.repeat(5);
    
    let stars = '';
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
    }
    
    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
    }
    
    const emptyStars = 5 - Math.ceil(rating);
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
    }
    
    return stars;
}

// Funci√≥n para poblar los filtros de categor√≠a de productos relacionados
async function populateRelatedCategoryFilters() {
    try {
        const response = await fetch(`/admin/categorias-principales/${categoriaId}/subcategorias-filtro`);
        const data = await response.json();
        if (data.success) {
            relatedSubcategories = data.subcategorias;
            const subcategoryFilter = document.getElementById('related-subcategory-filter');
            subcategoryFilter.innerHTML = '<option value="">Todas</option>'; // Reset
            relatedSubcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.nombre;
                subcategoryFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error al cargar filtros de subcategor√≠a:', error);
    }
}

// Funci√≥n para poblar el filtro de seudocategor√≠a
async function populateRelatedPseudocategoryFilter(subcategoryId) {
    const pseudocategoryFilter = document.getElementById('related-pseudocategory-filter');
    pseudocategoryFilter.innerHTML = '<option value="">Todas</option>'; // Reset
    
    if (!subcategoryId) {
        pseudocategoryFilter.disabled = true;
        return;
    }

    pseudocategoryFilter.disabled = false;
    try {
        const response = await fetch(`/admin/subcategorias/${subcategoryId}/seudocategorias-filtro`);
        const data = await response.json();
        if (data.success) {
            relatedPseudocategories = data.seudocategorias;
            relatedPseudocategories.forEach(pseudo => {
                const option = document.createElement('option');
                option.value = pseudo.id;
                option.textContent = pseudo.nombre;
                pseudocategoryFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error al cargar filtros de seudocategor√≠a:', error);
        pseudocategoryFilter.disabled = true;
    }
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar gr√°ficos
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
            datasets: [{
                label: 'Ventas ($)',
                data: [0, 0, 0, 0, 0, 0],
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    const categoryComparisonCtx = document.getElementById('categoryComparisonChart').getContext('2d');
    categoryComparisonChart = new Chart(categoryComparisonCtx, {
        type: 'bar',
        data: {
            labels: ['Electr√≥nica', 'Hogar', 'Ropa', 'Deportes', 'Juguetes'],
            datasets: [{
                label: 'Ventas Actuales ($)',
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(236, 72, 153, 0.8)'
                ],
                borderWidth: 0
            }, {
                label: 'Ventas Anteriores ($)',
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.4)',
                    'rgba(16, 185, 129, 0.4)',
                    'rgba(245, 158, 11, 0.4)',
                    'rgba(139, 92, 246, 0.4)',
                    'rgba(236, 72, 153, 0.4)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.raw.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    const subcategoryCtx = document.getElementById('subcategoryChart').getContext('2d');
    subcategoryChart = new Chart(subcategoryCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(244, 63, 94, 0.8)',
                    'rgba(107, 114, 128, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.raw.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // Cargar datos iniciales
    fetchCategoryData();
    
    // Event listeners para filtros de productos m√°s vendidos - Aplicaci√≥n autom√°tica
    document.getElementById('period-filter').addEventListener('change', applyTopProductsFiltersWithDebounce);
    document.getElementById('sort-filter').addEventListener('change', applyTopProductsFiltersWithDebounce);
    document.getElementById('min-price').addEventListener('input', applyTopProductsFiltersWithDebounce);
    document.getElementById('max-price').addEventListener('input', applyTopProductsFiltersWithDebounce);
    document.getElementById('category-filter').addEventListener('change', applyTopProductsFiltersWithDebounce);
    document.getElementById('status-filter').addEventListener('change', applyTopProductsFiltersWithDebounce);
    document.getElementById('product-search').addEventListener('input', applyTopProductsFiltersWithDebounce);
    
    // Event listeners para botones de filtros
    document.getElementById('reset-filters').addEventListener('click', resetTopProductsFilters);
    
    // Event listeners para vista de productos m√°s vendidos
    document.getElementById('view-table').addEventListener('click', function() {
        document.getElementById('view-table').classList.add('active');
        document.getElementById('view-grid').classList.remove('active');
        updateTopProductsView();
    });
    
    document.getElementById('view-grid').addEventListener('click', function() {
        document.getElementById('view-grid').classList.add('active');
        document.getElementById('view-table').classList.remove('active');
        updateTopProductsView();
    });
    
    // ============= EVENT LISTENERS PARA PRODUCTOS RELACIONADOS =============
    
    // Event listeners para productos relacionados
    document.getElementById('related-view-table').addEventListener('click', function() {
        document.getElementById('related-view-table').classList.add('active');
        document.getElementById('related-view-grid').classList.remove('active');
        updateRelatedProductsView(currentRelatedProducts);
    });
    
    document.getElementById('related-view-grid').addEventListener('click', function() {
        document.getElementById('related-view-grid').classList.add('active');
        document.getElementById('related-view-table').classList.remove('active');
        updateRelatedProductsView(currentRelatedProducts);
    });
    
    document.getElementById('related-products-per-page').addEventListener('change', function() {
        relatedProductsPerPage = parseInt(this.value);
        relatedProductsCurrentPage = 1;
        fetchRelatedProductsAdvanced();
    });
    
    document.getElementById('related-product-search').addEventListener('input', applyRelatedProductsFiltersWithDebounce);
    document.getElementById('related-sort-by').addEventListener('change', applyRelatedProductsFiltersWithDebounce);
    document.getElementById('related-order').addEventListener('change', applyRelatedProductsFiltersWithDebounce);
    document.getElementById('related-status').addEventListener('change', applyRelatedProductsFiltersWithDebounce);

    // Cargar filtros de categor√≠a para productos relacionados
    populateRelatedCategoryFilters();

    // Event listeners para filtros de categor√≠a de productos relacionados
    document.getElementById('related-subcategory-filter').addEventListener('change', function() {
        const subcategoryId = this.value;
        populateRelatedPseudocategoryFilter(subcategoryId);
        // Se llama a applyRelatedProductsFiltersWithDebounce para que el filtro de seudocategor√≠a se aplique
        applyRelatedProductsFiltersWithDebounce();
    });

    document.getElementById('related-pseudocategory-filter').addEventListener('change', applyRelatedProductsFiltersWithDebounce);
    
    document.getElementById('reset-related-filters').addEventListener('click', resetRelatedProductsFilters);
    
    // Tab functionality
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Deactivate all tabs and contents
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activate selected tab and content
            button.classList.remove('border-transparent', 'text-gray-500');
            button.classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(tabId).classList.add('active');
        });
    });
});
    </script>
{% endblock %}