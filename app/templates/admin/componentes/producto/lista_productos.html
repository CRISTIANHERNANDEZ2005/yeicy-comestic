{% extends 'admin/page/base.html' %}
{% block title %} Lista Producto - Panel de Administración{% endblock %} 
{% block content %}
    <!-- templates/admin/componentes/lista_productos.html -->
    <div class="container mx-auto px-4 py-6 relative">
        <!-- Encabezado y controles -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Gestión de Productos
                </h1>
                <p class="text-gray-500 mt-1">Administra tu sección de productos</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <!-- Botón para agregar nuevo producto -->
                <a href="{{ url_for('admin_crear.create_product') }}" class="spa-link px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-lg hover:from-green-700 hover:to-emerald-800 flex items-center transition-all duration-300 transform hover:scale-105 shadow-md" title="Agregar nuevo producto">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Nuevo Producto
                </a>
                <button type="button" onclick="resetFilters()" class="px-4 py-2 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 rounded-xl hover:from-gray-300 hover:to-gray-400 flex items-center transition-all duration-300 transform hover:scale-105 shadow-lg focus:outline-none focus:ring-4 focus:ring-gray-300 font-semibold" title="Limpiar todos los filtros de búsqueda">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Limpiar Filtros
                </button>
            </div>
        </div>
        
        <!-- Incluir el componente de filtros -->
        {% include 'admin/ui/filtro_producto.html' %}
        
        <!-- Información de resultados -->
        <div class="mb-6 bg-white rounded-lg p-4 shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div class="mb-3 sm:mb-0">
                <p class="text-sm text-gray-600">
                    Mostrando
                    <span class="font-semibold text-blue-600">{{ pagination.last }}</span>
                    de
                    <span class="font-semibold text-blue-600">{{ pagination.total }}</span>
                    productos
                </p>
            </div>
            <div class="flex items-center">
                <span class="text-sm text-gray-600 mr-2">Productos por página:</span>
                <select id="perPageSelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 shadow-sm">
                    <option value="10" {% if pagination.per_page == 10 %} selected {% endif %}>10</option>
                    <option value="20" {% if pagination.per_page == 20 %} selected {% endif %}>20</option>
                    <option value="50" {% if pagination.per_page == 50 %} selected {% endif %}>50</option>
                    <option value="100" {% if pagination.per_page == 100 %} selected {% endif %}>100</option>
                </select>
            </div>
        </div>
        
        <!-- Tabla de productos -->
        <div class="relative bg-white shadow-lg rounded-xl overflow-hidden transition-all duration-300 hover:shadow-xl border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Producto
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Categorías
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Precio
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Existencia
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Estado
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                                        <tbody id="products-tbody" class="bg-white divide-y divide-gray-200">
                        {% for product in products %}
                            <tr class="hover:bg-blue-50 transition-colors duration-200" data-product-id="{{ product.id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-12 w-12 rounded-lg overflow-hidden shadow-sm border border-gray-200">
                                            <img class="h-12 w-12 object-cover" src="{{ product.imagen_url }}" alt="{{ product.nombre }}">
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-semibold text-gray-900">{{ product.nombre }}</div>
                                            <div class="text-sm text-gray-500">{{ product.marca or 'Sin marca' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ product.categoria_principal_nombre }}</div>
                                    <div class="text-sm text-gray-500">{{ product.subcategoria_nombre }} / {{ product.seudocategoria_nombre }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-semibold text-gray-900">{{ product.precio }}</div>
                                    <div class="text-sm text-gray-500">Costo: {{ product.costo }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ product.existencia }} unidades</div>
                                    <div class="text-xs font-semibold {% if product.agotado %}text-red-600 bg-red-50 px-2 py-1 rounded-full inline-block{% else %}text-green-600 bg-green-50 px-2 py-1 rounded-full inline-block{% endif %}">
                                        {% if product.agotado %}AGOTADO{% else %}Disponible{% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <!-- Interruptor de estado tipo foco mejorado -->
                                    <div class="flex items-center">
                                        <div class="relative inline-block w-14 h-7 mr-2 align-middle select-none">
                                            <input type="checkbox" id="toggle-{{ product.id }}" class="sr-only" {% if product.estado == 'activo' %}checked{% endif %} onchange="toggleProductStatus('{{ product.id }}', this.checked)">
                                            <label for="toggle-{{ product.id }}" class="block h-7 w-14 rounded-full cursor-pointer transition-colors duration-300 ease-in-out {% if product.estado == 'activo' %}bg-gradient-to-r from-green-400 to-emerald-500 shadow-lg{% else %}bg-gray-300{% endif %}" title="Cambiar estado del producto">
                                                <span class="absolute left-1 top-1 bg-white w-5 h-5 rounded-full shadow-md transition-transform duration-300 ease-in-out {% if product.estado == 'activo' %}transform translate-x-7{% else %}transform translate-x-0{% endif %} flex items-center justify-center">
                                                    <!-- Icono para estado activo -->
                                                    {% if product.estado == 'activo' %}
                                                        <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    {% else %}
                                                        <!-- Icono para estado inactivo -->
                                                        <svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    {% endif %}
                                                </span>
                                            </label>
                                        </div>
                                        {% if product.es_nuevo %}
                                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                Nuevo
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    {% if product.estado == 'activo' %}
                                        <a href="{{ url_for('admin_editar.edit_product_page', product_slug=product.slug) }}" class="spa-edit-product-link edit-product-btn inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-600 hover:text-indigo-800 transition-all duration-300 transform hover:scale-110 shadow-md" title="Editar producto">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>
                                    {% else %}
                                        <button type="button" class="edit-product-btn-inactive inline-flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 text-gray-400 cursor-not-allowed transition-all duration-300 shadow-md" title="Para editar, el producto debe estar activo">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                    {% endif %}
                                    <!-- Nuevo botón para ver detalles -->
                                    <a href="{{ url_for('admin_detalle.get_product_detail', product_slug=product.slug) }}" class="spa-product-detail-link inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-600 hover:text-blue-800 transition-all duration-300 transform hover:scale-110 shadow-md ml-2" title="Ver detalles del producto">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                    <div class="flex flex-col items-center justify-center">
                                        <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <p class="text-lg font-medium text-gray-500">No se encontraron productos con los filtros aplicados.</p>
                                        <p class="text-sm text-gray-400 mt-1">Intenta ajustar tus filtros para ver más resultados</p>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Contenedor de paginación -->
        <div class="mt-8 flex flex-col items-center bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div class="text-sm text-gray-700 mb-4">
                Mostrando página
                <span class="font-semibold text-blue-600">{{ pagination.page }}</span>
                de
                <span class="font-semibold text-blue-600">{{ pagination.pages }}</span>
            </div>
            
            <!-- Paginación responsive -->
            {% if pagination.pages > 1 %}
                <div class="flex flex-wrap justify-center gap-2">
                    <!-- Botón anterior -->
                    <a href="#" data-page="{{ pagination.prev_num }}" class="pagination-link px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium {% if not pagination.has_prev %}text-gray-400 cursor-not-allowed{% else %}text-gray-700 hover:bg-gray-50 transition-colors duration-200{% endif %} inline-flex items-center" title="Ir a la página anterior">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Anterior
                    </a>
                    
                    <!-- Números de página -->
                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                        {% if page_num %}
                            {% if page_num == pagination.page %}
                                <span class="px-3 py-2 rounded-lg border border-blue-500 bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-sm font-medium" title="Página actual {{ page_num }}">
                                    {{ page_num }}
                                </span>
                            {% else %}
                                <a href="#" data-page="{{ page_num }}" class="pagination-link px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200" title="Ir a la página {{ page_num }}">
                                    {{ page_num }}
                                </a>
                            {% endif %}
                        {% else %}
                            <span class="px-3 py-2 text-gray-500">...</span>
                        {% endif %}
                    {% endfor %}

                    <!-- Botón siguiente -->
                    <a href="#" data-page="{{ pagination.next_num }}" class="pagination-link px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium {% if not pagination.has_next %}text-gray-400 cursor-not-allowed{% else %}text-gray-700 hover:bg-gray-50 transition-colors duration-200{% endif %} inline-flex items-center" title="Ir a la página siguiente">
                        Siguiente
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <style>
        /* Estilos para el interruptor de estado */
        .toggle-checkbox:checked + .toggle-label {
            background: linear-gradient(to right, #34d399, #10b981);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -1px rgba(16, 185, 129, 0.2);
        }
        
        .toggle-checkbox:checked + .toggle-label span {
            transform: translateX(1.75rem);
        }
        
        /* Estilos responsive para la paginación */
        @media (max-width: 640px) {
            .flex-wrap.gap-2 {
                gap: 0.5rem;
            }
            
            .px-4.py-2 {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            
            .px-3.py-2 {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        
    </style>
    
    <script>
        // Actualizar el formulario cuando cambie el número de elementos por página
        document.getElementById('perPageSelect').addEventListener('change', function () {
            // Actualizar el campo per_page en el formulario
            let perPageInput = document.querySelector('input[name="per_page"]');
            if (!perPageInput) {
                perPageInput = document.createElement('input');
                perPageInput.type = 'hidden';
                perPageInput.name = 'per_page';
                document.getElementById('filterForm').appendChild(perPageInput);
            }
            perPageInput.value = this.value;

            // **RESET a la página 1**
            let pageInput = document.querySelector('input[name="page"]');
            if (pageInput) {
                pageInput.value = '1';
            }
            
            // Aplicar filtros
            applyFilters();
        });
        
        // Función mejorada para cambiar el estado de un producto
        function toggleProductStatus(productId, isActive) {
            const toggle = document.getElementById(`toggle-${productId}`);
            if (!toggle) {
                console.error(`No se encontró el toggle para el producto ${productId}`);
                return;
            }
            
            const label = toggle.nextElementSibling;
            const span = label.querySelector('span');
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            
            // Store original state to revert on error
            const originalChecked = toggle.checked;
            const originalLabelClasses = Array.from(label.classList);
            const originalSpanClasses = Array.from(span.classList);
            const originalSpanInnerHTML = span.innerHTML;

            // Deshabilitar el toggle durante la petición
            toggle.disabled = true;
            
            // Añadir animación de carga
            span.innerHTML = `
                <svg class="animate-spin h-3 w-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            `;
            
            // Resaltar la fila durante la operación
            if (row) {
                row.classList.add('bg-blue-100');
            }
            
            // Realizar la petición AJAX
            fetch(`/admin/api/products/${productId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    estado: isActive ? 'activo' : 'inactivo'
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Error en la solicitud');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Si el estado no cambió, mostrar mensaje informativo y revertir
                    if (data.status_unchanged) {
                        window.toast.info(data.message);
                        toggle.checked = originalChecked;
                        label.className = originalLabelClasses.join(' ');
                        span.className = originalSpanClasses.join(' ');
                        span.innerHTML = originalSpanInnerHTML;
                        return;
                    }
                    
                    // Actualizar la UI del toggle
                    if (data.new_status === 'activo') {
                        label.classList.remove('bg-gray-300');
                        label.classList.add('bg-gradient-to-r', 'from-green-400', 'to-emerald-500', 'shadow-lg');
                        span.classList.add('transform', 'translate-x-7');
                        span.classList.remove('translate-x-0');
                        span.innerHTML = `
                            <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        `;
                    } else {
                        label.classList.add('bg-gray-300');
                        label.classList.remove('bg-gradient-to-r', 'from-green-400', 'to-emerald-500', 'shadow-lg');
                        span.classList.remove('transform', 'translate-x-7');
                        span.classList.add('translate-x-0');
                        span.innerHTML = `
                            <svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        `;
                    }

                    // Actualizar botón de editar en tiempo real
                    if (row) {
                        const detailLink = row.querySelector('.spa-product-detail-link');
                        if (detailLink) {
                            const slug = detailLink.getAttribute('href').split('/').pop();
                            const actionCell = row.querySelector('td:last-child');

                            if (actionCell && slug) {
                                let editActionHtml = '';
                                if (data.new_status === 'activo') {
                                    editActionHtml = `
                                        <a href="/admin/producto/editar/${slug}" class="spa-edit-product-link edit-product-btn inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-600 hover:text-indigo-800 transition-all duration-300 transform hover:scale-110 shadow-md" title="Editar producto">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>`;
                                } else {
                                    editActionHtml = `
                                        <button type="button" class="edit-product-btn-inactive inline-flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 text-gray-400 cursor-not-allowed transition-all duration-300 shadow-md" title="Para editar, el producto debe estar activo">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>`;
                                }

                                const detailActionHtml = detailLink.outerHTML;
                                actionCell.innerHTML = editActionHtml + detailActionHtml;
                            }
                        }
                    }
                    
                    window.toast.success(data.message);

                } else {
                    // Revertir el toggle visualmente y mostrar error si success is false
                    toggle.checked = originalChecked;
                    label.className = originalLabelClasses.join(' ');
                    span.className = originalSpanClasses.join(' ');
                    span.innerHTML = originalSpanInnerHTML;
                    window.toast.error(data.message || 'No se pudo cambiar el estado del producto. Inténtalo de nuevo.');
                }
            })
            .catch(error => {
                console.error('Error al cambiar estado del producto:', error);
                // Revertir el toggle visualmente en caso de error de red o de la promesa
                toggle.checked = originalChecked;
                label.className = originalLabelClasses.join(' ');
                span.className = originalSpanClasses.join(' ');
                span.innerHTML = originalSpanInnerHTML; // Restore original icon
                window.toast.error('Error de conexión o servidor. No se pudo cambiar el estado del producto.');
            })
            .finally(() => {
                // Restaurar el estado original de la fila
                if (row) {
                    row.classList.remove('bg-blue-100');
                }
                
                // Habilitar el toggle nuevamente
                toggle.disabled = false;
            });
        }

        function resetFilters() {
            // La lógica principal ahora está en filtro_producto.js para centralizarla.
            window.resetFilters();
        }
        document.addEventListener('DOMContentLoaded', function() {
            // Esta función se ejecutará cuando un custom select cambie de valor.
            // La hemos movido aquí para que esté en el mismo scope que las funciones de ayuda.
            window.handleCustomSelectChange = function(selectDiv) {
                const name = selectDiv.dataset.name;
                const value = document.querySelector(`input[name="${name}"]`).value;

                // Si el cambio es en un filtro de categoría, actualizamos las dependencias.
                if (['categoria_id', 'subcategoria_id', 'seudocategoria_id'].includes(name)) { // Cambio en una categoría
                    updateCategoryDependencies(name, value);
                } else if (name === 'marca') { // Cambio en la marca
                    updateDependenciesForBrand(value);
                } else { // Cualquier otro filtro
                    applyFilters();
                }
            };
        });

        /**
         * Actualiza los selectores de categorías dependientes y las marcas.
         * @param {string} level - El nivel de la categoría que cambió ('categoria_id', 'subcategoria_id', 'seudocategoria_id').
         * @param {string} id - El ID de la categoría seleccionada.
         */
        async function updateCategoryDependencies(level, id, applyFiltersAfter = true) {
            const mainCatSelect = document.querySelector('#filtersPanel .custom-select[data-name="categoria_id"]');
            const subCatSelect = document.querySelector('#filtersPanel .custom-select[data-name="subcategoria_id"]');
            const pseudoCatSelect = document.querySelector('#filtersPanel .custom-select[data-name="seudocategoria_id"]');
            const brandSelect = document.querySelector('#filtersPanel .custom-select[data-name="marca"]');

            // Si se deselecciona una categoría (se elige "Todas"), reseteamos las dependencias.
            if (!id) {
                // MEJORA PROFESIONAL: Lógica de reseteo más robusta.
                // Cuando se quita un filtro de categoría, no solo se resetean los hijos,
                // sino que también se debe recargar la lista completa de marcas.
                if (level === 'categoria_id') {
                    resetCategoryVisibility(false, true, true);
                    setCustomSelectValue(subCatSelect, "");
                    setCustomSelectValue(pseudoCatSelect, "");
                } else if (level === 'subcategoria_id') {
                    // Si se quita la subcategoría, las seudocategorías se resetean.
                    // Las categorías principales ya se muestran todas por la lógica anterior.
                    resetCategoryVisibility(false, false, true);
                    setCustomSelectValue(pseudoCatSelect, "");
                } else if (level === 'seudocategoria_id') {
                    // Si se quita la seudocategoría, no hay hijos que resetear.
                    // Las categorías principales y subcategorías ya se muestran todas.
                } else if (level === 'seudocategoria_id') {
                    // No hay hijos que resetear
                }
                // El endpoint sin ID devolverá todas las marcas, así que las recargamos.
                await updateBrandOptions(); // Recarga la lista completa de marcas.
                if (applyFiltersAfter) {
                    applyFilters();
                }
                return;
            }

            try {
                const response = await fetch(`/admin/api/products/category-dependencies?level=${level}&id=${id}`);
                if (!response.ok) throw new Error('Error en la respuesta de la API');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message);

                // 1. Pre-seleccionar padres
                if (data.main_category_id && level !== 'categoria_id') {
                    setCustomSelectValue(mainCatSelect, data.main_category_id);
                }
                if (data.sub_category_id && level !== 'subcategoria_id') {
                    setCustomSelectValue(subCatSelect, data.sub_category_id);
                }

                // 2. Filtrar hijos
                // Si el cambio fue en una categoría principal, filtramos las sub y seudo.
                if (level === 'categoria_id') {
                    filterOptions(subCatSelect, data.sub_category_ids);
                    filterOptions(pseudoCatSelect, data.pseudo_category_ids);
                // Si el cambio fue en una subcategoría, solo filtramos las seudo.
                } else if (level === 'subcategoria_id') {
                    resetCategoryVisibility(true, false, false); // Mostrar todas las principales
                    filterOptions(pseudoCatSelect, data.pseudo_category_ids);
                // Si el cambio fue en una seudocategoría, no hay hijos que filtrar, solo padres que preseleccionar.
                } else if (level === 'seudocategoria_id') {
                    resetCategoryVisibility(true, true, false); // Mostrar todas las principales y sub
                }

                // 3. Actualizar marcas
                await updateBrandOptions(data.brands);

                // --- MEJORA PROFESIONAL: Limpiar filtros hijos si ya no son válidos ---
                // Después de filtrar las opciones, verificamos si la selección actual sigue siendo válida.
                if (level === 'categoria_id') {
                    const subCatValue = subCatSelect.querySelector('input[type="hidden"]').value;
                    if (subCatValue && !data.sub_category_ids.includes(subCatValue)) {
                        setCustomSelectValue(subCatSelect, ""); // Limpiar subcategoría
                        setCustomSelectValue(pseudoCatSelect, ""); // Limpiar seudocategoría también
                    }
                }
                if (level === 'categoria_id' || level === 'subcategoria_id') {
                    const pseudoCatValue = pseudoCatSelect.querySelector('input[type="hidden"]').value;
                    if (pseudoCatValue && !data.pseudo_category_ids.includes(pseudoCatValue)) {
                        setCustomSelectValue(pseudoCatSelect, ""); // Limpiar seudocategoría
                    }
                }

                // --- MEJORA PROFESIONAL: Limpiar filtro de marca si ya no es válido ---
                const brandValue = brandSelect.querySelector('input[type="hidden"]').value;
                if (brandValue && !data.brands.includes(brandValue)) {
                    setCustomSelectValue(brandSelect, ""); // Limpiar marca
                }

                if (applyFiltersAfter) {
                    applyFilters();
                }

            } catch (error) {
                console.error('Error al actualizar dependencias de categorías:', error);
                window.toast.error('No se pudieron actualizar los filtros de categoría.');
            }
        }

        /**
         * Actualiza los selectores de categorías cuando se selecciona una marca.
         * @param {string} brandName - El nombre de la marca seleccionada.
         */
        async function updateDependenciesForBrand(brandName) {
            const mainCatSelect = document.querySelector('#filtersPanel .custom-select[data-name="categoria_id"]');
            const subCatSelect = document.querySelector('#filtersPanel .custom-select[data-name="subcategoria_id"]');
            const pseudoCatSelect = document.querySelector('#filtersPanel .custom-select[data-name="seudocategoria_id"]');

            if (!brandName) {
                // MEJORA PROFESIONAL: Lógica de reseteo completa.
                // Si se quita el filtro de marca, es crucial resetear la visibilidad
                // de TODAS las categorías para que vuelvan a mostrar su lista completa.
                resetCategoryVisibility(true, true, true);
                applyFilters();
                return;
            }

            try {
                const response = await fetch(`/admin/api/products/category-dependencies?level=marca&id=${encodeURIComponent(brandName)}`);
                if (!response.ok) throw new Error('Error en la respuesta de la API de marcas');

                const data = await response.json();
                if (!data.success) throw new Error(data.message);

                // Filtrar las opciones de todas las categorías basadas en los IDs devueltos
                filterOptions(mainCatSelect, data.main_category_ids);
                filterOptions(subCatSelect, data.sub_category_ids);
                filterOptions(pseudoCatSelect, data.pseudo_category_ids);

                // Limpiar selecciones de categoría si ya no son válidas
                const mainCatValue = mainCatSelect.querySelector('input[type="hidden"]').value;
                if (mainCatValue && !data.main_category_ids.includes(mainCatValue)) setCustomSelectValue(mainCatSelect, "");

                const subCatValue = subCatSelect.querySelector('input[type="hidden"]').value;
                if (subCatValue && !data.sub_category_ids.includes(subCatValue)) setCustomSelectValue(subCatSelect, "");

                const pseudoCatValue = pseudoCatSelect.querySelector('input[type="hidden"]').value;
                if (pseudoCatValue && !data.pseudo_category_ids.includes(pseudoCatValue)) setCustomSelectValue(pseudoCatSelect, "");

                applyFilters();
            } catch (error) {
                console.error('Error al actualizar dependencias para la marca:', error);
                window.toast.error('No se pudieron actualizar los filtros para la marca seleccionada.');
            }
        }

        /**
         * Filtra las opciones de un custom select para mostrar solo las que están en una lista de IDs.
         * @param {HTMLElement} selectElement - El elemento .custom-select.
         * @param {string[]} allowedIds - Array de IDs que se deben mostrar.
         */
        function filterOptions(selectElement, allowedIds) {
            const options = selectElement.querySelectorAll('.custom-select-option');
            let hasVisibleOptions = false;
            options.forEach(option => {
                const value = option.dataset.value;
                if (value === "") { // La opción "Todas" siempre se muestra
                    option.style.display = 'block';
                } else if (value) {
                    option.style.display = allowedIds.includes(value) ? 'block' : 'none';
                }
            });
        }

        /**
         * Restablece la visibilidad de las opciones en los selectores de categoría.
         * @param {boolean} main - ¿Restablecer categorías principales?
         * @param {boolean} sub - ¿Restablecer subcategorías?
         * @param {boolean} pseudo - ¿Restablecer seudocategorías?
         */
        function resetCategoryVisibility(main, sub, pseudo) {
            if (main) {
                document.querySelectorAll('#filtersPanel .custom-select[data-name="categoria_id"] .custom-select-option').forEach(opt => opt.style.display = 'block');
            }
            if (sub) {
                document.querySelectorAll('#filtersPanel .custom-select[data-name="subcategoria_id"] .custom-select-option').forEach(opt => opt.style.display = 'block');
            }
            if (pseudo) {
                document.querySelectorAll('#filtersPanel .custom-select[data-name="seudocategoria_id"] .custom-select-option').forEach(opt => opt.style.display = 'block');
            }
        }

        /**
         * Actualiza las opciones del selector de marcas.
         * @param {string[]} brands - Array con los nombres de las marcas a mostrar.
         */
        async function updateBrandOptions(brands) {
            const brandSelect = document.querySelector('#filtersPanel .custom-select[data-name="marca"]');
            if (!brandSelect) return;
            const optionsContainer = brandSelect.querySelector('.custom-select-options');
            const hiddenInput = brandSelect.querySelector('input[type="hidden"]');
            const currentBrandValue = hiddenInput ? hiddenInput.value : '';

            let brandsToShow = brands;
 
            // Si no se proporcionan marcas, las obtenemos de la API.
            if (!brands) {
                // Llamada sin parámetros para obtener todas las marcas
                const response = await fetch('/admin/api/products/category-dependencies');
                const data = await response.json();
                if (data.success) {
                    brandsToShow = data.brands;
                } else {
                    brandsToShow = [];
                }
            }

            let newOptionsHtml = '<div class="custom-select-option" data-value="">Todas</div>';
            if (brandsToShow) {
                brandsToShow.forEach(brand => {
                    newOptionsHtml += `<div class="custom-select-option" data-value="${brand}">${brand}</div>`;
                });
            }

            optionsContainer.innerHTML = newOptionsHtml;

            // Re-seleccionar el valor actual si todavía existe en las nuevas opciones.
            setCustomSelectValue(brandSelect, currentBrandValue);
        }

        /**
         * Establece el valor de un custom select programáticamente.
         * @param {HTMLElement} selectElement - El elemento .custom-select.
         * @param {string} value - El valor a seleccionar.
         */
        function setCustomSelectValue(selectElement, value) {
            // MEJORA PROFESIONAL: Añadir una guarda para prevenir errores si el elemento no existe.
            // Esto soluciona el error "TypeError: Cannot set properties of null".
            if (!selectElement) return;
            const hiddenInput = selectElement.querySelector('input[type="hidden"]');
            // MEJORA PROFESIONAL: Añadir una segunda guarda para el input oculto.
            if (!hiddenInput) return;
            const valueDisplay = selectElement.querySelector('.custom-select-value');
            const options = selectElement.querySelectorAll('.custom-select-option');

            hiddenInput.value = value;

            let found = false;
            options.forEach(option => {
                if (option.dataset.value === value) {
                    option.classList.add('selected');
                    valueDisplay.textContent = option.textContent.trim();
                    found = true;
                } else {
                    option.classList.remove('selected');
                }
            });

            if (!found) {
                const allOption = selectElement.querySelector('.custom-select-option[data-value=""]');
                if (allOption) {
                    allOption.classList.add('selected');
                    valueDisplay.textContent = allOption.textContent.trim();
                }
            }
        }
    </script>
    {% if error_message %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.toast.error('{{ error_message }}');
        });
    </script>
    {% endif %}
{% endblock %}