{% extends 'admin/page/base.html' %}

{% block content %}
<!-- Este template se cargará dentro del contenedor principal del SPA -->
<div id="usuarios-view" class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <header class="mb-8 fade-in">
        <div class="text-center">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent mb-3">
                Gestión de Usuarios
            </h1>
            <p class="text-gray-600 text-lg max-w-2xl mx-auto">
                Sistema profesional para administrar clientes y administradores con interfaz moderna
            </p>
        </div>
    </header>

    <!-- Stats Cards - Posicionados profesionalmente en la parte superior -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 fade-in">
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                    <i class="fas fa-users text-2xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Total Clientes</p>
                    <p id="total-clientes-count" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                    <i class="fas fa-user-check text-2xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Clientes Activos</p>
                    <p id="active-clientes-count" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Administradores</p>
                    <p id="total-admins-count" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-8 fade-in">
        <div class="flex justify-center">
            <div class="inline-flex p-1 bg-white rounded-xl shadow-lg border border-gray-200">
                <button id="clientes-tab" class="px-6 py-3 text-sm font-semibold rounded-lg transition-all duration-300 bg-blue-600 text-white shadow-md">
                    <i class="fas fa-users mr-2"></i>Clientes
                </button>
                <button id="administradores-tab" class="px-6 py-3 text-sm font-semibold rounded-lg transition-all duration-300 text-gray-600 hover:text-gray-800">
                    <i class="fas fa-user-shield mr-2"></i>Administradores
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Status Filter -->
    <div class="mb-8 fade-in max-w-4xl mx-auto">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400 text-lg"></i>
                </div>
                <input type="text" id="search-input" placeholder="Buscar por nombre, apellido o teléfono..." class="w-full pl-12 pr-4 py-4 text-lg border-0 rounded-2xl shadow-lg focus:ring-4 focus:ring-blue-500/20 focus:outline-none transition-all duration-300 bg-white search-input">
            </div>
            <div class="w-full md:w-auto">
                <select id="status-filter" class="w-full px-4 py-4 text-lg border-0 rounded-2xl shadow-lg focus:ring-4 focus:ring-blue-500/20 focus:outline-none transition-all duration-300 bg-white">
                    <option value="">Todos los estados</option>
                    <option value="activo">Activo</option>
                    <option value="inactivo">Inactivo</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Clientes Section -->
    <div id="clientes-section" class="fade-in">
        <!-- Clientes Table with Static Header and Dynamic Body -->
        <div class="table-container bg-white overflow-hidden mb-8 shadow-xl">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Lista de Clientes</h3>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-table mr-1"></i> Tabla de datos
                        </span>
                    </div>
                </div>
            </div>
            <table class="w-full">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Nombre</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Apellido</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Teléfono</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Estado</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientes-table-body" class="divide-y divide-gray-100">
                    <!-- Initial Loading Skeleton -->
                    <tr class="loading-row">
                        <td colspan="5" class="px-8 py-16 text-center" data-col-span="5">
                            <div class="flex justify-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-600"></div>
                            </div>
                            <p class="mt-4 text-gray-600">Cargando clientes...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="clientes-pagination" class="flex items-center justify-between fade-in bg-white p-4 rounded-xl shadow">
            <div class="text-base text-gray-700 font-medium">
                <span id="clientes-current-range" class="font-bold text-blue-600">0-0</span> de <span id="clientes-total" class="font-bold">0</span> resultados
            </div>
            <div class="flex gap-3">
                <button id="clientes-prev" class="pagination-button px-5 py-2.5 border border-gray-300 rounded-xl text-base font-medium text-gray-700 bg-white hover:bg-blue-600 hover:text-white" disabled>
                    <i class="fas fa-chevron-left mr-2"></i>Anterior
                </button>
                <div id="clientes-page-numbers" class="flex gap-2"></div>
                <button id="clientes-next" class="pagination-button px-5 py-2.5 border border-gray-300 rounded-xl text-base font-medium text-gray-700 bg-white hover:bg-blue-600 hover:text-white" disabled>
                    Siguiente<i class="fas fa-chevron-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Administradores Section -->
    <div id="administradores-section" class="hidden fade-in">
        <!-- Administradores Table with Static Header and Dynamic Body -->
        <div class="table-container bg-white overflow-hidden mb-8 shadow-xl">
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Lista de Administradores</h3>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                            <i class="fas fa-shield-alt mr-1"></i> Acceso privilegiado
                        </span>
                    </div>
                </div>
            </div>
            <table class="w-full">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Nombre</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Apellido</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Cédula</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Teléfono</th>
                        <th class="px-8 py-5 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="administradores-table-body" class="divide-y divide-gray-100">
                    <!-- Initial Loading Skeleton -->
                    <tr class="loading-row">
                        <td colspan="5" class="px-8 py-16 text-center" data-col-span="5">
                            <div class="flex justify-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-600"></div>
                            </div>
                            <p class="mt-4 text-gray-600">Cargando administradores...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="administradores-pagination" class="flex items-center justify-between fade-in bg-white p-4 rounded-xl shadow">
            <div class="text-base text-gray-700 font-medium">
                <span id="administradores-current-range" class="font-bold text-blue-600">0-0</span> de <span id="administradores-total" class="font-bold">0</span> resultados
            </div>
            <div class="flex gap-3">
                <button id="administradores-prev" class="pagination-button px-5 py-2.5 border border-gray-300 rounded-xl text-base font-medium text-gray-700 bg-white hover:bg-blue-600 hover:text-white" disabled>
                    <i class="fas fa-chevron-left mr-2"></i>Anterior
                </button>
                <div id="administradores-page-numbers" class="flex gap-2"></div>
                <button id="administradores-next" class="pagination-button px-5 py-2.5 border border-gray-300 rounded-xl text-base font-medium text-gray-700 bg-white hover:bg-blue-600 hover:text-white" disabled>
                    Siguiente<i class="fas fa-chevron-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button id="add-user-btn" class="fixed bottom-8 right-8 w-16 h-16 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-110 z-40 flex items-center justify-center">
    <i class="fas fa-plus text-xl"></i>
</button>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto fade-in transform transition-all duration-300">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Nuevo Cliente</h2>
            <button id="close-modal" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center transition-colors duration-200">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <form id="user-form" class="p-6 space-y-5">
            <input type="hidden" id="user-id">
            <input type="hidden" id="user-type">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre</label>
                    <input type="text" id="user-name" name="nombre" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-600 transition-all duration-200">
                    <p class="error-message text-xs text-red-500 mt-1 hidden"></p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Apellido</label>
                    <input type="text" id="user-lastname" name="apellido" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-600 transition-all duration-200">
                    <p class="error-message text-xs text-red-500 mt-1 hidden"></p>
                </div>
            </div>
            
            <!-- Campo de Cédula (solo para administradores) -->
            <div id="cedula-field-container" class="hidden">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Cédula</label>
                <input type="text" id="user-identification" name="cedula" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-600 transition-all duration-200" placeholder="Ej: 123456789">
                <p class="error-message text-xs text-red-500 mt-1 hidden"></p>
            </div>
            
            <!-- Campos comunes -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Teléfono</label>
                <input type="tel" id="user-phone" name="numero" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-600 transition-all duration-200" placeholder="Ej: 3101234567">
                <p class="error-message text-xs text-red-500 mt-1 hidden"></p>
            </div>
            
            <div>
                <label for="user-password" class="block text-sm font-semibold text-gray-700 mb-2">Contraseña</label>
                <div class="relative">
                    <input type="password" id="user-password" name="contraseña" class="w-full px-4 py-3 pr-10 border border-gray-200 rounded-xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-600 transition-all duration-200" placeholder="Mínimo 8 caracteres">
                    <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-blue-600 transition-colors" aria-label="Mostrar contraseña">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p id="password-helper-text" class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    <!-- El texto se actualizará dinámicamente -->
                </p>
                <p class="error-message text-xs text-red-500 mt-1 hidden"></p>
            </div>
            
            <div class="flex gap-3 pt-2">
                <button type="button" id="cancel-btn" class="flex-1 px-5 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-semibold transition-colors duration-200">
                    Cancelar
                </button>
                <button type="submit" id="save-btn" class="flex-1 px-5 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl hover:from-cyan-500 hover:to-blue-600 font-semibold transition-all duration-300 transform hover:scale-105">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Notification Toast -->
<div id="notification" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 transform translate-x-full transition-transform duration-300 max-w-md z-50">
    <div class="flex items-center">
        <div id="notification-icon" class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3">
            <!-- Icon will be set by JavaScript -->
        </div>
        <div>
            <h4 id="notification-title" class="font-semibold text-gray-800"></h4>
            <p id="notification-message" class="text-sm text-gray-600"></p>
        </div>
    </div>
</div>

<script>
    // Este script se ejecutará cada vez que se cargue la vista
    // y es compatible con el sistema SPA
    
    //  Usar un patrón de módulo que se autogestione en el ciclo de vida del SPA.
    // Esto evita duplicación de listeners y fugas de memoria.
    if (!window.usuariosApp) {
        // La clase solo se define una vez.
        class UsuariosApp {
            constructor() {
                // Global variables
                this.currentTab = 'clientes';
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.filters = {
                    search: '',
                    status: ''
                };
                
                // Control de estado para SPA
                this.isInitialized = false;
                this.eventListeners = []; // Para limpiar listeners
                this.activeTimers = []; // Para limpiar timers (setInterval/setTimeout)
                this.isInitialOpen = false; // SOLUCIÓN: Bandera para controlar la validación inicial.
                this.csrfToken = null; //  Cachear el token CSRF
                // DOM Elements
                this.clientesSection = null;
                this.administradoresSection = null;
                this.clientesTab = null;
                this.administradoresTab = null;
                this.modal = null;
                this.userForm = null;
                this.modalTitle = null;
                this.clienteFields = null;
                this.addUserBtn = null;
                this.notification = null;
                this.viewContainer = null;
                // Cachear todos los elementos del formulario para evitar búsquedas repetitivas.
                this.userIdInput = null;
                this.userTypeInput = null;
                this.userNameInput = null;
                this.userLastnameInput = null;
                this.cedulaContainer = null;
                this.userIdentificationInput = null;
                this.userPhoneInput = null;
                this.passwordInput = null;
                this.saveButton = null;

                //  Constantes para validación
                this.validationPatterns = {
                    phone: /^[0-9]{10}$/,
                    cedula: /^[0-9]{7,10}$/
                };
                
                // Bind methods to maintain 'this' context
                this.init = this.init.bind(this);
                this.setupDOMElements = this.setupDOMElements.bind(this);
                this.setupEventListeners = this.setupEventListeners.bind(this);
                this.loadInitialData = this.loadInitialData.bind(this);
                this.switchTab = this.switchTab.bind(this);
                this.applyFilters = this.applyFilters.bind(this);
                this.changePage = this.changePage.bind(this);
                this.loadClientes = this.loadClientes.bind(this);
                this.loadAdministradores = this.loadAdministradores.bind(this);
                this.loadStats = this.loadStats.bind(this);
                this.saveCliente = this.saveCliente.bind(this);
                this.saveAdministrador = this.saveAdministrador.bind(this);
                this.toggleClienteStatus = this.toggleClienteStatus.bind(this);
                this.showTableLoading = this.showTableLoading.bind(this);
                this.showTableError = this.showTableError.bind(this);
                this.renderClientesTable = this.renderClientesTable.bind(this);
                this.renderAdministradoresTable = this.renderAdministradoresTable.bind(this);
                this.renderPagination = this.renderPagination.bind(this);
                this.openModal = this.openModal.bind(this);
                this.closeModal = this.closeModal.bind(this);
                this.handleFormSubmit = this.handleFormSubmit.bind(this);
                this.showNotification = this.showNotification.bind(this);
                this.getCsrfToken = this.getCsrfToken.bind(this);
                this.debounce = this.debounce.bind(this);
                this.editCliente = this.editCliente.bind(this);
                this.editAdministrador = this.editAdministrador.bind(this);
                this.animateValue = this.animateValue.bind(this);
                this.togglePasswordVisibility = this.togglePasswordVisibility.bind(this);
                this.cleanup = this.cleanup.bind(this);
                this.updatePasswordHelperText = this.updatePasswordHelperText.bind(this);
                this.validateField = this.validateField.bind(this);
                this.setFieldError = this.setFieldError.bind(this);
                this.clearFieldError = this.clearFieldError.bind(this);
                this.handleActionClick = this.handleActionClick.bind(this);
            }
            
            init() {
                console.log("UsuariosApp.init() called");
                if (this.isInitialized) {
                    console.log("UsuariosApp already initialized. Skipping.");
                    return;
                }
                try {
                    this.setupDOMElements();
                    this.setupEventListeners();
                    this.csrfToken = this.getCsrfToken(); // Obtener el token una sola vez.
                    this.loadInitialData();
                    this.isInitialized = true;
                } catch (error) {
                    console.error("Error initializing UsuariosApp:", error);
                    this.showNotification('error', 'Error de inicialización', 'No se pudo inicializar la aplicación de usuarios');
                }
            }

            setupDOMElements() {
                console.log("Setting up DOM elements");
                this.viewContainer = document.getElementById('usuarios-view');
                if (!this.viewContainer) throw new Error("Main view container #usuarios-view not found.");

                this.clientesSection = this.viewContainer.querySelector('#clientes-section');
                this.administradoresSection = this.viewContainer.querySelector('#administradores-section');
                this.clientesTab = this.viewContainer.querySelector('#clientes-tab');
                this.administradoresTab = this.viewContainer.querySelector('#administradores-tab');
                // SOLUCIÓN: El modal y sus componentes están fuera de #usuarios-view, por lo que se buscan en `document`.
                this.modal = document.getElementById('modal');
                this.userForm = document.getElementById('user-form');
                this.modalTitle = document.getElementById('modal-title');
                // SOLUCIÓN: El botón de agregar es global, no está dentro de la vista.
                this.addUserBtn = document.getElementById('add-user-btn');
                this.notification = document.getElementById('notification'); // SOLUCIÓN: La notificación también es global.
                
                // Cachear todos los elementos del formulario aquí.
                this.userIdInput = document.getElementById('user-id');
                this.userTypeInput = document.getElementById('user-type');
                this.userNameInput = document.getElementById('user-name');
                this.userLastnameInput = document.getElementById('user-lastname');
                this.cedulaContainer = document.getElementById('cedula-field-container');
                this.userIdentificationInput = document.getElementById('user-identification');
                this.userPhoneInput = document.getElementById('user-phone');
                this.passwordInput = document.getElementById('user-password');
                this.saveButton = document.getElementById('save-btn');
                
                if (!this.clientesSection) console.error("clientes-section element not found");
                if (!this.administradoresSection) console.error("administradores-section element not found");
                if (!this.clientesTab) console.error("clientes-tab element not found");
                if (!this.administradoresTab) console.error("administradores-tab element not found");
            }

            // Helper para registrar y limpiar listeners
            _addEventListener(element, type, listener) {
                if (!element) {
                    console.warn(`Attempted to add listener to a null element for event type: ${type}`);
                    return;
                }
                element.addEventListener(type, listener);
                this.eventListeners.push({ element, type, listener });
            }
            
            setupEventListeners() {
                console.log("Setting up event listeners");
                
                // Tab switching
                this._addEventListener(this.clientesTab, 'click', () => this.switchTab('clientes'));
                this._addEventListener(this.administradoresTab, 'click', () => this.switchTab('administradores'));
        
                // Modal controls
                this._addEventListener(this.addUserBtn, 'click', () => this.openModal(this.currentTab === 'clientes' ? 'cliente' : 'admin'));
                this._addEventListener(document.getElementById('close-modal'), 'click', this.closeModal);
                this._addEventListener(document.getElementById('cancel-btn'), 'click', this.closeModal);
        
                // Form submission
                this._addEventListener(this.userForm, 'submit', this.handleFormSubmit);
        
                // Search and status filter with debounce
                const searchInput = this.viewContainer.querySelector('#search-input');
                this._addEventListener(searchInput, 'input', this.debounce((e) => {
                    this.filters.search = e.target.value;
                    this.currentPage = 1;
                    this.applyFilters();
                }, 300));
                
                const statusFilter = this.viewContainer.querySelector('#status-filter');
                this._addEventListener(statusFilter, 'change', (e) => {
                    //  Asegurarse de que el filtro de estado solo se aplique a la pestaña de clientes
                    if (this.currentTab !== 'clientes') {
                        return;
                    }
                    this.filters.status = e.target.value;
                    this.currentPage = 1;
                    this.applyFilters();
                });
        
                // Pagination
                this._addEventListener(this.viewContainer, 'click', this.handleActionClick);

                // Password visibility toggle
                const togglePasswordBtn = document.getElementById('toggle-password-visibility');
                this._addEventListener(togglePasswordBtn, 'click', this.togglePasswordVisibility);

                // Listeners de validación en tiempo real para el formulario
                const formInputs = this.userForm.querySelectorAll('input');
                formInputs.forEach(input => {
                    this._addEventListener(input, 'blur', () => this.validateField(input));
                    this._addEventListener(input, 'input', this.debounce(() => this.validateField(input), 500));
                    // Listener para actualizar el helper de la contraseña.
                    if (input.name === 'nombre' || input.name === 'numero') {
                        this._addEventListener(input, 'input', this.debounce(this.updatePasswordHelperText, 300));
                    }
                    // Ocultar/mostrar el helper de la contraseña al escribir en el campo.
                    if (input.name === 'contraseña') {
                        this._addEventListener(input, 'input', this.debounce(this.updatePasswordHelperText, 300));
                    }
                });
            }

            // Limpiar todos los event listeners para evitar fugas de memoria en el SPA.
            cleanup() {
                console.log("Cleaning up UsuariosApp listeners.");
                this.eventListeners.forEach(({ element, type, listener }) => {
                    // Asegurarse de que el elemento todavía existe antes de remover el listener.
                    if (element) {
                        element.removeEventListener(type, listener);
                    }
                });
                this.eventListeners = [];
                //  Limpiar también todos los temporizadores activos.
                this.activeTimers.forEach(timerId => clearInterval(timerId));
                this.activeTimers = []; // Limpiar el array

                this.isInitialized = false;
                console.log("Cleanup complete.");
            }
            
            loadInitialData() {
                console.log("Loading initial data");
                // Load initial data for both tabs
                this.loadClientes();
                this.loadAdministradores();
                this.loadStats();
            }
            
            switchTab(tab) {
                console.log(`Switching to tab: ${tab}`);
                this.currentTab = tab;
                this.currentPage = 1;
                
                if (tab === 'clientes') {
                    if (this.clientesSection && this.administradoresSection) {
                        this.clientesSection.classList.remove('hidden');
                        this.administradoresSection.classList.add('hidden');
                    }
                    
                    if (this.clientesTab && this.administradoresTab) {
                        this.clientesTab.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                        this.clientesTab.classList.remove('text-gray-600', 'bg-white');
                        this.administradoresTab.classList.add('text-gray-600', 'bg-white');
                        this.administradoresTab.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    }
                    
                    const statusFilter = this.viewContainer.querySelector('#status-filter');
                    if (statusFilter) {
                        statusFilter.classList.remove('hidden');
                    }
                } else {
                    if (this.administradoresSection && this.clientesSection) {
                        this.administradoresSection.classList.remove('hidden');
                        this.clientesSection.classList.add('hidden');
                    }
                    
                    if (this.administradoresTab && this.clientesTab) {
                        this.administradoresTab.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                        this.administradoresTab.classList.remove('text-gray-600', 'bg-white');
                        this.clientesTab.classList.add('text-gray-600', 'bg-white');
                        this.clientesTab.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    }
                    
                    const statusFilter = this.viewContainer.querySelector('#status-filter');
                    if (statusFilter) {
                        statusFilter.classList.add('hidden');
                    }
                }
            }
            
            applyFilters() {
                console.log("Applying filters");
                if (this.currentTab === 'clientes') {
                    this.loadClientes();
                } else {
                    this.loadAdministradores();
                }
            }

            handleActionClick(e) {
                // Hacer el manejador de eventos más específico y eficiente.
                const actionButton = e.target.closest('button[data-action]');
                if (!actionButton) return;

                e.preventDefault(); // Prevenir comportamiento por defecto

                const action = actionButton.dataset.action;
                const id = actionButton.dataset.id;
                const page = actionButton.dataset.page;
                const type = actionButton.dataset.type;

                switch(action) {
                    case 'toggle-status':
                        if (id) this.toggleClienteStatus(id);
                        break;
                    case 'edit-cliente':
                        this.editCliente(id);
                        break;
                    case 'edit-admin':
                        this.editAdministrador(id);
                        break;
                    case 'change-page':
                        if (type && page) this.changePage(type, parseInt(page));
                }
            }
            
            changePage(tab, page) {
                console.log(`Changing page to: ${tab}, ${page}`);
                if (page < 1) return;
                this.currentPage = page;
                
                if (tab === 'clientes') {
                    this.loadClientes();
                } else {
                    this.loadAdministradores();
                }
            }
            
            // API Functions
            loadClientes() {
                console.log("Loading clientes");
                this.showTableLoading('clientes');
                
                const queryParams = new URLSearchParams({
                    page: this.currentPage,
                    per_page: this.itemsPerPage,
                    search: this.filters.search,
                    status: this.filters.status
                });
                
                fetch(`/api/usuarios?${queryParams}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Clientes data received:", data);
                        if (data.success) {
                            this.renderClientesTable(data.usuarios);
                            this.renderPagination('clientes', data.pagination);
                        } else {
                            this.showTableError('clientes', data.message || 'No se pudieron cargar los clientes');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading clientes:', error);
                        this.showTableError('clientes', 'Error al cargar los clientes');
                    });
            }
            
            loadAdministradores() {
                console.log("Loading administradores");
                this.showTableLoading('administradores');
                
                const queryParams = new URLSearchParams({
                    page: this.currentPage,
                    per_page: this.itemsPerPage,
                    search: this.filters.search
                });
                
                fetch(`/api/admins?${queryParams}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Administradores data received:", data);
                        if (data.success) {
                            this.renderAdministradoresTable(data.admins);
                            this.renderPagination('administradores', data.pagination);
                        } else {
                            this.showTableError('administradores', data.message || 'No se pudieron cargar los administradores');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading administradores:', error);
                        this.showTableError('administradores', 'Error al cargar los administradores');
                    });
            }
            
            loadStats() {
                console.log("Loading stats");
                fetch('/api/stats/usuarios')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Stats data received:", data);
                        if (data.success) {
                            // Animación de contador para las estadísticas
                            this.animateValue('total-clientes-count', 0, data.total_clientes || 0, 1000);
                            this.animateValue('active-clientes-count', 0, data.clientes_activos || 0, 1000);
                            this.animateValue('total-admins-count', 0, data.total_admins || 0, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading stats:', error);
                    });
            }
            
            animateValue(id, start, end, duration) {
                console.log(`Animating value for ${id} from ${start} to ${end}`);
                const obj = this.viewContainer.querySelector(`#${id}`);
                if (!obj) {
                    console.error(`Element with id ${id} not found`);
                    return;
                }
                
                const startTimestamp = performance.now();
                const range = end - start;
                
                const run = () => {
                    const elapsed = performance.now() - startTimestamp;
                    const progress = Math.min(elapsed / duration, 1);
                    const currentValue = Math.floor(progress * range + start);
                    
                    obj.textContent = currentValue;
                    
                    if (progress < 1) {
                        requestAnimationFrame(run);
                    } else {
                        obj.textContent = end; // Asegurar el valor final exacto
                    }
                };
                
                // Usar requestAnimationFrame para animaciones suaves y eficientes
                requestAnimationFrame(run);
            }
            
            saveCliente(clienteData) {
                console.log("Saving cliente:", clienteData);
                const isEdit = !!clienteData.id;
                const url = isEdit ? `/api/usuarios/${clienteData.id}` : '/api/usuarios';
                const method = isEdit ? 'PUT' : 'POST';
                
                fetch(url, { // La intercepción de admin_auth_interceptor.js añade el token
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clienteData)
                })
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(data => {
                    console.log("Save cliente response:", data);
                    if (data.status >= 200 && data.status < 300) {
                        this.showNotification('success', 'Éxito', isEdit ? 'Cliente actualizado correctamente' : 'Cliente creado correctamente');
                        this.loadClientes();
                        this.loadStats();
                        this.closeModal();
                    } else {
                        //  Manejo de errores específicos del backend.
                        const errorMessage = data.body.message || 'No se pudo guardar el cliente';
                        if (data.status === 409) { // 409 Conflict (duplicado)
                            if (errorMessage.includes('número de teléfono')) {
                                this.setFieldError(this.userPhoneInput, errorMessage);
                            } else {
                                this.showNotification('error', 'Error de Duplicado', errorMessage);
                            }
                        } else if (data.status === 400) { // 400 Bad Request (datos inválidos)
                            this.showNotification('error', 'Datos Inválidos', errorMessage);
                        } else {
                            this.showNotification('error', 'Error', errorMessage);
                        }
                        if (this.saveButton) this.saveButton.disabled = false; //  Reactivar botón en error
                    }
                })
                .catch(error => {
                    console.error('Error saving cliente:', error);
                    this.showNotification('error', 'Error', 'No se pudo guardar el cliente');
                    if (this.saveButton) this.saveButton.disabled = false; //  Reactivar botón en error
                });
            }

            // ... (el resto de la función saveAdministrador se modifica de forma similar)


            saveAdministrador(adminData) {
                console.log("Saving administrador:", adminData);
                const isEdit = !!adminData.id;
                const url = isEdit ? `/api/admins/${adminData.id}` : '/api/admins';
                const method = isEdit ? 'PUT' : 'POST';
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(adminData)
                })
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(data => {
                    console.log("Save administrador response:", data);
                    if (data.status >= 200 && data.status < 300) {
                        this.showNotification('success', 'Éxito', isEdit ? 'Administrador actualizado correctamente' : 'Administrador creado correctamente');
                        this.loadAdministradores();
                        this.loadStats();
                        this.closeModal();
                    } else {
                        // Manejo de errores específicos del backend.
                        const errorMessage = data.body.message || 'No se pudo guardar el administrador';
                        if (data.status === 409) { // 409 Conflict (duplicado)
                            if (errorMessage.includes('cédula')) {
                                this.setFieldError(this.userIdentificationInput, errorMessage);
                            } else if (errorMessage.includes('teléfono')) {
                                this.setFieldError(this.userPhoneInput, errorMessage);
                            } else {
                                this.showNotification('error', 'Error de Duplicado', errorMessage);
                            }
                        } else {
                            this.showNotification('error', 'Error', errorMessage);
                        }
                        if (this.saveButton) this.saveButton.disabled = false; //  Reactivar botón en error
                    }
                })
                .catch(error => {
                    console.error('Error saving administrador:', error);
                    this.showNotification('error', 'Error', 'No se pudo guardar el administrador');
                    if (this.saveButton) this.saveButton.disabled = false; //  Reactivar botón en error
                });
            }

            toggleClienteStatus(clienteId) {
                console.log("Toggling cliente status for:", clienteId);
                fetch(`/api/usuarios/${clienteId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                        // 'X-CSRFToken' no es necesario para PUT
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Toggle status response:", data);
                    if (data.success) {
                        this.showNotification('success', 'Éxito', 'Estado del cliente actualizado correctamente');
                        this.loadClientes();
                        this.loadStats();
                    } else {
                        this.showNotification('error', 'Error', data.message || 'No se pudo actualizar el estado del cliente');
                    }
                })
                .catch(error => {
                    console.error('Error toggling cliente status:', error);
                    this.showNotification('error', 'Error', 'No se pudo actualizar el estado del cliente');
                });
            }
            
            // Table Rendering Functions
            showTableLoading(type) {
                console.log(`Showing table loading for ${type}`);
                const tbody = this.viewContainer.querySelector(`#${type}-table-body`);
                if (!tbody) {
                    console.error(`Table body for ${type} not found`);
                    return;
                }
                const colspan = type === 'clientes' ? 5 : 5;
                
                tbody.innerHTML = `
                    <tr class="loading-row">
                        <td colspan="${colspan}" class="px-8 py-16 text-center">
                            <div class="flex justify-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-600"></div>
                            </div>
                            <p class="mt-4 text-gray-600">Cargando ${type === 'clientes' ? 'clientes' : 'administradores'}...</p>
                        </td>
                    </tr>
                `;
            }
            
            showTableError(type, message) {
                console.log(`Showing table error for ${type}: ${message}`);
                const tbody = this.viewContainer.querySelector(`#${type}-table-body`);
                if (!tbody) {
                    console.error(`Table body for ${type} not found`);
                    return;
                }
                const colspan = type === 'clientes' ? 5 : 5;
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="px-8 py-16 text-center">
                            <div class="text-red-500">
                                <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                                <p class="text-lg font-medium">${message}</p>
                                <button data-action="retry-load" data-type="${type}" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    Reintentar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            renderClientesTable(clientes) {
                console.log("Rendering clientes table");
                const tbody = this.viewContainer.querySelector('#clientes-table-body');
                if (!tbody) {
                    console.error("Clientes table body not found");
                    return;
                }
                
                if (!clientes || clientes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-8 py-16 text-center">
                                <div class="text-gray-500">
                                    <i class="fas fa-users text-3xl mb-3"></i>
                                    <p class="text-lg font-medium">No se encontraron clientes</p>
                                    <p class="mt-1">Intenta ajustar los filtros de búsqueda</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = clientes.map(cliente => `
                    <tr class="hover:bg-gray-50 transition-all duration-200 card-hover">
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-800 font-medium">${cliente.nombre}</td>
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-800 font-medium">${cliente.apellido}</td>
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-600">${cliente.numero}</td>
                        <td class="px-8 py-5 whitespace-nowrap">
                            <button data-action="toggle-status" data-id="${cliente.id}" class="${cliente.estado === 'activo' ? 'status-active' : 'status-inactive'}">
                                ${cliente.estado === 'activo' ? 'Activo' : 'Inactivo'}
                            </button>
                        </td>
                        <td class="px-8 py-5 whitespace-nowrap">
                            <button data-action="edit-cliente" data-id="${cliente.id}" class="action-btn text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit text-lg"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            renderAdministradoresTable(administradores) {
                console.log("Rendering administradores table");
                const tbody = this.viewContainer.querySelector('#administradores-table-body');
                if (!tbody) {
                    console.error("Administradores table body not found");
                    return;
                }
                
                if (!administradores || administradores.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-8 py-16 text-center">
                                <div class="text-gray-500">
                                    <i class="fas fa-user-shield text-3xl mb-3"></i>
                                    <p class="text-lg font-medium">No se encontraron administradores</p>
                                    <p class="mt-1">Intenta ajustar los filtros de búsqueda</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = administradores.map(admin => `
                    <tr class="hover:bg-gray-50 transition-all duration-200 card-hover">
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-800 font-medium">${admin.nombre}</td>
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-800 font-medium">${admin.apellido}</td>
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-600 font-mono">${admin.cedula}</td>
                        <td class="px-8 py-5 whitespace-nowrap text-base text-gray-600">${admin.numero_telefono}</td>
                        <td class="px-8 py-5 whitespace-nowrap">
                            <button data-action="edit-admin" data-id="${admin.id}" class="action-btn text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit text-lg"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            renderPagination(type, pagination) {
                console.log(`Rendering pagination for ${type}`);
                const currentRange = this.viewContainer.querySelector(`#${type}-current-range`);
                const totalSpan = this.viewContainer.querySelector(`#${type}-total`);
                
                if (!currentRange || !totalSpan) {
                    console.error(`Pagination elements for ${type} not found`);
                    return;
                }
                
                const startIndex = pagination.total === 0 ? 0 : (pagination.page - 1) * pagination.per_page + 1;
                const endIndex = Math.min(pagination.page * pagination.per_page, pagination.total);
                currentRange.textContent = `${startIndex}-${endIndex}`;
                totalSpan.textContent = pagination.total;
                
                const prevBtn = this.viewContainer.querySelector(`#${type}-prev`);
                const nextBtn = this.viewContainer.querySelector(`#${type}-next`);
                
                if (prevBtn) {
                    prevBtn.disabled = pagination.page === 1;
                    prevBtn.dataset.action = 'change-page';
                    prevBtn.dataset.type = type;
                    prevBtn.dataset.page = pagination.page - 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = pagination.page === pagination.pages;
                    nextBtn.dataset.action = 'change-page';
                    nextBtn.dataset.type = type;
                    nextBtn.dataset.page = pagination.page + 1;
                }
                
                const pageNumbers = this.viewContainer.querySelector(`#${type}-page-numbers`);
                if (!pageNumbers) {
                    console.error(`Page numbers for ${type} not found`);
                    return;
                }
                
                pageNumbers.innerHTML = '';
                
                for (let i = 1; i <= pagination.pages; i++) {
                    const button = document.createElement('button');
                    button.className = `pagination-button w-12 h-12 rounded-xl text-base font-semibold border-2 ${i === pagination.page ? 'active-page border-blue-600' : 'border-gray-300 text-gray-700 bg-white'}`;
                    button.textContent = i;
                    button.dataset.action = 'change-page';
                    button.dataset.type = type;
                    button.dataset.page = i;
                    pageNumbers.appendChild(button);
                }
            }
            
            // Modal Functions
            openModal(type, mode = 'create', data = null) {
                const isEdit = mode === 'edit';
                const title = isEdit 
                    ? (type === 'cliente' ? 'Editar Cliente' : 'Editar Administrador')
                    : (type === 'cliente' ? 'Nuevo Cliente' : 'Nuevo Administrador');

                console.log(`Opening modal for ${type} in ${mode} mode.`);
                if (!this.modalTitle) return;

                this.modalTitle.textContent = title;
                if (this.userTypeInput) this.userTypeInput.value = type;

                // Reset form only for new users
                if (!isEdit) {
                    // SOLUCIÓN PROFESIONAL: Evitar `this.userForm.reset()` que puede disparar validaciones.
                    // Limpiamos manualmente cada campo para un control total y evitar efectos secundarios.
                    if (this.userForm) {
                        this.userForm.querySelectorAll('input').forEach(input => {
                            // Limpiar el valor y cualquier error de validación previo.
                            input.value = '';
                            this.clearFieldError(input);
                        });
                    }
                    if (this.userIdInput) this.userIdInput.value = '';
                }

                // impiar siempre el campo de contraseña al abrir el modal.
                // Esto previene que una contraseña introducida en "Crear" aparezca al "Editar".
                if (this.passwordInput) this.passwordInput.value = '';


                // Password is required for new users, optional for edits
                if (this.passwordInput) {
                    // La contraseña ya no es requerida para la creación.
                    this.passwordInput.required = false;
                }

                // Mensaje de ayuda contextual para la contraseña.
                const passwordHelper = document.getElementById('password-helper-text');
                if (passwordHelper) {
                    passwordHelper.innerHTML = isEdit
                        ? '<i class="fas fa-info-circle mr-1"></i> Dejar en blanco para no cambiar la contraseña actual.'
                        : '<i class="fas fa-info-circle mr-1"></i> Dejar en blanco para generar una contraseña segura (Ej: Cristian30).';
                }

                // Configure fields based on user type
                if (type === 'cliente') {
                    if (this.cedulaContainer) this.cedulaContainer.classList.add('hidden');
                    if (this.userIdentificationInput) this.userIdentificationInput.required = false;
                } else { // admin
                    if (this.cedulaContainer) this.cedulaContainer.classList.remove('hidden');
                    if (this.userIdentificationInput) this.userIdentificationInput.required = true;
                }

                // Populate form if in edit mode
                if (isEdit && data) {
                    if (this.userIdInput) this.userIdInput.value = data.id;
                    if (this.userNameInput) this.userNameInput.value = data.nombre;
                    if (this.userLastnameInput) this.userLastnameInput.value = data.apellido;
                    if (this.userPhoneInput) this.userPhoneInput.value = data.numero || data.numero_telefono;
                    if (type === 'admin' && this.userIdentificationInput) this.userIdentificationInput.value = data.cedula;
                }

                if (this.modal) {
                    this.modal.classList.remove('hidden');
                    this.modal.classList.add('flex');
                    // SOLUCIÓN: Activar la bandera para indicar que el modal se acaba de abrir.
                    // Esto evitará que la validación se dispare prematuramente.
                    this.isInitialOpen = true;

                }

                if (this.saveButton) this.saveButton.disabled = false;

                // Tomar control del foco.
                // Al abrir el modal, el navegador intenta enfocar el primer campo visible,
                // lo que puede disparar validaciones. Al enfocar explícitamente el botón
                // "Guardar", evitamos este comportamiento no deseado.
                if (this.saveButton) this.saveButton.focus();

                // SOLUCIÓN: Después de un breve instante, desactivamos la bandera.
                setTimeout(() => { this.isInitialOpen = false; }, 100);
            }
            
            closeModal() {
                console.log("Closing modal");
                if (this.modal) {
                    this.modal.classList.add('hidden'); // Ocultar modal
                    this.modal.classList.remove('flex');
                }
                // Limpiar todos los errores de validación al cerrar el modal.
                if (this.userForm) {
                    this.userForm.querySelectorAll('input').forEach(this.clearFieldError);
                    const generalError = this.userForm.querySelector('.general-error-message');
                    if (generalError) generalError.classList.add('hidden');
                }
            }
            
            handleFormSubmit(e) {
                console.log("Handling form submit");
                e.preventDefault();
                
                if (!this.userTypeInput || !this.userNameInput || !this.userLastnameInput) {
                    console.error("Required form elements not found");
                    return;
                }
                
                const type = this.userTypeInput.value;
                const id = this.userIdInput.value;

                // Generar y mostrar contraseña automática si está vacía en modo creación.
                const isEdit = !!id;
                if (!isEdit && this.passwordInput.value.trim() === '') {
                    const nombre = this.userNameInput.value.trim();
                    const numero = this.userPhoneInput.value.trim();

                    if (nombre && numero.length >= 2) {
                        const nombreBase = nombre.split(' ')[0].charAt(0).toUpperCase() + nombre.split(' ')[0].slice(1).toLowerCase();
                        const longitudNombre = nombreBase.length;
                        const digitosNecesarios = Math.max(2, 8 - longitudNombre);
                        const autoPassword = `${nombreBase}${numero.substring(0, digitosNecesarios)}`;
                        this.passwordInput.value = autoPassword;
                        this.showNotification('info', 'Contraseña Generada', `Se ha generado una contraseña automática: ${autoPassword}`);
                        // No continuar con el submit, permitir al admin ver la contraseña y confirmar.
                        return;
                    }
                }

                // Validar todos los campos antes de enviar.
                let isFormValid = true;
                this.userForm.querySelectorAll('input[required]').forEach(input => {
                    if (!this.validateField(input)) {
                        isFormValid = false;
                    }
                });

                if (!isFormValid) {
                    this.showNotification('error', 'Formulario Inválido', 'Por favor, corrige los campos marcados en rojo.');
                    return;
                }

                if (this.saveButton) this.saveButton.disabled = true; // Prevenir doble click
                
                if (type === 'cliente') {
                    if (!this.userPhoneInput) {
                        console.error("User phone input not found");
                        return;
                    }
                    
                    const clienteData = {
                        id: id || null,
                        nombre: this.userNameInput.value,
                        apellido: this.userLastnameInput.value,
                        numero: this.userPhoneInput.value,
                        estado: "activo"
                    };
                    
                    if (this.passwordInput && this.passwordInput.value) {
                        clienteData.contraseña = this.passwordInput.value;
                    }
                    
                    this.saveCliente(clienteData);
                } else {
                    const adminData = {
                        id: id || null,
                        nombre: this.userNameInput.value,
                        apellido: this.userLastnameInput.value,
                        cedula: this.userIdentificationInput.value,
                        numero_telefono: this.userPhoneInput.value,
                        estado: "activo"
                    };
                    
                    if (this.passwordInput && this.passwordInput.value) {
                        adminData.contraseña = this.passwordInput.value;
                    }
                    
                    this.saveAdministrador(adminData);
                }
            }

            // --- INICIO: Funciones de Validación Profesional ---
            validateField(input) {
                if (!input) return true;

                // SOLUCIÓN: Si la bandera de apertura inicial está activa, ignoramos la validación.
                // Esto previene la validación prematura causada por el foco automático del navegador.
                if (this.isInitialOpen) return true;

                this.clearFieldError(input);
                const value = input.value.trim();
                const isRequired = input.hasAttribute('required');

                if (isRequired && value === '') {
                    this.setFieldError(input, 'Este campo es obligatorio.');
                    return false;
                }

                // No validar si no es requerido y está vacío (excepto contraseña en modo creación)
                if (!isRequired && value === '' && input.type !== 'password') {
                    return true;
                }

                switch (input.name) {
                    case 'numero':
                        if (!this.validationPatterns.phone.test(value)) {
                            this.setFieldError(input, 'El teléfono debe tener 10 dígitos.');
                            return false;
                        }
                        break;
                    case 'cedula':
                        if (isRequired && !this.validationPatterns.cedula.test(value)) {
                            this.setFieldError(input, 'La cédula debe tener entre 7 y 10 dígitos.');
                            return false;
                        }
                        break;
                    case 'contraseña':
                        // La contraseña es requerida solo si el input tiene 'required'
                        // (lo cual se controla en openModal)
                        if (isRequired && value.length < 8) {
                            this.setFieldError(input, 'La contraseña debe tener al menos 8 caracteres.');
                            return false;
                        }
                        // Si se está editando y se ingresa una contraseña, también debe ser válida.
                        if (!isRequired && value !== '' && value.length < 8) {
                            this.setFieldError(input, 'La nueva contraseña debe tener al menos 8 caracteres.');
                            return false;
                        }
                        break;
                }
                return true;
            }

            setFieldError(input, message) {
                input.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500/30');
                const errorElement = input.parentElement.querySelector('.error-message') || input.parentElement.parentElement.querySelector('.error-message');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            }

            clearFieldError(input) {
                input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500/30');
                const errorElement = input.parentElement.querySelector('.error-message') || input.parentElement.parentElement.querySelector('.error-message');
                if (errorElement) errorElement.classList.add('hidden');
            }
            // --- FIN: Funciones de Validación Profesional ---

            // --- INICIO: Función de UI Profesional para Contraseña ---
            updatePasswordHelperText() {
                const isEdit = !!this.userIdInput.value;
                const passwordHelper = document.getElementById('password-helper-text');
                if (isEdit || !passwordHelper) return; // Solo se ejecuta en modo creación

                const nombre = this.userNameInput.value.trim();
                const numero = this.userPhoneInput.value.trim();

                // Si el usuario está escribiendo una contraseña, ocultar el helper.
                if (this.passwordInput.value.trim() !== '') {
                    passwordHelper.classList.add('hidden');
                    return;
                } else {
                    passwordHelper.classList.remove('hidden');
                }

                if (nombre && numero.length >= 2) {
                    const nombreBase = nombre.split(' ')[0].charAt(0).toUpperCase() + nombre.split(' ')[0].slice(1).toLowerCase();
                    const longitudNombre = nombreBase.length;
                    const digitosNecesarios = Math.max(2, 8 - longitudNombre);
                    const autoPassword = `${nombreBase}${numero.substring(0, digitosNecesarios)}`;
                    
                    passwordHelper.innerHTML = `<i class="fas fa-magic mr-1"></i> Se generará: <strong class="font-mono">${autoPassword}</strong>`;
                } else {
                    // Revertir al mensaje por defecto si no hay datos suficientes
                    passwordHelper.innerHTML = '<i class="fas fa-info-circle mr-1"></i> Dejar en blanco para generar una contraseña segura (Ej: Cristian30).';
                }
            }
            // --- FIN: Función de UI Profesional para Contraseña ---
            
            // Utility Functions
            showNotification(type, title, message) {
                console.log(`Showing ${type} notification: ${title} - ${message}`);
                const notification = this.notification;
                const icon = document.getElementById('notification-icon');
                const titleEl = document.getElementById('notification-title');
                const messageEl = document.getElementById('notification-message');
                
                if (!notification || !icon || !titleEl || !messageEl) { // SOLUCIÓN: Verificar los elementos correctos
                    console.error("Notification elements not found");
                    return;
                }
                
                // Set icon and color based on type
                if (type === 'success') {
                    icon.innerHTML = '<i class="fas fa-check-circle text-white"></i>';
                    icon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-green-500';
                } else {
                    icon.innerHTML = '<i class="fas fa-exclamation-circle text-white"></i>';
                    icon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-red-500';
                }
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Show notification
                notification.classList.remove('translate-x-full');
                
                // Hide notification after 5 seconds
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                }, 5000);
            }
            
            getCsrfToken() {
                const csrfToken = document.querySelector('input[name="csrf_token"]');
                return csrfToken ? csrfToken.getAttribute('content') : '';
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Functions to handle actions
            editCliente(id) {
                console.log(`Editing cliente with id: ${id}`);
                fetch(`/api/usuarios/${id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Cliente data received:", data);
                        if (data.success) {
                            const cliente = data.usuario;
                            this.openModal('cliente', 'edit', cliente);
                        } else {
                            this.showNotification('error', 'Error', data.message || 'No se pudo cargar el cliente');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading cliente:', error);
                        this.showNotification('error', 'Error', 'No se pudo cargar el cliente');
                    });
            }
            
            editAdministrador(id) {
                console.log(`Editing administrador with id: ${id}`);
                fetch(`/api/admins/${id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Administrador data received:", data);
                        if (data.success) {
                            const admin = data.admin;
                            this.openModal('admin', 'edit', admin);
                        } else {
                            this.showNotification('error', 'Error', data.message || 'No se pudo cargar el administrador');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading administrador:', error);
                        this.showNotification('error', 'Error', 'No se pudo cargar el administrador');
                    });
            }

            togglePasswordVisibility() {
                const passwordInput = document.getElementById('user-password');
                const toggleButton = document.getElementById('toggle-password-visibility');
                const icon = toggleButton.querySelector('i');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
        }
        
        // Crear una instancia de la clase y asignarla a window.usuariosApp
        window.usuariosApp = new UsuariosApp();
    }

    //  Lógica de gestión del ciclo de vida del SPA.
    const usuariosView = document.getElementById('usuarios-view');
    
    function handleContentLoaded(event) {
        // Solo inicializar si el contenedor de esta vista está en el DOM.
        if (document.body.contains(usuariosView) && window.usuariosApp) {
            console.log("content-loaded event fired, initializing UsuariosApp");
            window.usuariosApp.init();
        }
    }

    function handleContentWillLoad() {
        if (window.usuariosApp && window.usuariosApp.isInitialized) {
            console.log("content-will-load event fired, cleaning up UsuariosApp");
            window.usuariosApp.cleanup();
        }
        // Remover los listeners de este script para evitar que se acumulen.
        document.removeEventListener('content-loaded', handleContentLoaded);
        document.removeEventListener('content-will-load', handleContentWillLoad);
    }

    document.addEventListener('content-loaded', handleContentLoaded);
    document.addEventListener('content-will-load', handleContentWillLoad);

    // Inicialización para la carga inicial de la página (no SPA).
    handleContentLoaded();
</script>

<style>
    .fade-in {
        animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .table-container {
        overflow-x: auto;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .status-active {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #166534;
        padding: 6px 16px;
        border-radius: 24px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .status-inactive {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #b91c1c;
        padding: 6px 16px;
        border-radius: 24px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .status-active:hover {
        background: linear-gradient(135deg, #bbf7d0 0%, #6ee7b7 100%);
        transform: scale(1.05);
    }
    .status-inactive:hover {
        background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        transform: scale(1.05);
    }
    .pagination-button {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
    }
    .pagination-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        border-color: #2563eb;
    }
    .pagination-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
    }
    .active-page {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white !important;
        border-color: #2563eb !important;
    }
    .card-hover {
        transition: all 0.3s ease;
    }
    .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .action-btn {
        transition: all 0.2s ease;
        opacity: 0.7;
    }
    .action-btn:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    .search-input {
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    .search-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* Animations for table rows */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    tbody tr {
        animation: slideIn 0.3s ease-out;
    }
    
    /* Mejoras para las tarjetas de estadísticas */
    .stats-card {
        position: relative;
        overflow: hidden;
    }
    
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }
    
    /* Efecto de brillo para las tarjetas */
    .stats-card:hover::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }
    
    /* Animación para los números de estadísticas */
    .stat-number {
        transition: all 0.3s ease;
    }
    
    .stat-number:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}