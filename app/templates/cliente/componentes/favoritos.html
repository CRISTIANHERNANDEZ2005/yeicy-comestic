{% extends 'cliente/page/base.html' %} {% block title %}Mis Favoritos - YE & CY
Cosméticos {% endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8"
  >
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
        Mis Favoritos
      </h1>
      <p class="text-gray-600 mt-2">
        Tus productos guardados en un solo lugar
      </p>
    </div>
    <div class="mt-4 md:mt-0">
      <span
        class="text-sm bg-pink-100 text-pink-800 px-3 py-1 rounded-full font-medium"
      >
        {{ productos|length }} {{ 'producto' if productos|length == 1 else
        'productos' }}
      </span>
    </div>
  </div>

  {% if productos %}
  <!-- Carrusel de productos - VERSIÓN ULTRA PROFESIONAL CON CORRECCIONES -->
  {% include 'cliente/ui/carta_producto.html' %} {% else %}
  <div class="text-center py-16 bg-white rounded-xl shadow-sm">
    <div class="max-w-md mx-auto">
      <div class="w-20 h-20 mx-auto mb-4 text-gray-300">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
          />
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">
        No tienes productos favoritos
      </h3>
      <p class="text-gray-500 mb-6">
        Guarda tus productos favoritos para encontrarlos fácilmente más tarde
      </p>
      <a
        href="{{ url_for('products.index') }}"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500"
      >
        <svg
          class="-ml-1 mr-2 h-5 w-5"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            fill-rule="evenodd"
            d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
            clip-rule="evenodd"
          />
        </svg>
        Seguir comprando
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  window.FAVORITES_DATA = {{ productos|tojson|safe }};
  window.USUARIO_AUTENTICADO = {{ usuario_autenticado|tojson|safe }};
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("[FAVORITOS] DOMContentLoaded: El DOM está listo.");

    // Elementos DOM
    const track = document.getElementById("carouselTrack");
    const prevBtn = document.querySelector(".carousel-prev");
    const nextBtn = document.querySelector(".carousel-next");
    const indicatorsContainer = document.getElementById("carouselIndicators");
    const loadingState = document.getElementById("loadingState");

    console.log("[FAVORITOS] Elementos del DOM:", {
        track,
        prevBtn,
        nextBtn,
        indicatorsContainer,
        loadingState
    });

    if (!track || !loadingState || !prevBtn || !nextBtn || !indicatorsContainer) {
        console.error("[FAVORITOS] Uno o más elementos del carrusel no se encontraron. Abortando inicialización.");
        if(loadingState) loadingState.innerHTML = '<p class="text-center text-red-500">Error crítico: No se pudieron cargar los componentes del carrusel.</p>';
        return;
    }

    // Estado mejorado
    let currentIndex = 0;
    let isMobile = window.IS_MOBILE || window.innerWidth < 768;
    let productsPerSlide = isMobile ? 2 : 4;
    let totalProducts = 0;
    let totalSlides = 0;

    // Función optimizada de carga
    function initializeProductCarousel() {
        console.log("[FAVORITOS] Inicializando el carrusel...");
        try {
            console.log("[FAVORITOS] Datos recibidos:", window.FAVORITES_DATA);

            // Validar que existan productos y que sea un array
            if (!window.FAVORITES_DATA || !Array.isArray(window.FAVORITES_DATA) || window.FAVORITES_DATA.length === 0) {
                console.warn("[FAVORITOS] No se encontraron productos favoritos o los datos no son un array válido.");
                loadingState.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-500 text-lg">Aún no tienes productos favoritos.</p>
                    </div>
                `;
                // Ocultar controles si no hay productos
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                indicatorsContainer.style.display = 'none';
                return;
            }

            totalProducts = window.FAVORITES_DATA.length;
            console.log(`[FAVORITOS] Total de productos: ${totalProducts}`);
            totalSlides = Math.max(
                1,
                Math.ceil(totalProducts / productsPerSlide)
            );
            console.log(`[FAVORITOS] Total de diapositivas: ${totalSlides}`);

            createRealContent();
            showControlsWithAnimation();
        } catch (error) {
            console.error("[FAVORITOS] Error fatal durante la inicialización del carrusel:", error);
            loadingState.innerHTML = '<p class="text-center text-red-500">Ocurrió un error inesperado al mostrar tus favoritos.</p>';
        }
    }

    // Crear contenido real con manejo preciso
    function createRealContent() {
        console.log("[FAVORITOS] Creando contenido real...");
        track.innerHTML = ""; // Limpia el esqueleto de carga

        for (let slideIndex = 0; slideIndex < totalSlides; slideIndex++) {
            const slide = createOptimizedSlide(slideIndex);
            track.appendChild(slide);
        }
        console.log("[FAVORITOS] Contenido real creado.");

        renderSmartIndicators();
        updateCarouselPosition();
    }

    // ... (el resto del código es el mismo, no es necesario repetirlo)

    // Crear slide optimizado
    function createOptimizedSlide(slideIndex) {
      const slide = document.createElement("div");
      slide.className = "carousel-slide w-full flex-shrink-0";

      const grid = document.createElement("div");
      grid.className = `grid gap-4 ${
        isMobile ? "grid-cols-2" : "grid-cols-4"
      }`;

      const startIndex = slideIndex * productsPerSlide;
      const endIndex = Math.min(
        startIndex + productsPerSlide,
        totalProducts
      );

      for (let i = startIndex; i < endIndex; i++) {
        const productData = window.FAVORITES_DATA[i];
        if (productData) {
          const productCard = createOptimizedProductCard(
            productData,
            i - startIndex
          );
          grid.appendChild(productCard);
        }
      }

      slide.appendChild(grid);
      return slide;
    }

    // Función mejorada para verificar si es nuevo
    function verificarEsNuevo(producto) {
      if (producto.es_nuevo === undefined || producto.es_nuevo === null) {
        // Fallback: calcular basado en fecha si está disponible
        if (producto.fecha_creacion) {
          const fechaProducto = new Date(producto.fecha_creacion);
          const fechaActual = new Date();
          const diferenciaDias = Math.floor(
            (fechaActual - fechaProducto) / (1000 * 60 * 60 * 24)
          );
          return diferenciaDias <= 7; // 7 días para mayor profesionalismo
        }
        return false;
      }
      return producto.es_nuevo;
    }

    function createOptimizedProductCard(producto, delayIndex) {
      const card = document.createElement("a");
      card.href = `/producto/${producto.id}`; // Enlace a la página de detalles del producto
      card.className =
        "product-card bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden group relative flex flex-col h-full";
      card.setAttribute("data-product-id", producto.id);

      // Verificar si el producto está en favoritos
      const isFavorite = window.favoritesManager
        ? window.favoritesManager.favoriteProducts.has(String(producto.id))
        : false;

      card.style.animationDelay = `${delayIndex * 0.08}s`;

      // Prevenir la navegación cuando se hace clic en elementos interactivos
      card.addEventListener("click", function (e) {
        // Si el clic fue en un botón o enlace dentro de la tarjeta, prevenir la navegación
        if (e.target.closest("button, a:not(.product-card)")) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // Verificar si es nuevo con lógica profesional
      const esNuevo = verificarEsNuevo(producto);
      const nuevoTag = esNuevo
        ? `
                <div class="absolute top-2 right-2 bg-gradient-to-r from-pink-500 to-fuchsia-500 text-white px-2 py-1 rounded-full text-xs font-bold shadow-sm animate-pulse z-10">
                    🌟 NUEVO
                </div>
            `
        : "";

      // Determinar tiempo transcurrido para tooltip
      let tiempoTranscurrido = "";
      if (producto.fecha_creacion) {
        const fechaProducto = new Date(producto.fecha_creacion);
        const fechaActual = new Date();
        const diferenciaDias = Math.floor(
          (fechaActual - fechaProducto) / (1000 * 60 * 60 * 24)
        );

        if (diferenciaDias === 0) {
          tiempoTranscurrido = "Hoy";
        } else if (diferenciaDias === 1) {
          tiempoTranscurrido = "Ayer";
        } else if (diferenciaDias <= 7) {
          tiempoTranscurrido = `Hace ${diferenciaDias} día${
            diferenciaDias > 1 ? "s" : ""
          }`;
        }
      }

      // Determinar si debemos mostrar el placeholder
      const hasImage =
        producto.imagen_url &&
        producto.imagen_url.trim() !== "" &&
        !producto.imagen_url.includes("default");

      // URL para el placeholder SVG
      const placeholderSvg =
        "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZDhkYWRiIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPHBhdGggZD0iTTMuMTYgMTguODhMMTUuMTIgNi45M2EuMTYuMTYgMCAwIDEgLjIyIDBsMy4wNiAzLjA2YS4xNi4xNiAwIDAgMSAwIC4yMkw2LjQ0IDIyYTEgMSAwIDAgMS0xLjM5LjA2bC02LjE1LTUuNzlhMS4yNSAxLjI1IDAgMCAxIC4yNi0xLjM5eiIvPgo8cGF0aCBkPSJNMTkgMTlhMiAyIDAgMSAwIDAtNCAyIDIgMCAwIDAgMCA0eiIvPgo8cGF0aCBkPSJNMjIgMTB2OGEyIDIgMCAwIDEtMiAyaC0xM2wtMy4yLTIuN2ExIDEgMCAwIDAtMS42LjRsLTMuMzUgNCIvPgo8cGF0aCBkPSJNMiAxMHYtNGEyIDIgMCAwIDEgMi0yaDZhMSAxIDAgMCAwIC44LS40bDIuNi0zLjQ1YTEgMSAwIDAgMSAuOC0uMzVIMThhMiAyIDAgMCAxIDIgMlYxMCIvPgo8L3N2Zz4=";

      card.innerHTML = `
               <div class="relative bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden flex flex-col h-full transform hover:scale-[1.03] group-hover:z-10">
                    <div class="product-image-container relative overflow-hidden aspect-square ${
                      !hasImage
                        ? "bg-gray-50 flex items-center justify-center"
                        : "bg-gray-100"
                    }">
                        ${
                          !hasImage
                            ? `<div class="w-full h-full flex flex-col items-center justify-center p-4">
                                       <div class="w-16 h-16 mb-2 text-gray-300">
                                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                           </svg>
                                       </div>
                                       <span class="text-xs text-center text-gray-400 font-medium">Imagen no disponible</span>
                                   </div>`
                            : `<img src="${producto.imagen_url}" alt="${producto.nombre}" loading="lazy" 
                                      class="product-image w-full h-full object-cover" 
                                      onerror="this.onerror=null; this.src='${placeholderSvg}'; this.classList.add('p-4', 'opacity-50')">`
                        }
                        ${nuevoTag}
                        ${
                          tiempoTranscurrido && hasImage
                            ? `<div class="absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs">${tiempoTranscurrido}</div>`
                            : ""
                        }
                    </div>
                    <div class="p-3 md:p-4 flex flex-col flex-grow">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs uppercase tracking-wide text-gray-600 font-medium">${
                              producto.marca || "Sin marca"
                            }</span>
                             <button class="favorite-btn ${
                               !window.favoritesManager ||
                               !window.favoritesManager.isAuthenticated
                                 ? "text-gray-300"
                                 : isFavorite
                                 ? "text-red-500"
                                 : "text-gray-400"
                             } transition-all duration-200 hover:scale-110 z-20 relative"
                 title="${
                   !window.favoritesManager ||
                   !window.favoritesManager.isAuthenticated
                     ? "Inicia sesión para guardar en favoritos"
                     : isFavorite
                     ? "Eliminar de favoritos"
                     : "Añadir a favoritos"
                 }"
                 aria-label="${
                   !window.favoritesManager ||
                   !window.favoritesManager.isAuthenticated
                     ? "Inicia sesión para guardar en favoritos"
                     : isFavorite
                     ? "Eliminar de favoritos"
                     : "Añadir a favoritos"
                 }"
                 data-product-id="${producto.id}"
                 tabindex="0"
                 style="background: none; border: none; outline: none;"
                 data-initialized="true">
                <svg class="w-6 h-6" fill="${
                  !window.favoritesManager ||
                  !window.favoritesManager.isAuthenticated
                    ? "none"
                    : isFavorite
                    ? "currentColor"
                    : "none"
                }" 
                     viewBox="0 0 24 24" 
                     stroke="currentColor" 
                     stroke-width="1.5"
                     ${
                       !window.favoritesManager ||
                       !window.favoritesManager.isAuthenticated
                         ? 'opacity="0.6"'
                         : ""
                     }>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                </svg>
            </button>
        </div>
        <h3 class="text-sm md:text-base font-semibold text-gray-800 mb-1 line-clamp-2">${
          producto.nombre
        }</h3>
                        <div class="min-h-[36px] md:min-h-[40px] mb-2">
                            <p class="text-xs text-gray-600 line-clamp-2">
                                ${producto.descripcion.substring(0, 70)}${
        producto.descripcion.length > 70 ? "..." : ""
      }
                            </p>
                        </div>
                        <div class="flex items-center mb-2">
                            <div class="flex space-x-0.5">
                                ${generateOptimizedStars(
                                  producto.calificacion_promedio || 0
                                )}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">(${
                              producto.reseñas || 0
                            } reseñas)</span>
                        </div>
                        <div class="flex items-center justify-between mt-auto pt-2">
                            <p class="text-base md:text-lg font-bold text-pink-600">$${parseFloat(
                              producto.precio
                            ).toFixed(2)}</p>
                             <button class="add-to-cart bg-gradient-to-r from-pink-500 to-fuchsia-500 text-white px-3 py-2 md:px-4 rounded-full hover:from-pink-600 hover:to-fuchsia-600 transition-all duration-300 flex items-center text-xs md:text-sm hover:shadow-lg hover:scale-105 active:scale-95 z-20 relative"
                                   data-product-id="${producto.id}"
                                   data-quantity="1"
                                   data-product-name="${producto.nombre}"
                                   onclick="event.stopPropagation(); event.preventDefault(); if(window.cart) { window.cart.addToCart(event.currentTarget); }">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <span class="hidden sm:inline">Añadir</span>
                            </button>
                        </div>
                </div>
            `;

      return card;
    }

    // Generar estrellas optimizadas
    function generateOptimizedStars(rating) {
      const stars = Math.round(rating);
      let html = "";
      for (let i = 0; i < 5; i++) {
        const color = i < stars ? "text-yellow-400" : "text-gray-300";
        const size = "w-3 h-3";
        html += `<svg class="${size} ${color}" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>`;
      }
      return html;
    }

    // Renderizar indicadores inteligentes
    function renderSmartIndicators() {
      indicatorsContainer.innerHTML = "";

      if (totalSlides <= 1) {
        indicatorsContainer.style.display = "none";
        return;
      }

      indicatorsContainer.style.display = "flex";

      for (let i = 0; i < totalSlides; i++) {
        const indicator = document.createElement("button");
        indicator.className = `carousel-indicator ${
          i === 0 ? "active" : ""
        }`;
        indicator.setAttribute("data-index", i);
        indicator.setAttribute("aria-label", `Diapositiva ${i + 1}`);

        indicator.addEventListener("click", () => {
          currentIndex = i;
          updateCarouselPosition();
          updateActiveIndicator();
        });

        indicatorsContainer.appendChild(indicator);
      }
    }

    // Actualizar indicador activo
    function updateActiveIndicator() {
      const indicators = indicatorsContainer.querySelectorAll(
        ".carousel-indicator"
      );
      indicators.forEach((indicator, idx) => {
        indicator.classList.toggle("active", idx === currentIndex);
      });
    }

    // Mostrar controles con animación suave
    function showControlsWithAnimation() {
        const shouldShow = totalSlides > 1;
        prevBtn.style.opacity = shouldShow ? "1" : "0";
        nextBtn.style.opacity = shouldShow ? "1" : "0";
        prevBtn.style.transform = "scale(1)";
        nextBtn.style.transform = "scale(1)";
        prevBtn.style.pointerEvents = shouldShow ? "auto" : "none";
        nextBtn.style.pointerEvents = shouldShow ? "auto" : "none";
    }

    // Actualizar posición del carrusel
    function updateCarouselPosition() {
      const slideWidth = 100;
      track.style.transform = `translateX(-${currentIndex * slideWidth}%)`;
      updateActiveIndicator();

      // Ajustar altura dinámicamente
      setTimeout(adjustCarouselHeight, 100);
    }

    // Navegación mejorada
    function navigate(direction) {
      if (totalSlides <= 1) return;

      const newIndex =
        direction === "next"
          ? (currentIndex + 1) % totalSlides
          : (currentIndex - 1 + totalSlides) % totalSlides;

      currentIndex = newIndex;
      updateCarouselPosition();
    }

    // Event listeners mejorados
    prevBtn?.addEventListener("click", () => navigate("prev"));
    nextBtn?.addEventListener("click", () => navigate("next"));

    // Touch/swipe optimizado
    let touchStartX = 0;
    let touchEndX = 0;

    track.addEventListener("touchstart", (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    track.addEventListener("touchend", (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      if (totalSlides <= 1) return;

      if (touchEndX < touchStartX - 50) navigate("next");

      if (touchEndX > touchStartX + 50) navigate("prev");
    }

    function adjustCarouselHeight() {
      const viewport = document.querySelector(".carousel-viewport");
      const track = document.getElementById("carouselTrack");

      if (viewport && track) {
        const activeSlide = track.children[currentIndex];
        if (activeSlide) {
          const slideHeight = activeSlide.offsetHeight;
          viewport.style.minHeight = `${slideHeight + 40}px`; // 40px extra para el zoom
        }
      }
    }

    // Responsive con throttling
    let resizeTimeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const wasMobile = isMobile;
        isMobile = window.innerWidth < 768;

        if (wasMobile !== isMobile) {
          productsPerSlide = isMobile ? 2 : 4;
          createRealContent(); // No recalcular totalSlides aquí, se hace en createRealContent
        }
      }, 250);
    });

    // Auto-inicialización
    initializeProductCarousel();

  }); // Cierre del DOMContentLoaded
</script>
{% endblock %}