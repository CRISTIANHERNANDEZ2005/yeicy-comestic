{% extends 'cliente/page/base.html' %} {% block title %}Mi Perfil - YE&Ci
Cosméticos{% endblock %} {% block content %}

<div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header elegante -->
    <div class="text-center mb-16 fade-in">
        <div class="relative inline-block">
            <div
                class="absolute -inset-4 bg-gradient-to-r from-rose-400 via-pink-400 to-purple-400 rounded-full blur-2xl opacity-30 animate-pulse"
            ></div>
            <h1
                class="relative text-5xl md:text-7xl font-extralight bg-gradient-to-r from-rose-600 via-pink-600 to-purple-600 bg-clip-text text-transparent tracking-tighter"
            >
                Mi Perfil
            </h1>
        </div>
        <p
            class="mt-4 text-lg md:text-xl text-gray-600 max-w-md mx-auto leading-relaxed"
        >
            Gestiona tu información
            <span
                class="font-medium text-transparent bg-gradient-to-r from-rose-600 to-purple-600 bg-clip-text"
                >personal</span
            >
            y mantén tus datos siempre actualizados
        </p>
        <div class="mt-6 flex justify-center space-x-2">
            <div
                class="w-12 h-0.5 bg-gradient-to-r from-rose-500 to-pink-500 rounded-full"
            ></div>
            <div
                class="w-2 h-0.5 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full"
            ></div>
            <div
                class="w-1 h-0.5 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full"
            ></div>
        </div>
    </div>

    <!-- Navegación móvil - Solo visible en móvil -->
    <div class="lg:hidden mb-8">
        <div
            class="bg-white/80 backdrop-blur-xl rounded-3xl p-5 shadow-2xl border border-white/20"
        >
            <h3
                class="text-sm font-semibold text-gray-700 mb-4 text-center tracking-wide"
            >
                Accesos rápidos
            </h3>
            <div class="grid grid-cols-3 gap-3">
                <!-- Mis Pedidos -->
                <a
                    href="{{ url_for('order.view_orders') }}"
                    class="group relative overflow-hidden flex flex-col items-center py-4 px-3 rounded-2xl bg-gradient-to-br from-pink-50 to-purple-50 hover:from-pink-100 hover:to-purple-100 transition-all duration-300 transform hover:scale-105"
                >
                    <div class="relative z-10">
                        <svg
                            class="w-7 h-7 mb-2 text-pink-500 group-hover:text-pink-600 transition-colors"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                            />
                        </svg>
                        <span
                            class="text-xs font-semibold text-gray-700 group-hover:text-gray-900"
                            >Mis Pedidos</span
                        >
                    </div>
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-pink-400/10 to-purple-400/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                    ></div>
                </a>

                <!-- Historial de Compras -->
                <a
                    href="{{ url_for('order.view_compras') }}"
                    class="group relative overflow-hidden flex flex-col items-center py-4 px-3 rounded-2xl bg-gradient-to-br from-blue-50 to-cyan-50 hover:from-blue-100 hover:to-cyan-100 transition-all duration-300 transform hover:scale-105"
                >
                    <div class="relative z-10">
                        <svg
                            class="w-7 h-7 mb-2 text-blue-500 group-hover:text-blue-600 transition-colors"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                            />
                        </svg>
                        <span
                            class="text-xs font-semibold text-gray-700 group-hover:text-gray-900"
                            >Compras</span
                        >
                    </div>
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-blue-400/10 to-cyan-400/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                    ></div>
                </a>

                <!-- Cerrar Sesión -->
                <a
                    href="#"
                    onclick="window.openLogoutModal(); return false;"
                    onclick="window.auth.logout(); return false;"
                    class="group relative overflow-hidden flex flex-col items-center py-4 px-3 rounded-2xl bg-gradient-to-br from-red-50 to-orange-50 hover:from-red-100 hover:to-orange-100 transition-all duration-300 transform hover:scale-105"
                >
                    <div class="relative z-10">
                        <svg
                            class="w-7 h-7 mb-2 text-red-500 group-hover:text-red-600 transition-colors"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                            />
                        </svg>
                        <span
                            class="text-xs font-semibold text-gray-700 group-hover:text-gray-900"
                            >Cerrar Sesión</span
                        >
                    </div>
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-red-400/10 to-orange-400/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                    ></div>
                </a>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
        <!-- Columna izquierda - Avatar y estadísticas -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Avatar con efecto hover -->
            <div
                class="bg-white/90 backdrop-blur-sm rounded-3xl p-8 shadow-2xl border border-gray-100/50 transform hover:scale-105 transition-all duration-500"
            >
                <div class="relative inline-block mx-auto">
                    <div
                        class="avatar-circle w-28 h-28 rounded-full mx-auto mb-4 flex items-center justify-center shadow-2xl overflow-hidden relative"
                    >
                        {% if usuario.avatar_url %}
                        <img
                            src="{{ usuario.avatar_url }}"
                            alt="Avatar de {{ usuario.nombre }}"
                            class="w-full h-full object-cover"
                            id="avatarImage"
                        />
                        {% endif %}
                        <span
                            class="text-white text-4xl font-light {{ 'hidden' if usuario.avatar_url else '' }}"
                            id="avatarInitials"
                            >{{ usuario.nombre[0]|upper }}{{
                            usuario.apellido[0]|upper }}</span
                        >
                    </div>
                    <div
                        class="absolute -bottom-2 -right-2 w-10 h-10 bg-gradient-to-r from-green-400 to-green-600 rounded-full border-4 border-white flex items-center justify-center shadow-lg"
                    >
                        <i class="fas fa-check text-white text-sm"></i>
                    </div>
                    <!-- Botón de cámara para cambiar avatar -->
                    <button
                        onclick="openAvatarModal()"
                        class="absolute -top-2 -right-2 w-10 h-10 bg-gradient-to-r from-pink-500 to-fuchsia-500 rounded-full border-4 border-white flex items-center justify-center shadow-lg hover:from-pink-600 hover:to-fuchsia-600 transition-all duration-300 hover:scale-110 z-10"
                        title="Cambiar foto de perfil"
                    >
                        <i class="fas fa-camera text-white text-sm"></i>
                    </button>
                </div>
                <h2
                    class="text-2xl font-medium text-gray-800 text-center mt-4"
                    id="avatarFullName"
                >
                    {{ usuario.nombre | title }} {{ usuario.apellido | title }}
                </h2>
                <p class="text-gray-500 text-center text-sm mt-1">
                    Cliente VIP
                </p>
                <div class="mt-6 flex justify-center space-x-2">
                    <div
                        class="w-3 h-3 bg-yellow-400 rounded-full shadow-sm"
                    ></div>
                    <div
                        class="w-3 h-3 bg-yellow-400 rounded-full shadow-sm"
                    ></div>
                    <div
                        class="w-3 h-3 bg-yellow-400 rounded-full shadow-sm"
                    ></div>
                    <div
                        class="w-3 h-3 bg-yellow-400 rounded-full shadow-sm"
                    ></div>
                    <div
                        class="w-3 h-3 bg-gray-300 rounded-full shadow-sm"
                    ></div>
                </div>
            </div>

            <!-- Estadísticas con mejor visualización -->
            <div
                class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-2xl border border-gray-100/50"
            >
                <h3
                    class="text-lg font-semibold text-gray-800 mb-6 flex items-center"
                >
                    <i class="fas fa-chart-line mr-3 text-rose-400"></i>
                    Mis Estadísticas
                </h3>
                <div class="space-y-4">
                    <div
                        class="stat-card rounded-2xl p-4 flex items-center justify-between hover:shadow-xl transition-all duration-300"
                    >
                        <div class="flex items-center">
                            <div
                                class="w-14 h-14 rounded-2xl bg-gradient-to-br from-pink-400 via-pink-500 to-pink-600 flex items-center justify-center mr-4 shadow-lg"
                            >
                                <i
                                    class="fas fa-shopping-bag text-white text-sm"
                                ></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">
                                    Pedidos realizados
                                </p>
                                <p class="text-2xl font-bold text-gray-900">
                                    {{ pedidos_realizados }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="stat-card rounded-2xl p-4 flex items-center justify-between hover:shadow-xl transition-all duration-300"
                    >
                        <div class="flex items-center">
                            <div
                                class="w-14 h-14 rounded-2xl bg-gradient-to-br from-rose-400 via-rose-500 to-rose-600 flex items-center justify-center mr-4 shadow-lg"
                            >
                                <i
                                    class="fas fa-dollar-sign text-white text-sm"
                                ></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">
                                    Total de compras
                                </p>
                                <p class="text-2xl font-bold text-gray-900">
                                    {{ total_compras }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="stat-card rounded-2xl p-4 flex items-center justify-between hover:shadow-xl transition-all duration-300"
                    >
                        <div class="flex items-center">
                            <div
                                class="w-14 h-14 rounded-2xl bg-gradient-to-br from-red-400 via-red-500 to-red-600 flex items-center justify-center mr-4 shadow-lg"
                            >
                                <i class="fas fa-heart text-white text-sm"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">
                                    Productos favoritos
                                </p>
                                <p class="text-2xl font-bold text-gray-900">
                                    {{ usuario.likes|length }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="stat-card rounded-2xl p-4 flex items-center justify-between hover:shadow-xl transition-all duration-300"
                    >
                        <div class="flex items-center">
                            <div
                                class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-400 via-purple-500 to-purple-600 flex items-center justify-center mr-4 shadow-lg"
                            >
                                <i class="fas fa-star text-white text-sm"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">
                                    Reseñas escritas
                                </p>
                                <p class="text-2xl font-bold text-gray-900">
                                    {{ usuario.reseñas|length }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha - Información editable -->
        <!-- Vista de Perfil (simplificada) -->
        <div class="lg:col-span-2">
            <div
                class="bg-white/90 backdrop-blur-sm rounded-3xl p-8 shadow-2xl border border-gray-100/50"
            >
                <div class="flex items-center justify-between mb-8">
                    <h3
                        class="text-3xl font-light text-gray-800 flex items-center"
                    >
                        <i class="fas fa-user-cog mr-4 text-rose-400"></i>
                        Información de Cuenta
                    </h3>
                    <button
                        onclick="openModal()"
                        class="bg-gradient-to-r from-pink-500 to-fuchsia-500 text-white px-3 py-2 md:px-4 rounded-full hover:from-pink-600 hover:to-fuchsia-600 transition-all duration-300 flex items-center text-xs md:text-sm hover:shadow-lg hover:scale-105 active:scale-95 z-20 relative font-medium"
                    >
                        <i class="fas fa-edit mr-2"></i>Editar
                    </button>
                </div>

                <div class="divider mb-8"></div>

                <!-- Grid de información -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label
                                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >Nombre</label
                            >
                            <p
                                class="text-lg font-semibold text-gray-800"
                                id="displayNombre"
                            >
                                {{ usuario.nombre }}
                            </p>
                        </div>
                        <div>
                            <label
                                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >Apellido</label
                            >
                            <p
                                class="text-lg font-semibold text-gray-800"
                                id="displayApellido"
                            >
                                {{ usuario.apellido }}
                            </p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label
                                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >Teléfono</label
                            >
                            <p
                                class="text-lg font-semibold text-gray-800"
                                id="displayTelefono"
                            >
                                {{ usuario.numero }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* Estilos base mejorados */
            body {
                background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            }

            .cosmetic-shadow {
                box-shadow: 0 8px 32px rgba(232, 180, 184, 0.12);
            }

            .cosmetic-shadow:hover {
                box-shadow: 0 16px 64px rgba(232, 180, 184, 0.25);
            }

            .rose-gold-accent {
                color: #e8b4b8;
            }

            .input-focus:focus {
                border-color: #e8b4b8;
                box-shadow: 0 0 0 4px rgba(232, 180, 184, 0.15);
                transform: translateY(-1px);
            }

            .avatar-circle {
                background: linear-gradient(135deg, #e8b4b8 0%, #d1a7b5 100%);
                box-shadow: 0 8px 32px rgba(232, 180, 184, 0.4);
            }

            .stat-card {
                background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
                border: 1px solid rgba(232, 180, 184, 0.1);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .stat-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.08);
                background: linear-gradient(
                    135deg,
                    #fefefe 0%,
                    #fdfdfd 100%
                ); /* Subtle lighter gradient on hover */
            }

            .edit-mode {
                display: none;
            }

            .divider {
                height: 2px;
                background: linear-gradient(
                    to right,
                    transparent,
                    #e8b4b8 20%,
                    #e8b4b8 80%,
                    transparent
                );
                border-radius: 1px;
            }

            /* Navegación móvil */
            .mobile-nav-item {
                background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
                border: 1px solid rgba(232, 180, 184, 0.1);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .mobile-nav-item:hover {
                background: linear-gradient(135deg, #e8b4b8 0%, #d4afb9 100%);
                color: white !important;
                transform: translateY(-3px);
                box-shadow: 0 8px 32px rgba(232, 180, 184, 0.4);
            }

            /* Animaciones */
            .fade-in {
                animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Responsive */
            @media (min-width: 1024px) {
                .lg\\:hidden {
                    display: none !important;
                }
            }

            /* Mejoras en formularios */
            .form-group {
                margin-bottom: 2rem;
            }

            input[readonly] {
                cursor: not-allowed;
                opacity: 0.8;
            }

            /* Glass morphism effect */
            .backdrop-blur-sm {
                backdrop-filter: blur(10px);
            }

            /* Hover states */
            button:hover {
                transform: translateY(-2px);
            }

            input:hover:not([readonly]) {
                transform: translateY(-1px);
            }

            /* Focus states */
            input:focus {
                outline: none;
            }

            /* Text selection */
            ::selection {
                background-color: rgba(232, 180, 184, 0.2);
                color: #374151;
            }
        </style>
    </div>
</div>

<!-- Modal para gestión de avatar -->
<div
    id="avatarModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
>
    <div
        class="bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto"
    >
        <!-- Header del modal -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h3
                    class="text-xl font-semibold text-gray-800 flex items-center"
                >
                    <i class="fas fa-user-circle mr-3 text-pink-500"></i>
                    Foto de perfil
                </h3>
                <button
                    onclick="closeAvatarModal()"
                    class="text-gray-400 hover:text-gray-600 transition-colors"
                >
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Contenido del modal -->
        <div class="p-6">
            <!-- Preview del avatar actual -->
            <div class="text-center mb-6">
                <div
                    class="w-32 h-32 rounded-full mx-auto mb-4 overflow-hidden bg-gradient-to-r from-pink-100 to-purple-100 flex items-center justify-center shadow-lg"
                >
                    {% if usuario.avatar_url %}
                    <img
                        src="{{ usuario.avatar_url }}"
                        alt="Avatar actual"
                        class="w-full h-full object-cover"
                        id="currentAvatarPreview"
                    />
                    {% endif %}
                    <span
                        class="text-gray-500 text-2xl {{ 'hidden' if usuario.avatar_url else '' }}"
                        id="currentAvatarInitials"
                    >
                        {{ usuario.nombre[0]|upper }}{{
                        usuario.apellido[0]|upper }}
                    </span>
                </div>
                <p class="text-sm text-gray-600">
                    {{ "Foto actual" if usuario.avatar_url else "Sin foto de
                    perfil" }}
                </p>
            </div>

            <!-- Formulario de subida -->
            <form
                id="avatarUploadForm"
                enctype="multipart/form-data"
                class="space-y-4"
            >
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Seleccionar nueva imagen
                    </label>
                    <div class="relative">
                        <input
                            type="file"
                            id="avatarInput"
                            name="avatar"
                            accept="image/*"
                            class="hidden"
                            onchange="previewAvatar(this)"
                        />
                        <button
                            type="button"
                            onclick="document.getElementById('avatarInput').click()"
                            class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-pink-400 transition-colors duration-300 flex flex-col items-center justify-center space-y-2"
                        >
                            <i
                                class="fas fa-cloud-upload-alt text-2xl text-gray-400"
                            ></i>
                            <span class="text-sm text-gray-600"
                                >Hacer clic para seleccionar</span
                            >
                            <span class="text-xs text-gray-500"
                                >PNG, JPG, GIF (máx. 5MB)</span
                            >
                        </button>
                    </div>
                </div>

                <!-- Preview de la nueva imagen -->
                <div id="newAvatarPreview" class="hidden text-center">
                    <div
                        class="w-24 h-24 rounded-full mx-auto mb-3 overflow-hidden shadow-lg"
                    >
                        <img
                            id="previewImage"
                            class="w-full h-full object-cover"
                        />
                    </div>
                    <p class="text-sm text-gray-600">Vista previa</p>
                </div>

                <!-- Mensajes de estado -->
                <div
                    id="avatarUploadMessage"
                    class="hidden p-3 rounded-lg"
                ></div>

                <!-- Botones de acción -->
                <div class="flex space-x-3 pt-4">
                    {% if usuario.avatar_url %}
                    <button
                        type="button"
                        onclick="deleteAvatar()"
                        class="flex-1 px-4 py-3 bg-red-100 text-red-700 rounded-xl hover:bg-red-200 transition-colors duration-300 flex items-center justify-center space-x-2"
                    >
                        <i class="fas fa-trash text-sm"></i>
                        <span>Eliminar</span>
                    </button>
                    {% endif %}
                    <button
                        type="submit"
                        id="uploadAvatarBtn"
                        class="flex-1 px-4 py-3 bg-gradient-to-r from-pink-500 to-fuchsia-500 text-white rounded-xl hover:from-pink-600 hover:to-fuchsia-600 transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <i class="fas fa-upload text-sm"></i>
                        <span>Subir foto</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Variables globales para gestión de avatar
    let selectedFile = null;

    function openAvatarModal() {
        document.getElementById("avatarModal").classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }

    function closeAvatarModal() {
        document.getElementById("avatarModal").classList.add("hidden");
        document.body.style.overflow = "auto";

        // Limpiar formulario
        document.getElementById("avatarUploadForm").reset();
        document.getElementById("newAvatarPreview").classList.add("hidden");
        document.getElementById("uploadAvatarBtn").disabled = true;
        hideAvatarMessage();
        selectedFile = null;
    }

    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // Validar tipo de archivo
            const allowedTypes = [
                "image/png",
                "image/jpeg",
                "image/jpg",
                "image/gif",
                "image/webp",
            ];
            if (!allowedTypes.includes(file.type)) {
                showAvatarMessage(
                    "Tipo de archivo no permitido. Use PNG, JPG, JPEG, GIF o WEBP",
                    "error",
                );
                return;
            }

            // Validar tamaño (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAvatarMessage(
                    "El archivo es demasiado grande. Máximo 5MB",
                    "error",
                );
                return;
            }

            selectedFile = file;

            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("previewImage").src = e.target.result;
                document
                    .getElementById("newAvatarPreview")
                    .classList.remove("hidden");
                document.getElementById("uploadAvatarBtn").disabled = false;
                hideAvatarMessage();
            };
            reader.readAsDataURL(file);
        }
    }

    function showAvatarMessage(message, type = "success") {
        const messageDiv = document.getElementById("avatarUploadMessage");
        messageDiv.textContent = message;
        messageDiv.classList.remove(
            "hidden",
            "bg-green-100",
            "text-green-700",
            "bg-red-100",
            "text-red-700",
            "bg-blue-100",
            "text-blue-700",
        );

        if (type === "success") {
            messageDiv.classList.add("bg-green-100", "text-green-700");
        } else if (type === "error") {
            messageDiv.classList.add("bg-red-100", "text-red-700");
        } else {
            messageDiv.classList.add("bg-blue-100", "text-blue-700");
        }
    }

    function hideAvatarMessage() {
        document.getElementById("avatarUploadMessage").classList.add("hidden");
    }

    // Manejar subida de avatar
    document
        .getElementById("avatarUploadForm")
        .addEventListener("submit", async function (e) {
            e.preventDefault();

            if (!selectedFile) {
                showAvatarMessage("Por favor selecciona una imagen", "error");
                return;
            }

            const uploadBtn = document.getElementById("uploadAvatarBtn");
            const originalText = uploadBtn.innerHTML;

            uploadBtn.disabled = true;
            uploadBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> <span>Subiendo...</span>';

            const formData = new FormData();
            formData.append("avatar", selectedFile);

            try {
                const token = getCookie("token");
                const response = await fetch("/auth/upload_avatar", {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                    body: formData,
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAvatarMessage(data.message, "success");

                    // Actualizar avatares en la página
                    updateAvatarDisplay(data.avatar_url);

                    // Disparar evento para actualizar avatares en navbar
                    window.dispatchEvent(
                        new CustomEvent("avatarUpdated", {
                            detail: { avatarUrl: data.avatar_url },
                        }),
                    );

                    setTimeout(() => {
                        closeAvatarModal();
                    }, 1500);
                } else {
                    showAvatarMessage(
                        data.error || "Error al subir la imagen",
                        "error",
                    );
                }
            } catch (error) {
                console.error("Error:", error);
                showAvatarMessage(
                    "Error de conexión. Intente nuevamente",
                    "error",
                );
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
            }
        });

    // Eliminar avatar
    async function deleteAvatar() {
        if (
            !confirm("¿Estás seguro de que deseas eliminar tu foto de perfil?")
        ) {
            return;
        }

        try {
            const token = getCookie("token");
            const response = await fetch("/auth/delete_avatar", {
                method: "DELETE",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                },
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showAvatarMessage(data.message, "success");

                // Actualizar avatares en la página (volver a mostrar iniciales)
                updateAvatarDisplay(null);

                // Disparar evento para actualizar avatares en navbar
                window.dispatchEvent(
                    new CustomEvent("avatarUpdated", {
                        detail: { avatarUrl: null },
                    }),
                );

                setTimeout(() => {
                    closeAvatarModal();
                }, 1500);
            } else {
                showAvatarMessage(
                    data.error || "Error al eliminar la imagen",
                    "error",
                );
            }
        } catch (error) {
            console.error("Error:", error);
            showAvatarMessage("Error de conexión. Intente nuevamente", "error");
        }
    }

    function updateAvatarDisplay(avatarUrl) {
        const avatarImage = document.getElementById("avatarImage");
        const avatarInitials = document.getElementById("avatarInitials");
        const currentPreview = document.getElementById("currentAvatarPreview");
        const currentInitials = document.getElementById(
            "currentAvatarInitials",
        );

        if (avatarUrl) {
            // Mostrar imagen
            if (avatarImage) {
                avatarImage.src = avatarUrl;
                avatarImage.classList.remove("hidden");
            } else {
                // Crear elemento img si no existe
                const newImg = document.createElement("img");
                newImg.src = avatarUrl;
                newImg.alt = "Avatar";
                newImg.className = "w-full h-full object-cover";
                newImg.id = "avatarImage";
                avatarInitials.parentNode.appendChild(newImg);
            }

            avatarInitials.classList.add("hidden");

            // Actualizar preview en modal
            if (currentPreview) {
                currentPreview.src = avatarUrl;
                currentPreview.classList.remove("hidden");
            }
            if (currentInitials) {
                currentInitials.classList.add("hidden");
            }
        } else {
            // Mostrar iniciales
            if (avatarImage) {
                avatarImage.classList.add("hidden");
            }
            avatarInitials.classList.remove("hidden");

            // Actualizar preview en modal
            if (currentPreview) {
                currentPreview.classList.add("hidden");
            }
            if (currentInitials) {
                currentInitials.classList.remove("hidden");
            }
        }
    }

    // Función auxiliar para obtener cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(
                        cookie.substring(name.length + 1),
                    );
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}
