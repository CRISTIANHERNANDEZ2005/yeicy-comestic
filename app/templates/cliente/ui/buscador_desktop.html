<!-- Buscador Desktop - Dropdown Elegante -->
<div class="relative w-full">
    <form role="search" id="searchFormDesktop" autocomplete="off" class="relative">
        <input type="text" id="searchInputDesktop" class="w-full pl-4 pr-12 py-2.5 rounded-full border border-pink-200 shadow-sm focus:border-pink-400 focus:ring-2 focus:ring-pink-200 outline-none transition-all text-gray-700 placeholder-pink-300 bg-white" placeholder="¿Qué estás buscando hoy?" aria-label="Buscar"/>
        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-pink-400 hover:text-pink-600 focus:outline-none" aria-label="Buscar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewbox="0 0 24 24">
                <circle cx="11" cy="11" r="7"/>
                <path d="M21 21l-3.5-3.5"/>
            </svg>
        </button>
    </form>

    <!-- Dropdown Desktop Elegante -->
    <div id="searchDropdownDesktop" class="search-dropdown-desktop hidden">
        <div class="search-content-desktop">
            <!-- Solo términos más buscados (se muestra cuando no hay query) -->
            <div id="sugerenciasContainerDesktop" class="mb-4">
                <h4 class="text-sm font-semibold text-pink-600 mb-2">Términos más buscados</h4>
                <ol id="sugerenciasListDesktop" class="flex flex-col gap-1"></ol>
            </div>

            <!-- Solo resultados de búsqueda (se muestra cuando hay query) -->
            <div id="resultadosContainerDesktop" class="hidden">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Resultados de búsqueda</h4>
                <div id="resultadosListDesktop" class="grid grid-cols-2 gap-3"></div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos específicos para Desktop */
    .search-dropdown-desktop {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        right: 0;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border: 1px solid #fce7f3;
        z-index: 99999;
        max-height: 70vh;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
    }

    .search-dropdown-desktop.show {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    .search-content-desktop {
        padding: 1rem;
        max-height: 70vh;
        overflow-y: auto;
    }

    /* Scrollbar personalizado para desktop */
    .search-content-desktop::-webkit-scrollbar {
        width: 6px;
    }

    .search-content-desktop::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .search-content-desktop::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .search-content-desktop::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Animación para transición entre sugerencias y resultados */
    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .sugerencia-item-desktop {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 0.375rem;
        background: #fdf2f8;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .sugerencia-item-desktop:hover {
        background: #fbcfe8;
        transform: scale(1.02);
    }
    .sugerencia-numero-desktop {
        display: inline-block;
        min-width: 1.5em;
        text-align: center;
        font-weight: bold;
        color: #ec4899;
        background: #fce7f3;
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.125rem 0.25rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Elementos del DOM para Desktop
        const searchInputDesktop = document.getElementById('searchInputDesktop');
        const searchDropdownDesktop = document.getElementById('searchDropdownDesktop');
        const sugerenciasListDesktop = document.getElementById('sugerenciasListDesktop');
        const resultadosListDesktop = document.getElementById('resultadosListDesktop');
        const sugerenciasContainerDesktop = document.getElementById('sugerenciasContainerDesktop');
        const resultadosContainerDesktop = document.getElementById('resultadosContainerDesktop');
        
        let searchTimeoutDesktop;
        let isDropdownOpenDesktop = false;
        let hasQuery = false;

        // Función para mostrar dropdown en desktop
        function mostrarDropdownDesktop() {
            if (isDropdownOpenDesktop) return;
            
            // console.log('Mostrando dropdown Desktop');
            isDropdownOpenDesktop = true;
            searchDropdownDesktop.classList.remove('hidden');
            
            // Forzar reflow antes de mostrar
            searchDropdownDesktop.offsetHeight;
            searchDropdownDesktop.classList.add('show');
            
            // Solo cargar sugerencias si no hay query
            if (!hasQuery) {
                cargarSugerenciasDesktop();
            }
        }

        // Función para ocultar dropdown en desktop
        function ocultarDropdownDesktop() {
            if (!isDropdownOpenDesktop) return;
            
            // console.log('Ocultando dropdown Desktop');
            isDropdownOpenDesktop = false;
            searchDropdownDesktop.classList.remove('show');
            
            setTimeout(() => {
                if (!isDropdownOpenDesktop) {
                    searchDropdownDesktop.classList.add('hidden');
                }
            }, 300);
        }

        // Función para cambiar entre sugerencias y resultados
        function cambiarAModoResultados() {
            sugerenciasContainerDesktop.classList.add('hidden');
            resultadosContainerDesktop.classList.remove('hidden');
            resultadosContainerDesktop.classList.add('fade-in');
        }

        function cambiarAModoSugerencias() {
            resultadosContainerDesktop.classList.add('hidden');
            sugerenciasContainerDesktop.classList.remove('hidden');
            sugerenciasContainerDesktop.classList.add('fade-in');
        }

        // Función para cambiar entre sugerencias y resultados
        function cambiarAModoResultados() {
            sugerenciasContainerDesktop.classList.add('hidden');
            resultadosContainerDesktop.classList.remove('hidden');
            resultadosContainerDesktop.classList.add('fade-in');
        }

        function cambiarAModoSugerencias() {
            resultadosContainerDesktop.classList.add('hidden');
            sugerenciasContainerDesktop.classList.remove('hidden');
            sugerenciasContainerDesktop.classList.add('fade-in');
        }

        // Event listeners para desktop
        searchInputDesktop.addEventListener('focus', function () {
            // console.log('Focus en input Desktop');
            mostrarDropdownDesktop();
        });

        // Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
            const isClickInside = e.target.closest('#searchFormDesktop') || e.target.closest('#searchDropdownDesktop');
            if (!isClickInside && isDropdownOpenDesktop) {
                // console.log('Click fuera del buscador Desktop');
                ocultarDropdownDesktop();
            }
        });

        // Cerrar con tecla Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isDropdownOpenDesktop) {
                // console.log('Tecla Escape presionada Desktop');
                e.preventDefault();
                ocultarDropdownDesktop();
                searchInputDesktop.blur();
            }
        });

        // Búsqueda instantánea para desktop
        searchInputDesktop.addEventListener('input', (e) => {
            clearTimeout(searchTimeoutDesktop);
            const query = e.target.value.trim();

            searchTimeoutDesktop = setTimeout(() => {
                if (query.length > 0) {
                    // console.log('Buscando productos Desktop para:', query);
                    hasQuery = true;
                    cambiarAModoResultados();
                    buscarProductosDesktop(query);
                } else {
                    // console.log('Input vacío Desktop - Mostrando sugerencias');
                    hasQuery = false;
                    cambiarAModoSugerencias();
                    cargarSugerenciasDesktop();
                }
            }, 300);
        });

        // Función para mostrar estado de carga en desktop
        function mostrarCargandoDesktop() {
            // console.log('Mostrando estado de carga Desktop...');
            resultadosListDesktop.innerHTML = `
                <div class="col-span-2 flex justify-center p-4">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-pink-500"></div>
                </div>
            `;
        }

        // Función para buscar productos en desktop
        async function buscarProductosDesktop(query) {
            // console.log('Iniciando búsqueda Desktop para:', query);
            if (query.length === 0) {
                // console.log('Query vacío Desktop - Cargando sugerencias');
                hasQuery = false;
                cambiarAModoSugerencias();
                cargarSugerenciasDesktop();
                return;
            }

            mostrarCargandoDesktop();

            try {
                // console.log('Realizando petición Desktop a /buscar?q=' + encodeURIComponent(query));
                const response = await fetch(`/buscar?q=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error('Error en la búsqueda Desktop');
                }

                const data = await response.json();
                // console.log('Respuesta recibida Desktop:', data);

                if (data.error) {
                    console.error('Error en la respuesta Desktop:', data.error);
                    resultadosListDesktop.innerHTML = `<p class="text-red-500 col-span-2">${data.error}</p>`;
                    return;
                }

                // console.log('Mostrando resultados Desktop:', data.resultados.length, 'productos encontrados');
                mostrarResultadosDesktop(data.resultados);
            } catch (error) {
                console.error('Error en la búsqueda Desktop:', error);
                resultadosListDesktop.innerHTML = '<p class="text-red-500 col-span-2">Error al buscar productos</p>';
            }
        }

        // Mostrar resultados en desktop
        function mostrarResultadosDesktop(productos) {
            // console.log('Renderizando resultados Desktop:', productos.length, 'productos');
            resultadosListDesktop.innerHTML = '';

            if (productos.length === 0) {
                // console.log('No se encontraron productos Desktop');
                resultadosListDesktop.innerHTML = '<p class="text-gray-500 col-span-2">No se encontraron productos</p>';
                return;
            }

            productos.forEach(producto => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-3 hover:bg-pink-50 rounded-lg cursor-pointer transition-all duration-200 hover:scale-105';

                const hasImage = producto.imagen_url && producto.imagen_url.trim() !== '' && !producto.imagen_url.includes('default');
                
                const placeholderSvg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZDhkYWRiIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPHBhdGggZD0iTTMuMTYgMTguODhMMTUuMTIgNi45M2EuMTYuMTYgMCAwIDEgLjIyIDBsMy4wNiAzLjA2YS4xNi4xNiAwIDAgMSAwIC4yMkw2LjQ0IDIyYTEgMSAwIDAgMS0xLjM5LjA2bC02LjE1LTUuNzlhMS4yNSAxLjI1IDAgMCAxIC4yNi0xLjM5eiIvPgo8cGF0aCBkPSJNMTkgMTlhMiAyIDAgMSAwIDAtNCAyIDIgMCAwIDAgMCA0eiIvPgo8cGF0aCBkPSJNMjIgMTB2OGEyIDIgMCAwIDEtMiAyaC0xM2wtMy4yLTIuN2ExIDEgMCAwIDAtMS42LjRsLTMuMzUgNCIvPgo8cGF0aCBkPSJNMiAxMHYtNGEyIDIgMCAwIDEgMi0yaDZhMSAxIDAgMCAwIC44LS40bDIuNi0zLjQ1YTEgMSAwIDAgMSAuOC0uMzVIMThhMiAyIDAgMCAxIDIgMlYxMCIvPgo8L3N2Zz4=';
                
                div.innerHTML = `
                    ${
                        hasImage
                            ? `<img src="${producto.imagen_url}" alt="${producto.nombre}" 
                                 class="w-16 h-16 object-cover rounded-lg shadow-sm"
                                 onerror="this.onerror=null; this.src='${placeholderSvg}'; this.classList.add('p-2', 'opacity-50')">`
                            : `<div class="w-16 h-16 bg-gray-50 rounded-lg shadow-sm flex items-center justify-center">
                                 <svg class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                 </svg>
                               </div>`
                    }
                    <div class="flex-1">
                        <p class="font-medium text-sm text-gray-800">${producto.nombre}</p>
                        <p class="text-pink-600 font-bold text-lg">$${producto.precio.toLocaleString()}</p>
                    </div>
                `;
                div.addEventListener('click', async () => {
                    // console.log('Producto clickeado Desktop:', producto.id, producto.nombre);
                    await logSearchClick(producto, searchInputDesktop.value.trim());
                    window.location.href = `/${producto.categoria_principal_slug}/${producto.subcategoria_slug}/${producto.seudocategoria_slug}/${producto.slug}`;
                });
                resultadosListDesktop.appendChild(div);
            });
        }

        function logSearchClick(producto, query) {
            const data = {
                product_id: producto.id,
                query: query
            };
            return fetch('/log_search_click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
                keepalive: true
            });
        }

        // Mostrar sugerencias en desktop
        function mostrarSugerenciasDesktop(terminos) {
            // console.log('Mostrando sugerencias Desktop:', terminos.length, 'términos');
            sugerenciasListDesktop.innerHTML = '';
            terminos.forEach((termino, idx) => {
                const li = document.createElement('li');
                li.className = 'sugerencia-item-desktop';
                li.innerHTML = `<span class="sugerencia-numero-desktop">${idx + 1}</span> <span>${termino}</span>`;
                li.addEventListener('click', () => {
                    // console.log('Sugerencia seleccionada Desktop:', termino);
                    searchInputDesktop.value = termino;
                    hasQuery = true;
                    cambiarAModoResultados();
                    buscarProductosDesktop(termino);
                });
                sugerenciasListDesktop.appendChild(li);
            });
        }

        // Cargar sugerencias iniciales para desktop
        async function cargarSugerenciasDesktop() {
            // console.log('Cargando sugerencias iniciales Desktop...');
            try {
                const response = await fetch('/buscar?q=');
                const data = await response.json();
                // console.log('Sugerencias recibidas Desktop:', data.sugerencias);
                mostrarSugerenciasDesktop(data.sugerencias);
            } catch (error) {
                console.error('Error al cargar sugerencias Desktop:', error);
            }
        }

        // Prevenir envío del formulario en desktop
        document.getElementById('searchFormDesktop').addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchInputDesktop.value.trim();
            if (query.length > 0) {
                hasQuery = true;
                cambiarAModoResultados();
                buscarProductosDesktop(query);
            }
        });
    });
</script> 