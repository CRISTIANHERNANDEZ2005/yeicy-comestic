<div class="w-full bg-fuchsia-600 shadow-lg min-h-[56px] md:min-h-[64px] transition-all duration-300 relative">
  <!-- Contenedor flexible que centrará las categorías -->
  <div class="flex justify-center items-center w-full h-full overflow-hidden px-2">
    <!-- Contenedor interno con categorías -->
    <ul class="flex flex-row items-center justify-center gap-2 md:gap-4 px-2 py-2 w-full max-w-screen-xl mx-auto"
      id="categories-container" aria-label="Categorías principales">
      {% for categoria in categorias %}
      <li class="flex-shrink-0 hidden category-item" data-category-id="{{ categoria.id }}">
        <button class="category-trigger block px-4 py-2 md:px-6 md:py-2 rounded-full font-bold text-white bg-white/10 hover:bg-white/30 hover:text-yellow-300 shadow-md border border-white/20 transition-all duration-200 text-sm sm:text-base md:text-lg tracking-wide focus:outline-none focus:ring-2 focus:ring-yellow-300 focus:ring-offset-2 focus:ring-offset-fuchsia-600 whitespace-nowrap"
          data-category-id="{{ categoria.id }}" tabindex="0">
          {{ categoria.nombre }}
        </button>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Modal de categorías - Mega menú con diseño estructurado -->
  <div id="megaMenu" class="mega-menu absolute top-full left-0 right-0 bg-white shadow-lg border-t border-gray-200 hidden" style="z-index: 9999;">
    <div class="max-w-screen-xl mx-auto px-4">
      <div class="mega-menu-content p-4">
        <!-- Contenido dinámico se cargará aquí -->
      </div>
    </div>
  </div>
</div>

<style>
/* Estilos para el mega menú - Versión estructurada */
.mega-menu {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  border-top: 1px solid #e5e7eb;
}

/* Overlay para fondo oscuro */
.mega-menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.mega-menu-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* Grid responsivo mejorado */
.mega-menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

/* Estructura de secciones */
.category-section {
  padding: 0.5rem 0;
}

.category-section h3 {
  color: #111827;
  font-weight: 600;
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e5e7eb;
}

/* Lista de subcategorías */
.subcategory-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.subcategory-item {
  margin-bottom: 0.25rem;
}

.subcategory-link {
  color: #374151;
  text-decoration: none;
  font-size: 0.95rem;
  font-weight: 500;
  transition: color 0.2s ease;
  display: block;
  padding: 0.35rem 0;
}

.subcategory-link:hover {
  color: #7c3aed;
}

/* Contador de items */
.category-count {
  display: inline-block;
  background-color: #e5e7eb;
  color: #4b5563;
  font-size: 0.7rem;
  padding: 0.1rem 0.4rem;
  border-radius: 9999px;
  margin-left: 0.3rem;
}

/* Responsive */
@media (max-width: 768px) {
  .mega-menu {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    max-height: 100vh;
    overflow-y: auto;
  }
  
  .mega-menu-content {
    padding: 1rem;
  }
  
  .mega-menu-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<!-- Overlay para fondo oscuro -->
<div class="mega-menu-overlay" id="megaMenuOverlay"></div>

<!-- Script optimizado (mantenido igual) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const container = document.getElementById('categories-container');
  const categoryItems = container.querySelectorAll('.category-item');
  const megaMenu = document.getElementById('megaMenu');
  const megaMenuContent = megaMenu.querySelector('.mega-menu-content');
  const megaMenuOverlay = document.getElementById('megaMenuOverlay');
  
  let currentCategory = null;
  let closeTimeout = null;
  let isMouseOverMenu = false;
  let isMenuOpen = false;

  // Datos de categorías
  const categoriesData = {
    {% for categoria in categorias %}
    {{ categoria.id }}: {
      nombre: "{{ categoria.nombre }}",
      subcategorias: [
        {% for sub in categoria.subcategorias %}
        {
          id: {{ sub.id }},
          nombre: "{{ sub.nombre }}",
          seudocategorias: [
            {% for seudo in sub.seudocategorias %}
            {
              id: {{ seudo.id }},
              nombre: "{{ seudo.nombre }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  // Funciones de breakpoint y categorías visibles
  const breakpoints = {
    mobile: { min: 3, max: 4 },
    tablet: { min: 4, max: 6 },
    desktop: { min: 5, max: 8 }
  };

  function getCurrentBreakpoint() {
    if (window.innerWidth < 640) return 'mobile';
    if (window.innerWidth < 768) return 'tablet';
    return 'desktop';
  }

  function calculateVisibleCategories() {
    const breakpoint = getCurrentBreakpoint();
    const { min, max } = breakpoints[breakpoint];
    const containerWidth = container.clientWidth;
    let totalWidth = 0;
    let visibleCount = 0;

    categoryItems.forEach(item => {
      item.style.display = 'none';
    });

    for (let i = 0; i < Math.min(categoryItems.length, max); i++) {
      const item = categoryItems[i];
      item.style.display = 'block';
      const itemWidth = item.offsetWidth + (i > 0 ? 8 : 0);

      if (totalWidth + itemWidth <= containerWidth) {
        totalWidth += itemWidth;
        visibleCount++;
      } else {
        item.style.display = 'none';
        break;
      }
    }

    if (visibleCount < min && categoryItems.length >= min) {
      for (let i = visibleCount; i < min; i++) {
        if (categoryItems[i]) {
          categoryItems[i].style.display = 'block';
        }
      }
    }
  }

  // Función para construir contenido del menú
  function buildMegaMenuContent(categoryId) {
    const category = categoriesData[categoryId];
    if (!category) return '<div class="text-center py-8">Cargando...</div>';

    let html = '<div class="mega-menu-grid">';
    
    category.subcategorias.forEach(sub => {
      const seudoCount = sub.seudocategorias.length;
      html += `
        <div class="category-section">
          <h3>
            ${sub.nombre}
            ${seudoCount > 0 ? `<span class="category-count">${seudoCount}</span>` : ''}
          </h3>
          <ul class="subcategory-list">
            ${sub.seudocategorias.map(seudo => `
              <li class="subcategory-item">
                <a href="/products?seudocategoria=${seudo.id}" class="subcategory-link">
                  ${seudo.nombre}
                </a>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    });
    
    html += '</div>';
    return html;
  }

  // Funciones para mostrar/ocultar
  function showMegaMenu(categoryId) {
    clearTimeout(closeTimeout);
    
    if (currentCategory === categoryId && isMenuOpen) {
      return;
    }

    currentCategory = categoryId;
    megaMenuContent.innerHTML = buildMegaMenuContent(categoryId);
    
    if (window.innerWidth <= 768) {
      megaMenuOverlay.classList.add('active');
    }
    
    megaMenu.classList.remove('hidden');
    isMenuOpen = true;
  }

  function hideMegaMenu() {
    closeTimeout = setTimeout(() => {
      if (!isMouseOverMenu && isMenuOpen) {
        megaMenuOverlay.classList.remove('active');
        megaMenu.classList.add('hidden');
        currentCategory = null;
        isMenuOpen = false;
      }
    }, 150);
  }

  // Event listeners
  categoryItems.forEach(item => {
    const trigger = item.querySelector('.category-trigger');
    
    trigger.addEventListener('mouseenter', () => {
      if (window.innerWidth > 768) {
        const categoryId = parseInt(item.dataset.categoryId);
        showMegaMenu(categoryId);
      }
    });
    
    trigger.addEventListener('mouseleave', () => {
      if (window.innerWidth > 768) {
        hideMegaMenu();
      }
    });
    
    trigger.addEventListener('click', (e) => {
      if (window.innerWidth <= 768) {
        e.preventDefault();
        const categoryId = parseInt(item.dataset.categoryId);
        if (currentCategory === categoryId && isMenuOpen) {
          hideMegaMenu();
        } else {
          showMegaMenu(categoryId);
        }
      }
    });
  });

  megaMenu.addEventListener('mouseenter', () => {
    isMouseOverMenu = true;
    clearTimeout(closeTimeout);
  });

  megaMenu.addEventListener('mouseleave', () => {
    isMouseOverMenu = false;
    hideMegaMenu();
  });

  megaMenuOverlay.addEventListener('click', () => {
    hideMegaMenu();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isMenuOpen) {
      hideMegaMenu();
    }
  });

  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      calculateVisibleCategories();
      if (isMenuOpen && window.innerWidth <= 768) {
        megaMenuOverlay.classList.add('active');
      } else {
        megaMenuOverlay.classList.remove('active');
      }
    }, 100);
  });

  new ResizeObserver(calculateVisibleCategories).observe(container);
  setTimeout(calculateVisibleCategories, 50);
});
</script>